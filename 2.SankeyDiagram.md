# Medication patterns

This script contains the step by step of the identification of patterns of the two FDA-approved medication and SSRIs. We used reimbursement claims data from individuals that have a prescription of those medications. The file used here is already cleaned and pre-processed.

To verify that the patients we are going to include later do not have a prescription for the two FDA-approved medications or SSRIs. For that, we used the entire claims data with all the years (2006 - 2022), and extract the patient ID, the medication prescribed and the year of the prescription.





    library(dplyr)
    library(plotly)
    library(tidyr)
    library(stringr)
    library(stringi) #for the str_sub
    library(RColorBrewer)
    library(data.table)
    library(networkD3)
    library(htmlwidgets)
    library(purrr)
    library(tidycensus)

    ## To create html Tables 
    library(htmlTable)
    library(magrittr)

To verify that the patients we are going to include later do not have a
prescription for the two FDA-approved medications or SSRIs. For that, we
used the entire claims data with all the years (2006 - 2022), and
extract the patient ID, the medication prescribed and the year of the
prescription.

    #To verify that patients from 2012 to 2021 have never had a prescription of aripiprazole and/or risperidone before 2012.


    patients_beforeObsPeriod<-fread("Y:/Paula/Files_finish/claims_ASD_withDrugNamesAndNDC.csv") %>% 
      mutate(year = as.numeric(substr(month_id, 1,4))) %>% 
      select(pat_id, year, generic_name) %>% 
      unique


    gc() #Free unused memory

Then, we identify the patients with at least one prescription of
aripiprazole, risperidone or medications part of the SSRIs.

    claims_ASD_wNDC_csv_onlyPrescripClass<-fread("Y:/Paula/Files_finish/NewFiles/07-01-24_OnlyPharmacotherapy_0to26_allFilters_2Diag_R419.csv")

    gc() #Free Unused memory

    SSRIs_genericNames <- claims_ASD_wNDC_csv_onlyPrescripClass %>%
      select(generic_name, Drug_class) %>% 
      unique %>% 
      filter(Drug_class == "Selective serotonin reuptake inhibitors") %>% 
      select(generic_name) %>% 
      unlist

    patients_beforeObsPeriod <- patients_beforeObsPeriod %>%
      filter(year < 2012 & 
               generic_name %in% c("ARIPIPRAZOLE", 
                                   "RISPERIDONE", 
                                   "RISPERIDONE MICROSPHERES", 
                                   SSRIs_genericNames)) 


    patients_beforeObsPeriod <- patients_beforeObsPeriod %>% 
      select(pat_id) %>% 
      unique

    gc()

For calculations.

    demographicASD<-read.csv("Y:/enrll_synth.csv")

    #"R419"

    ASD_diagnoses_code <- c("F84","F840","F843","F845","F849","F848", 
                            "2990","29900","29901","2998","29980","29981","2999",
                            "29990","29991","299","2991","29910","29911")

    #Load the entire claims to extract the age of the second diagnosis
    claims_diagnosis <-  fread("Y:/Paula/Files_finish/claims_ASD_withDrugNamesAndNDC.csv") %>% 
       select(pat_id, from_dt, starts_with("diag")) %>%
      filter(.$pat_id %in% unlist(unique(claims_ASD_wNDC_csv_onlyPrescripClass$pat_id)) & 
               .$diagprc_ind != -1) %>% 
      select(-diagprc_ind) %>%
      pivot_longer(
        cols = -c(pat_id,from_dt), 
        names_to = "diagn_code",
        values_to = "dx_cd"
      ) %>% 
      select(-diagn_code) %>%
      distinct() %>% 
      filter(.$dx_cd != "") %>% 
      #Filter the ICD related to ASD
      filter(dx_cd %in% ASD_diagnoses_code) %>% 
      arrange(from_dt, pat_id) %>% 
      distinct() %>% 
      left_join(select(demographicASD, pat_id, der_yob), by = "pat_id")

    gc()          

## Verifying usage of just the two drug classes

It is necessary to identify the patients using just the two drug classes
selected, to then determine the individual-level shifts.

First, it is necessary to identify which of the patients receiving
pharmacotherapy were using just the two drug classes.

    #Study period 
    years = 2012:2021

    #With only the drug classes 
    drug_classes <- c("Atypical antipsychotics","Selective serotonin reuptake inhibitors")

    DrugClassByYearAndPatient <- claims_ASD_wNDC_csv_onlyPrescripClass %>% 
      mutate(year_claim = as.numeric(substr(month_id, 1,4))) %>% 
      select(year_claim, pat_id, Drug_class) %>% 
      unique %>% 
      group_by(pat_id, year_claim) %>% 
      filter(all(Drug_class %in% drug_classes)) %>% 
      ungroup() %>% 
      arrange(year_claim, pat_id)

Then, select the patient IDs and the year were each of the patients just
used the two drug classes. After that, extract the claims for those
patients from the pharmacotherapy dataset.

    pat_id_ThreeDrugClass <- unlist(unique(DrugClassByYearAndPatient$pat_id))
    year_threeDrugClasses <- unlist(unique(DrugClassByYearAndPatient$year_claim))

    claims_ASD_wNDC_csv_onlyPrescripClass_RL<-claims_ASD_wNDC_csv_onlyPrescripClass %>%
      mutate(year_claim = as.numeric(substr(month_id, 1,4))) %>% 
      group_by(year_claim, pat_id) %>%
              filter(pat_id %in% pat_id_ThreeDrugClass & 
                       year_claim %in% year_threeDrugClasses) %>%
      ungroup() %>% 
      mutate(year = substr(month_id,1,4))

    drug_classes <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
      filter(Drug_class %in% drug_classes) %>% 
      select(medication, Drug_class) %>% 
      unique 

    gc()

Although other drug classes were extracted too, those are going to be
useful when identifying individual-level shifts.

## Sankey diagram construction aggregating by drug classes

### Yearly

The following script contains the construction of the sankey diagram and
the aggregation by drug classes. This script contains several parts and
filters.

First, identify the names of the medications for the first filter, where
the patients with a single medication used year by year has to be any of
the medications previously selected (SSRIs and two FDA approved
medications).,

    SSRIs_meds <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
      select(medication, Drug_class) %>% 
      unique %>% 
      filter(Drug_class == "Selective serotonin reuptake inhibitors") %>% 
      select(medication) %>% 
      unlist

    meds_to_study <- c("ARIPIPRAZOLE", "RISPERIDONE",SSRIs_meds)
    inter_meds <- c("ARIPIPRAZOLE", "RISPERIDONE", SSRIs_meds)

    #The meds joined 
    meds_to_study_joined <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
      select(medication) %>% 
      unique %>% 
      unlist

The following `for statenment` has several filters. First, we identify
the patients with one medication usage per year, verify if those
patients did not have a prescription of the selected medications before
2012 and that the medications used are part of the SSRIs or the two
FDA-approved medications.

Because we are including newly prescribed users per year, we have to
verify if the list of patients ID per year identified are indeed new
users. We check if the patients did not have a prescription of the
selected medications the year before.

The patients including are then follow over time, and, if they pass all
the filters, are including each year.

Finally, we aggregate by drug class, changing the name of the medication
by its drug class. The patients that shifted to a medication different
from the selected medications, are included too, and the medication is
changed by a new classification called “Other”.

    start.time <- Sys.time()
    patients_id_allYears<-c()

    years<-2012:2021

    patients_source<- c()
    cont <- 1

    for(j in 1:length(years)){
      #Declare initial vectors
      if(years[j] < max(years)){
       
        medication_source_c<- c()
        medication_target_c<-c()
        
        # patients_id <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
        #   filter(year == years[j]) %>% 
        #   select(pat_id, medication) %>% 
        #   unique %>%
        #   filter(!pat_id %in% patients_beforeObsPeriod) %>% 
        #   group_by(pat_id) %>% 
        #   count %>% 
        #   ungroup() %>% 
        #   filter(n == 1) %>% 
        #   select(pat_id) %>% 
        #   left_join(select(claims_ASD_wNDC_csv_onlyPrescripClass_RL, 
        #                pat_id, 
        #                medication)) %>%
        #   filter(medication %in% meds_to_study) %>% 
        #   select(pat_id) %>% 
        #   unlist 
        
      patients_id <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>%
          filter(year == years[j]) %>%
          select(pat_id, medication) %>%
          unique %>%
          filter(!pat_id %in% patients_beforeObsPeriod$pat_id) %>%
          group_by(pat_id) %>%
          filter(all(medication %in% meds_to_study)) %>% 
          summarise(n = n_distinct(medication), .groups = 'drop') %>%
          filter(n == 1) %>%
          select(pat_id) %>%
          unlist
        
        assign(paste0("patientsList",cont),patients_id)

        
        if(years[j] > 2012){
          patAndMed_year <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
            filter(year == years[j-1]) %>% 
            select(pat_id, medication) %>%
            unique %>% 
            group_by(pat_id) %>% 
            filter(any(medication %in% meds_to_study)) %>% 
            ungroup() %>% 
            group_by(pat_id) %>% 
            count %>% 
            ungroup() %>% 
            filter(n > 1)
          
          patients_id <- patients_id[! patients_id %in% patAndMed_year$pat_id]
          
          assign(paste0("patientsList",cont),patients_id)

        }
       
        patients_id_allYears <- unique(c(patients_id_allYears,patients_id))
        
        
          for(i in patients_id_allYears){
            #Go to each patient and see what of those only have one prescription 
            #or multiple prescription for the same drug medication (drug class)
            
            #In the source
            medication_source <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
              filter(year == years[j] & 
                       .$pat_id == i) %>% 
              select(medication) %>% unique
            
            
            #And in the target 
            medication_target <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
              filter(year == years[j+1] &  
                       .$pat_id == i) %>% 
              select(medication) %>% unique
            
            
            #Verify that the prescriptions only are from the same medication
            #And extract the medication
            if(nrow(medication_source) == 1 & nrow(medication_target) == 1 &
               (medication_source %in% meds_to_study_joined &
                medication_target %in% meds_to_study_joined)){
              
              patients_source<-c(patients_source,i)
              medication_source_c <-c(medication_source_c,medication_source)
              medication_target_c <-c(medication_target_c,medication_target)
            
            }
          }
          
        
        # and count it 
        drugs_patterns <- data.frame(drugSource = unlist(medication_source_c),
                                     drugTarget = unlist(medication_target_c)) %>%
          mutate(drugTarget = ifelse(drugTarget %in% inter_meds[1:2], 
                                     "Atypical antipsychotics",
                                     ifelse(drugTarget %in% inter_meds[2:length(inter_meds)],
                                            "Selective serotonin reuptake inhibitors", 
                                            "OTHER")), 
                 drugSource = ifelse(drugSource %in% inter_meds[1:2], 
                                     "Atypical antipsychotics",
                                     ifelse(drugSource %in% inter_meds[2:length(inter_meds)],
                                            "Selective serotonin reuptake inhibitors", 
                                            "OTHER"))) %>% 
          mutate(drugTarget = paste(drugTarget,years[j+1],sep="_")) %>%
          mutate(drugSource = paste(drugSource,years[j], sep="_")) %>%
          group_by(drugSource, drugTarget) %>%
          count %>% 
          mutate(medication = substr(drugSource, 1, nchar(drugSource)-5))
      
        
        assign(paste0("df_drugsYear",cont),drugs_patterns)
        cont = cont + 1
         
      }
     
    }
    #Obtain a list of each of the dataframes 
    df_names <- paste0("df_drugsYear",1:(cont-1))
    df_list <- mget(df_names, inherits =  FALSE)

    #For all the months
    all_patterns_years_df <- bind_rows(df_list)


    end.time <- Sys.time()

The time taken by the sankey diagram generation.

    end.time - start.time

    all_patterns_years_df<-fread("Y:/Paula/Files_finish/WithoutR491/SSRIs_RispArip_yearly_NewChanges.csv")

Now, the Sankey diagram construction.

    #For the others meds 
    other_meds.df <- data.frame("OTHER","Other")
    names(other_meds.df) <- c("medication","Drug_class")

    drug_classes <- rbind(drug_classes, 
                          other_meds.df)

    nodes_colors <- data.frame(Drug_class = sort(c("Selective serotonin reuptake inhibitors","Atypical antipsychotics","Other")))

    color_nodes <- c("#489b7b","#cb6527", "#DDAB3B")

    #The next functions is to add transparency (opacity) to the colors 
    add.alpha <- function(col, alpha = 1){
      if(missing(col)){
        stop("Provide a vector of colours.")
      }else{
        apply(sapply(col, col2rgb)/255, 2,
              function(x)
                rgb(x[1], x[2], x[3], alpha = alpha))
      }
    }

    color_nodes_alpha <- add.alpha(color_nodes, alpha = 0.4)
    nodes_colors <- cbind(nodes_colors, color = color_nodes, color_link = color_nodes_alpha)

    #Create the nodes
    nodes <- all_patterns_years_df %>%
      pivot_longer(1:2, values_to = "name_node") %>%
      distinct(name_node) %>% arrange(name_node) %>% 
      mutate(year = as.numeric(sub(".*_(\\d+)$", "\\1", name_node))) %>% 
      arrange(year) %>%
      mutate(name_node2 = substr(name_node, 1, nchar(name_node)-5)) %>% 
      mutate(medication = name_node2) %>% 
      mutate(name_node2 = gsub("(?<=\\b)([a-z])", 
                               "\\U\\1", 
                               tolower(name_node2), perl = TRUE)) %>% 
      arrange(year, medication) %>% 
      mutate(idx = (1:n()) - 1)

      links<- bind_rows(
        all_patterns_years_df %>% select(source = drugSource, target = drugTarget, value = n)) %>%
        mutate(year = as.numeric(sub(".*_(\\d+)$", "\\1", source))) %>% 
        arrange(year) %>% 
        dplyr::group_by(source, target) %>%
        mutate(source = nodes$idx[match(source, nodes$name_node)]) %>%
        mutate(target = nodes$idx[match(target, nodes$name_node)]) %>%
        ungroup()

      #Obtain the nodes that have a total less than 1 (dummy link)
    nodes_smallCount_source <- links %>% 
        group_by(source) %>% 
        summarise(total = sum(value)) %>% 
        filter(.$total < 1) %>%
        ungroup() %>% 
        select(source) %>% 
        unique
      
        nodes_smallCount_target <- links %>% 
        group_by(target) %>% 
        summarise(total = sum(value)) %>% 
        filter(.$total < 1) %>%
        ungroup() %>%
        select(target) %>% 
        unique
        
       nodes_smallCount <- nodes_smallCount_source %>% 
          filter(.$source %in% nodes_smallCount_target$target | 
                   .$source %in% c(3))
      

    #Create the group of the nodes for coloring 
    nodes <- nodes %>%
      mutate(color = "black") %>% 
    mutate(color = ifelse(idx %in% 
                            nodes_smallCount$source, 
                          "#00000000", color)) %>%
    mutate(medication = ifelse(color == "#00000000", paste0(medication,"_D"), medication), 
           name_node2 = ifelse(color == "#00000000", '', name_node2))


    drug_class <- nodes_colors$medication
    # linkColors <- sort(unique(links$color))

    nodes_drugClasses <- nodes %>% 
      select(idx, medication) %>% 
      unique 

    #This is to just leave the name of the nodes at the end
    nodes <- nodes %>% 
      mutate(name_node_final = ifelse(year < max(year) , '', name_node2))

    colnames(nodes_drugClasses)[1] = "source"

    links <- left_join(links, nodes_drugClasses, by = "source") %>% 
        arrange(year, medication) %>% 
        mutate(medication = ifelse(value == 1e-6 & 
                                     substr(medication, nchar(medication)-1, 
                                            nchar(medication)) != "_D", paste0(medication,"_D"), medication))
      
    colnames(links)[7] <- "medication"

    my_color <- paste("d3.scaleOrdinal().domain([",
                      paste0("'",paste(drug_class, 
                                       collapse = "','"),"'"),",",paste0("'",paste(paste0(drug_class,"_D"), 
                                                                                   collapse = "','"),"'"),
                      "]).range([",
                      paste0("'",paste(color_nodes,collapse="','"),"'"),",'#00000000', '#00000000', '#00000000'])")

    my_color <- "d3.scaleOrdinal().domain([ 'Atypical antipsychotics','Selective serotonin reuptake inhibitors', 'Other', 'Atypical antipsychotics_D', 'Selective serotonin reuptake inhibitors_D', 'Other_D']).range([ '#489b7b','#cb6527','#DDAB3B', '#00000000', '#00000000', '#00000000'])"


    nodes <- nodes %>% 
      mutate(name_node_final = ifelse(name_node_final == "Atypical Antipsychotics", "FDA-approved medications", 
                                      ifelse(name_node_final == "Selective Serotonin Reuptake Inhibitors", 
                                             "SSRIs", 
                                             name_node_final)))

    fig_overtime_drugClasses <- sankeyNetwork(Links=links, Nodes=nodes, Source='source',
                                                Target='target', 
                                                Value = 'value', 
                                                NodeID ='name_node_final',
                                                colourScale=my_color,
                                                fontSize= 45, nodeWidth = 25,
                                                nodePadding = 15,
                                                sinksRight = FALSE,
                                                LinkGroup =  "medication",
                                                NodeGroup = "medication", 
                                                iterations = 0, width = 3000, height = 900)

    fig_overtime_drugClasses
    end.time <- Sys.time()

### Monthly

    year_select <- 2019

    claims_dataset <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
       filter(.$year == year_select) #If is just one year
      #filter(.$year %in% year_select) #If is several years at once 


    months <- 201901:201912

    patients_id_allMonths <- c()

    #If two FDA approvd medications 

    meds_to_study <- c("ARIPIPRAZOLE", "RISPERIDONE",SSRIs_meds)
    inter_meds <- c("ARIPIPRAZOLE", "RISPERIDONE", SSRIs_meds)

    #The meds joined 
    meds_to_study_joined <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
      select(medication) %>% 
      unique %>% 
      unlist 

    start.time <- Sys.time()

    years<-2012:2021

    patients_source<- c()
    cont <- 1

    for(j in 1:length(months)){
      #Declare initial vectors
      if(months[j] < max(months)){
       
        medication_source_c<- c()
        medication_target_c<-c()
        
        #Extract only the patients that appears with a claim in the source
        #To reduce time consumption
        
        patients_id <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>%
          filter(month_id == months[j]) %>%
          select(pat_id, medication) %>%
          unique %>%
          filter(!pat_id %in% patients_beforeObsPeriod$pat_id) %>%
          group_by(pat_id) %>%
          filter(all(medication %in% meds_to_study)) %>% 
          summarise(n = n_distinct(medication), .groups = 'drop') %>%
          filter(n == 1) %>%
          select(pat_id) %>%
          unlist
        
        assign(paste0("patientsList",cont),patients_id)

        
        if(months[j] > min(months)){
          patAndMed_year <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
            filter(month_id == months[j-1]) %>% 
            select(pat_id, medication) %>%
            unique %>% 
            group_by(pat_id) %>% 
            filter(any(medication %in% meds_to_study)) %>% 
            ungroup() %>% 
            group_by(pat_id) %>% 
            count %>% 
            ungroup() %>% 
            filter(n > 1)
          
          patients_id <- patients_id[! patients_id %in% patAndMed_year$pat_id]
          
          assign(paste0("patientsList",cont),patients_id)

        }
       
        patients_id_allMonths <- unique(c(patients_id_allMonths,patients_id))
        
        
          for(i in patients_id_allMonths){
            #Go to each patient and see what of those only have one prescription 
            #or multiple prescription for the same drug medication (drug class)
            
            #In the source
            medication_source <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
              filter(month_id == months[j] & 
                       .$pat_id == i) %>% 
              select(medication) %>% unique
            
            
            #And in the target 
            medication_target <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
              filter(month_id == months[j+1] &  
                       .$pat_id == i) %>% 
              select(medication) %>% unique
            
            
            #Verify that the prescriptions only are from the same medication
            #And extract the medication
            if(nrow(medication_source) == 1 & nrow(medication_target) == 1 &
               (medication_source %in% meds_to_study_joined &
                medication_target %in% meds_to_study_joined)){
              
              patients_source<-c(patients_source,i)
              medication_source_c <-c(medication_source_c,medication_source)
              medication_target_c <-c(medication_target_c,medication_target)
            
            }
          }
          
        
        # and count it 
        drugs_patterns <- data.frame(drugSource = unlist(medication_source_c),
                                     drugTarget = unlist(medication_target_c)) %>%
          mutate(drugTarget = ifelse(drugTarget %in% inter_meds[1:2], 
                                     "Atypical antipsychotics",
                                     ifelse(drugTarget %in% inter_meds[2:length(inter_meds)],
                                            "Selective serotonin reuptake inhibitors", 
                                            "OTHER")), 
                 drugSource = ifelse(drugSource %in% inter_meds[1:2], 
                                     "Atypical antipsychotics",
                                     ifelse(drugSource %in% inter_meds[2:length(inter_meds)],
                                            "Selective serotonin reuptake inhibitors", 
                                            "OTHER"))) %>% 
          mutate(drugTarget = paste(drugTarget,months[j+1],sep="_")) %>%
          mutate(drugSource = paste(drugSource,months[j], sep="_")) %>%
          group_by(drugSource, drugTarget) %>%
          count %>% 
          mutate(medication = substr(drugSource, 1, nchar(drugSource)-5))
      
        
        assign(paste0("df_drugsYear",cont),drugs_patterns)
        cont = cont + 1
         
      }
     
    }
    #Obtain a list of each of the dataframes 
    df_names <- paste0("df_drugsYear",1:(cont-1))
    df_list <- mget(df_names, inherits =  FALSE)

    #For all the months
    all_patterns_monthly_df <- bind_rows(df_list)


    end.time <- Sys.time()

Same process is followed but for the individual-level shifts monthly in
2019.

    #For the others meds 
    other_meds.df <- data.frame("OTHER","Other")
    names(other_meds.df) <- c("medication","Drug_class")

    drug_classes <- rbind(drug_classes, 
                          other_meds.df)

    nodes_colors <- data.frame(Drug_class = sort(c("Selective serotonin reuptake inhibitors","Atypical antipsychotics","Other")))

    color_nodes <- c("#489b7b","#cb6527", "#DDAB3B")


    #The next functions is to add transparency (opacity) to the colors 
    add.alpha <- function(col, alpha = 1){
      if(missing(col)){
        stop("Provide a vector of colours.")
      }else{
        apply(sapply(col, col2rgb)/255, 2,
              function(x)
                rgb(x[1], x[2], x[3], alpha = alpha))
      }
    }

    color_nodes_alpha <- add.alpha(color_nodes, alpha = 0.4)
    nodes_colors <- cbind(nodes_colors, color = color_nodes, color_link = color_nodes_alpha)

    #Create the nodes
    nodes <- all_patterns_monthly_df %>%
      pivot_longer(1:2, values_to = "name_node") %>%
      distinct(name_node) %>% arrange(name_node) %>% 
      mutate(year = as.numeric(sub(".*_(\\d+)$", "\\1", name_node))) %>% 
      arrange(year) %>%
      mutate(name_node2 = substr(name_node, 1, nchar(name_node)-7)) %>% 
      mutate(medication = name_node2) %>% 
      mutate(name_node2 = gsub("(?<=\\b)([a-z])", 
                               "\\U\\1", 
                               tolower(name_node2), perl = TRUE)) %>% 
      arrange(year, medication) %>% 
      mutate(idx = (1:n()) - 1)
      
      links<- bind_rows(
        all_patterns_monthly_df %>% select(source = drugSource, target = drugTarget, value = n)) %>%
        mutate(year = as.numeric(sub(".*_(\\d+)$", "\\1", source))) %>% 
        arrange(year) %>% 
        dplyr::group_by(source, target) %>%
        mutate(source = nodes$idx[match(source, nodes$name_node)]) %>%
        mutate(target = nodes$idx[match(target, nodes$name_node)]) %>% 
        ungroup()

      #Obtain the nodes that have a total less than 1 (dummy link)
    nodes_smallCount_source <- links %>% 
        group_by(source) %>% 
        summarise(total = sum(value)) %>% 
        filter(.$total < 1) %>%
        ungroup() %>% 
        select(source) %>% 
        unique
      
        nodes_smallCount_target <- links %>% 
        group_by(target) %>% 
        summarise(total = sum(value)) %>% 
        filter(.$total < 1) %>%
        ungroup() %>%
        select(target) %>% 
        unique
        
       nodes_smallCount <- nodes_smallCount_source %>% 
          filter(.$source %in% nodes_smallCount_target$target | 
                   .$source %in% c(3))
      

    #Create the group of the nodes for coloring 
    nodes <- nodes %>%
      mutate(color = "black") %>% 
    mutate(color = ifelse(idx %in% 
                            nodes_smallCount$source, 
                          "#00000000", color)) %>%
    mutate(medication = ifelse(color == "#00000000", paste0(medication,"_D"), medication), 
           name_node2 = ifelse(color == "#00000000", '', name_node2))


    drug_class <- nodes_colors$medication
    # linkColors <- sort(unique(links$color))

    nodes_drugClasses <- nodes %>% 
      select(idx, medication) %>% 
      unique 

    #This is to just leave the name of the nodes at the end
    nodes <- nodes %>% 
      mutate(name_node_final = ifelse(year < max(year) , '', name_node2))

    colnames(nodes_drugClasses)[1] = "source"

    links <- left_join(links, nodes_drugClasses, by = "source") %>% 
        arrange(year, medication) %>% 
        mutate(medication = ifelse(value == 1e-6 & 
                                     substr(medication, nchar(medication)-1, 
                                            nchar(medication)) != "_D", paste0(medication,"_D"), medication))
      
    colnames(links)[7] <- "medication"

    my_color <- paste("d3.scaleOrdinal().domain([",
                      paste0("'",paste(drug_class, 
                                       collapse = "','"),"'"),",",paste0("'",paste(paste0(drug_class,"_D"), 
                                                                                   collapse = "','"),"'"),
                      "]).range([",
                      paste0("'",paste(color_nodes,collapse="','"),"'"),",'#00000000', '#00000000', '#00000000'])")

    my_color <- "d3.scaleOrdinal().domain([ 'Atypical antipsychotics','Selective serotonin reuptake inhibitors', 'Other', 'Atypical antipsychotics_D', 'Selective serotonin reuptake inhibitors_D', 'Other_D']).range([ '#489b7b','#cb6527','#DDAB3B', '#00000000', '#00000000', '#00000000'])"




    nodes <- nodes %>% 
      mutate(name_node_final = ifelse(name_node_final == "Atypical Antipsychotics", "FDA-approved medications", 
                                      ifelse(name_node_final == "Selective Serotonin Reuptake Inhibitors", 
                                             "SSRIs", 
                                             name_node_final)))



    fig_overtime_drugClasses <- sankeyNetwork(Links=links, Nodes=nodes, Source='source',
                                                Target='target', 
                                                Value = 'value', 
                                                NodeID ='name_node_final',
                                                colourScale=my_color,
                                                fontSize= 45, nodeWidth = 25,
                                                nodePadding = 15,
                                                sinksRight = FALSE,
                                                LinkGroup =  "medication",
                                                NodeGroup = "medication", 
                                                iterations = 0, width = 3000, height = 900)

    fig_overtime_drugClasses
    end.time <- Sys.time()

## Sankey diagram but not aggregating the two FDA-approved medications

In order to extract the exact count of patients who took the two FDA
approved medications separately, we are going to do the same process but
without aggregating in that drug class.

### Yearly

    SSRIs_meds <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
      select(medication, Drug_class) %>% 
      unique %>% 
      filter(Drug_class == "Selective serotonin reuptake inhibitors") %>% 
      select(medication) %>% 
      unlist

    meds_to_study <- c("ARIPIPRAZOLE", "RISPERIDONE",SSRIs_meds)
    inter_meds <- c("ARIPIPRAZOLE", "RISPERIDONE", SSRIs_meds)

    #The meds joined 
    meds_to_study_joined <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
      select(medication) %>% 
      unique %>% 
      unlist

    start.time <- Sys.time()
    patients_id_allYears<-c()

    years<-2012:2021

    patients_source<- c()
    cont <- 1

    for(j in 1:length(years)){
      #Declare initial vectors
      if(years[j] < max(years)){
       
        medication_source_c<- c()
        medication_target_c<-c()
        
      patients_id <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>%
          filter(year == years[j]) %>%
          select(pat_id, medication) %>%
          unique %>%
          filter(!pat_id %in% patients_beforeObsPeriod$pat_id) %>%
          group_by(pat_id) %>%
          filter(all(medication %in% meds_to_study)) %>% 
          summarise(n = n_distinct(medication), .groups = 'drop') %>%
          filter(n == 1) %>%
          select(pat_id) %>%
          unlist
        
        assign(paste0("patientsList",cont),patients_id)

        
        if(years[j] > 2012){
          patAndMed_year <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
            filter(year == years[j-1]) %>% 
            select(pat_id, medication) %>%
            unique %>% 
            group_by(pat_id) %>% 
            filter(any(medication %in% meds_to_study)) %>% 
            ungroup() %>% 
            group_by(pat_id) %>% 
            count %>% 
            ungroup() %>% 
            filter(n > 1)
          
          patients_id <- patients_id[! patients_id %in% patAndMed_year$pat_id]
          
          assign(paste0("patientsList",cont),patients_id)

        }
       
        patients_id_allYears <- unique(c(patients_id_allYears,patients_id))
        
        
          for(i in patients_id_allYears){
            #Go to each patient and see what of those only have one prescription 
            #or multiple prescription for the same drug medication (drug class)
            
            #In the source
            medication_source <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
              filter(year == years[j] & 
                       .$pat_id == i) %>% 
              select(medication) %>% unique
            
            
            #And in the target 
            medication_target <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
              filter(year == years[j+1] &  
                       .$pat_id == i) %>% 
              select(medication) %>% unique
            
            
            #Verify that the prescriptions only are from the same medication
            #And extract the medication
            if(nrow(medication_source) == 1 & nrow(medication_target) == 1 &
               (medication_source %in% meds_to_study_joined &
                medication_target %in% meds_to_study_joined)){
              
              patients_source<-c(patients_source,i)
              medication_source_c <-c(medication_source_c,medication_source)
              medication_target_c <-c(medication_target_c,medication_target)
            
            }
          }
          
        
        # and count it 
          drugs_patterns <- data.frame(drugSource = unlist(medication_source_c),
                                     drugTarget = unlist(medication_target_c)) %>%
          mutate(drugTarget = ifelse(drugTarget %in% inter_meds[1:2], 
                                     drugTarget,
                                     ifelse(drugTarget %in%
                                              inter_meds[2:length(inter_meds)],
                                            "Selective serotonin reuptake inhibitors", 
                                            "OTHER")), 
                 drugSource = ifelse(drugSource %in% inter_meds[1:2], 
                                     drugSource,
                                     ifelse(drugSource %in%
                                              inter_meds[2:length(inter_meds)],
                                            "Selective serotonin reuptake inhibitors", 
                                            "OTHER"))) %>% 
          mutate(drugTarget = paste(drugTarget,years[j+1],sep="_")) %>%
          mutate(drugSource = paste(drugSource,years[j], sep="_")) %>%
          group_by(drugSource, drugTarget) %>%
          count %>% 
          mutate(medication = substr(drugSource, 1, nchar(drugSource)-5))
      
        
        assign(paste0("df_drugsYear",cont),drugs_patterns)
        cont = cont + 1
         
      }
     
    }
    #Obtain a list of each of the dataframes 
    df_names <- paste0("df_drugsYear",1:(cont-1))
    df_list <- mget(df_names, inherits =  FALSE)

    #For all the months
    all_patterns_years_notAggregate_df <- bind_rows(df_list)


    end.time <- Sys.time()

The time taken by the sankey diagram generation.

    end.time - start.time

    fwrite(all_patterns_years_notAggregate_df, "Y:/Paula/Files_finish/WithoutR491/SSRIs_RispArip_yearly_NewChanges_meds.csv")

### Monthly

    year_select <- 2019

    claims_dataset <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
       filter(.$year == year_select) #If is just one year
      #filter(.$year %in% year_select) #If is several years at once 


    months <- 201901:201912

    patients_id_allMonths <- c()

    #If two FDA approvd medications 

    meds_to_study <- c("ARIPIPRAZOLE", "RISPERIDONE",SSRIs_meds)
    inter_meds <- c("ARIPIPRAZOLE", "RISPERIDONE", SSRIs_meds)

    #The meds joined 
    meds_to_study_joined <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
      select(medication) %>% 
      unique %>% 
      unlist 

    start.time <- Sys.time()

    years<-2012:2021

    patients_source<- c()
    cont <- 1

    for(j in 1:length(months)){
      #Declare initial vectors
      if(months[j] < max(months)){
       
        medication_source_c<- c()
        medication_target_c<-c()
        
        #Extract only the patients that appears with a claim in the source
        #To reduce time consumption
        
        patients_id <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>%
          filter(month_id == months[j]) %>%
          select(pat_id, medication) %>%
          unique %>%
          filter(!pat_id %in% patients_beforeObsPeriod$pat_id) %>%
          group_by(pat_id) %>%
          filter(all(medication %in% meds_to_study)) %>% 
          summarise(n = n_distinct(medication), .groups = 'drop') %>%
          filter(n == 1) %>%
          select(pat_id) %>%
          unlist
        
        assign(paste0("patientsList",cont),patients_id)

        
        if(months[j] > min(months)){
          patAndMed_year <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
            filter(month_id == months[j-1]) %>% 
            select(pat_id, medication) %>%
            unique %>% 
            group_by(pat_id) %>% 
            filter(any(medication %in% meds_to_study)) %>% 
            ungroup() %>% 
            group_by(pat_id) %>% 
            count %>% 
            ungroup() %>% 
            filter(n > 1)
          
          patients_id <- patients_id[! patients_id %in% patAndMed_year$pat_id]
          
          assign(paste0("patientsList",cont),patients_id)

        }
       
        patients_id_allMonths <- unique(c(patients_id_allMonths,patients_id))
        
        
          for(i in patients_id_allMonths){
            #Go to each patient and see what of those only have one prescription 
            #or multiple prescription for the same drug medication (drug class)
            
            #In the source
            medication_source <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
              filter(month_id == months[j] & 
                       .$pat_id == i) %>% 
              select(medication) %>% unique
            
            
            #And in the target 
            medication_target <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
              filter(month_id == months[j+1] &  
                       .$pat_id == i) %>% 
              select(medication) %>% unique
            
            
            #Verify that the prescriptions only are from the same medication
            #And extract the medication
            if(nrow(medication_source) == 1 & nrow(medication_target) == 1 &
               (medication_source %in% meds_to_study_joined &
                medication_target %in% meds_to_study_joined)){
              
              patients_source<-c(patients_source,i)
              medication_source_c <-c(medication_source_c,medication_source)
              medication_target_c <-c(medication_target_c,medication_target)
            
            }
          }
          
        
        # and count it 
        drugs_patterns <- data.frame(drugSource = unlist(medication_source_c),
                                     drugTarget = unlist(medication_target_c)) %>%
          mutate(drugTarget = ifelse(drugTarget %in% inter_meds[1:2], 
                                     drugTarget,
                                     ifelse(drugTarget %in%
                                              inter_meds[2:length(inter_meds)],
                                            "Selective serotonin reuptake inhibitors", 
                                            "OTHER")), 
                 drugSource = ifelse(drugSource %in% inter_meds[1:2], 
                                     drugSource,
                                     ifelse(drugSource %in%
                                              inter_meds[2:length(inter_meds)],
                                            "Selective serotonin reuptake inhibitors", 
                                            "OTHER"))) %>% 
          mutate(drugTarget = paste(drugTarget,months[j+1],sep="_")) %>%
          mutate(drugSource = paste(drugSource,months[j], sep="_")) %>%
          group_by(drugSource, drugTarget) %>%
          count %>% 
          mutate(medication = substr(drugSource, 1, nchar(drugSource)-5))
      
        
        assign(paste0("df_drugsYear",cont),drugs_patterns)
        cont = cont + 1
         
      }
     
    }
    #Obtain a list of each of the dataframes 
    df_names <- paste0("df_drugsYear",1:(cont-1))
    df_list <- mget(df_names, inherits =  FALSE)

    #For all the months
    all_patterns_monthly_notAggregate_df <- bind_rows(df_list)


    end.time <- Sys.time()

    fwrite(all_patterns_monthly_notAggregate_df, "Y:/Paula/Files_finish/WithoutR491/SSRIs_RispArip_monthly_NewChanges_meds.csv")

## To calculate rate of change

    all_patterns_years_df<-fread("Y:/Paula/Files_finish/WithoutR491/SSRIs_RispArip_yearly_NewChanges.csv")
    all_patterns_monthly_df <- fread("Y:/Paula/Files_finish/WithoutR491/SSRIs_RispArip_monthly_NewChanges.csv")

Aggregated by drug class, we calculate the average proportion of
patients who shifted to other medications.

Monthly.

    AllThePatientsShifting_monthly <- all_patterns_monthly_df %>%
      mutate(namedrugSource = substr(drugSource, 
                                     1, 
                                     nchar(drugSource) - 7), 
             namedrugTarget = substr(drugTarget, 
                                     1, 
                                     nchar(drugTarget) - 7)) %>%
      filter(namedrugSource != namedrugTarget) %>% 
        group_by(drugSource) %>% 
        summarise(total_change = sum(n)) %>% 
      ungroup()

    #Sum all the patients per medication 
    AllThePatientsStaying_monthly <- all_patterns_monthly_df %>%
        group_by(drugSource) %>% 
        summarise(total = sum(n)) %>% 
      ungroup()

    #Left join to calculate the change 
    rates_Change_monthly <- AllThePatientsStaying_monthly %>% 
      left_join(AllThePatientsShifting_monthly, by = "drugSource") %>% 
      group_by(drugSource) %>% 
      mutate(rate_change = total_change/total) %>% 
      ungroup() %>% 
      mutate(namedrugSource = substr(drugSource, 
                                     1, 
                                     nchar(drugSource) - 7)) %>% 
      group_by(namedrugSource) %>% 
      summarise(rate_change_prop = sum(rate_change)/11) %>% 
      ungroup()

Yearly.

    AllThePatientsShifting_yearly <- all_patterns_years_df %>%
      mutate(namedrugSource = substr(drugSource, 
                                     1, 
                                     nchar(drugSource) - 5), 
             namedrugTarget = substr(drugTarget, 
                                     1, 
                                     nchar(drugTarget) - 5)) %>%
      filter(namedrugSource != namedrugTarget) %>% 
        group_by(drugSource) %>% 
        summarise(total_change = sum(n)) %>% 
      ungroup()

    #Sum all the patients per medication 
    AllThePatientsStaying_yearly <- all_patterns_years_df %>%
        group_by(drugSource) %>% 
        summarise(total = sum(n)) %>% 
      ungroup()

    #Left join to calculate the change 
    rates_Change_yearly <- AllThePatientsStaying_yearly %>% 
      left_join(AllThePatientsShifting_yearly, by = "drugSource") %>% 
      mutate(total_change = ifelse(is.na(total_change), 0, total_change)) %>% 
      group_by(drugSource) %>% 
      mutate(rate_change = total_change/total * 100) %>% 
      ungroup() %>% 
      mutate(namedrugSource = substr(drugSource, 
                                     1, 
                                     nchar(drugSource) - 5))

    %>% 
      group_by(namedrugSource) %>% 
      summarise(rate_change_prop = sum(rate_change)/11) %>% 
      ungroup()

To calculate the average proportion by medications (aripiprazole and
risperidone) - yearly.

    AllThePatientsShifting_yearly <- all_patterns_years_notAggregate_df %>%
      mutate(namedrugSource = substr(drugSource, 
                                     1, 
                                     nchar(drugSource) - 5), 
             namedrugTarget = substr(drugTarget, 
                                     1, 
                                     nchar(drugTarget) - 5))  %>% 
      filter(!(namedrugSource == "ARIPIPRAZOLE" & 
                namedrugTarget == "RISPERIDONE") &  
               !(namedrugSource == "RISPERIDONE" & 
                namedrugTarget == "ARIPIPRAZOLE")) %>% 
      filter(namedrugSource != namedrugTarget) %>% 
        group_by(drugSource) %>% 
        summarise(total_change = sum(n)) %>% 
      ungroup() %>% 
      mutate(namedrugSource_med = substr(drugSource, 
                                     1, 
                                     nchar(drugSource) - 5),
             namedrugSource = drugSource,
             year_med = substr(drugSource,
                               nchar(drugSource) - 4, 
                               nchar(drugSource)),
             drugSource = ifelse(namedrugSource_med %in% c("ARIPIPRAZOLE",
                                                           "RISPERIDONE"), 
                                 paste0("Atypical antipsychotics", 
                                        year_med), 
                                 ifelse(namedrugSource_med  == "Selective serotonin reuptake inhibitors", 
                                        paste0("Selective serotonin reuptake inhibitors",
                                               year_med), paste0("OTHER",year_med))
                                  )) %>% 
      select(-year_med)

    #Sum all the patients per medication 
    AllThePatientsStaying_yearly <- all_patterns_years_df %>%
        group_by(drugSource) %>% 
        summarise(total = sum(n)) %>% 
      ungroup()

    #Left join to calculate the change 
    rates_Change_yearly <- AllThePatientsStaying_yearly %>% 
      left_join(AllThePatientsShifting_yearly, by = "drugSource") %>% 
      mutate(total_change = ifelse(is.na(total_change), 0, total_change)) %>% 
      group_by(namedrugSource) %>% 
      mutate(rate_change = total_change/total * 100) %>% 
      ungroup() 

    %>% 
      group_by(namedrugSource_med) %>% 
      summarise(rate_change_prop = sum(rate_change)/11) %>% 
      ungroup()

To calculate the average proportion by medications (aripiprazole and
risperidone) - monthly

    AllThePatientsShifting_monthly <- all_patterns_monthly_notAggregate_df %>%
      mutate(namedrugSource = substr(drugSource, 
                                     1, 
                                     nchar(drugSource) - 7), 
             namedrugTarget = substr(drugTarget, 
                                     1, 
                                     nchar(drugTarget) - 7)) %>%
      filter(!(namedrugSource == "ARIPIPRAZOLE" & 
                namedrugTarget == "RISPERIDONE") &  
               !(namedrugSource == "RISPERIDONE" & 
                namedrugTarget == "ARIPIPRAZOLE")) %>%
      filter(namedrugSource != namedrugTarget) %>% 
        group_by(drugSource) %>% 
        summarise(total_change = sum(n)) %>% 
      ungroup() %>% 
      mutate(namedrugSource_med = substr(drugSource, 
                                     1, 
                                     nchar(drugSource) - 7),
             namedrugSource = drugSource,
             year_med = substr(drugSource,
                               nchar(drugSource) - 6, 
                               nchar(drugSource)),
             drugSource = ifelse(namedrugSource_med %in% c("ARIPIPRAZOLE",
                                                           "RISPERIDONE"), 
                                 paste0("Atypical antipsychotics", 
                                        year_med), 
                                 ifelse(namedrugSource_med  == "Selective serotonin reuptake inhibitors", 
                                        paste0("Selective serotonin reuptake inhibitors",
                                               year_med), paste0("OTHER",year_med))
                                  )) %>% 
      select(-year_med)

    #Sum all the patients per medication 
    AllThePatientsStaying_monthly <- all_patterns_monthly_df %>%
        group_by(drugSource) %>% 
        summarise(total = sum(n)) %>% 
      ungroup()

    #Left join to calculate the change 
    rates_Change_monthly <- AllThePatientsStaying_monthly %>% 
      left_join(AllThePatientsShifting_monthly, by = "drugSource") %>%
      mutate(total_change = ifelse(is.na(total_change), 0, total_change)) %>%
      group_by(namedrugSource) %>% 
      mutate(rate_change = total_change/total) %>% 
      ungroup() %>% 
      group_by(namedrugSource_med) %>% 
      summarise(rate_change_prop = sum(rate_change)/11) %>% 
      ungroup()

    #Save the patterns!
    fwrite(all_patterns_monthly_df, "Y:/Paula/Files_finish/WithoutR491/SSRIs_RispArip_monthly_NewChanges.csv")

    fwrite(all_patterns_years_df, "Y:/Paula/Files_finish/WithoutR491/SSRIs_RispArip_yearly_NewChanges.csv")

## To generate table - descriptive statistics

Separating the patients with at least one prescription of any of the
selected medications

    claims_prescrip_RL <- claims_ASD_wNDC_csv_onlyPrescripClass %>%
      filter(!pat_id %in% patients_beforeObsPeriod) %>%
      mutate(year_claim = as.numeric(substr(month_id, 1,4)))  %>% 
      group_by(year_claim, pat_id) %>% 
      filter(Drug_class == "Selective serotonin reuptake inhibitors" |
               
               medication %in% c("ARIPIPRAZOLE", "RISPERIDONE")) %>% 
      ungroup()

    claims_prescrip_table <- claims_prescrip_RL %>% 
      mutate(year_claim = as.numeric(substr(month_id, 1,4))) %>% 
      select(pat_id, medication, der_sex) %>% 
      unique %>% 
      group_by(pat_id) %>% 
      mutate(name_med = ifelse(all(medication %in% c("ARIPIPRAZOLE", "RISPERIDONE")),"FDA-approved only",ifelse(all(medication %in% SSRIs_meds), "SSRIs only", ifelse(any(medication %in% SSRIs_meds) &
                                        any(medication %in%
                                              c("ARIPIPRAZOLE",
                                                "RISPERIDONE")),
                                      "Both", "NA")))) %>% 
      ungroup() %>% 
      select(-medication) %>% 
      unique 


    allPatients <- unique(claims_prescrip_table$pat_id)

    #Diagnosis 
    SecondDiagnosis_age <- claims_diagnosis %>% 
      filter(pat_id %in% allPatients) %>% 
      arrange(from_dt, pat_id) %>%  
      group_by(pat_id) %>% 
      slice(1) %>% 
      ungroup() %>% 
      mutate(year = as.numeric(substr(from_dt, 1, 4)), 
             age_1Diag = year - der_yob) %>% 
      select(pat_id, age_1Diag)

    claims_prescrip_table <- claims_prescrip_table %>% 
      left_join(SecondDiagnosis_age) %>% 
      mutate(FirstDiagn_Age = case_when(
        age_1Diag >= 2 & age_1Diag <= 5 ~ "2 to 5", 
        age_1Diag >= 6 & age_1Diag <= 11 ~ "6 to 11", 
        age_1Diag >= 12 & age_1Diag <= 17 ~ "12 to 17",
        age_1Diag >= 18 & age_1Diag <= 26  ~ "18 to 26", 
        TRUE ~ "Other"
      ))
    library(tableone)

    vars <- c("der_sex", "FirstDiagn_Age")
    table <- CreateTableOne(vars = vars, strata = "name_med", data = claims_prescrip_table, factorVars = c("der_sex", "FirstDiagn_Age"))

    print(table, showAllLevels = TRUE, quote = FALSE, noSpaces = TRUE)

For the calendar year:

    claims_prescrip_table_year <- claims_prescrip_RL %>% 
      mutate(year_claim = as.numeric(substr(month_id, 1,4))) %>% 
      select(pat_id, medication, der_sex, year_claim) %>% 
      unique %>% 
      group_by(pat_id, year_claim) %>% 
      mutate(name_med = ifelse(all(medication %in% c("ARIPIPRAZOLE", "RISPERIDONE")),"FDA-approved only",ifelse(all(medication %in% SSRIs_meds), "SSRIs only", ifelse(any(medication %in% SSRIs_meds) &
                                        any(medication %in%
                                              c("ARIPIPRAZOLE",
                                                "RISPERIDONE")),
                                      "Both", "NA")))) %>% 
      ungroup() %>%
      select(-medication) %>%
      unique 

    vars <- c("year_claim") 
    table_2 <- CreateTableOne(vars = vars, strata = "name_med", data = claims_prescrip_table_year, factorVars = c("year_claim"))


    print(table_2, showAllLevels = TRUE, quote = FALSE, noSpaces = TRUE)

For all:

    table_3 <- CreateTableOne(vars = vars, data = claims_prescrip_table, factorVars = c("der_sex", "FirstDiagn_Age"))
    print(table_3, showAllLevels = TRUE, quote = FALSE, noSpaces = TRUE)

    table_4 <- CreateTableOne(vars = vars, data = claims_prescrip_table_year, factorVars = c("year_claim"))
    print(table_4, showAllLevels = TRUE, quote = FALSE, noSpaces = TRUE)

## Mann-Whitney U test: AA vs SSRI

    AllThePatientsShifting_yearly_ByMeds <- AllThePatientsStaying_yearly %>% 
      left_join(AllThePatientsShifting_yearly, by = "drugSource") %>% 
      mutate(total_change = ifelse(is.na(total_change), 0, total_change)) %>% 
      group_by(drugSource) %>% 
      mutate(rate_change = total_change/total * 100, 
             year = as.numeric(substr(drugSource, nchar(drugSource)-3, nchar(drugSource) ))) %>% 
      ungroup() %>% 
      mutate(namedrugSource = substr(drugSource, 
                                     1, 
                                     nchar(drugSource) - 5))

    ##AA
    AllThePatientsShifting_yearly_AA <- AllThePatientsShifting_yearly_ByMeds %>% 
      mutate(
        year = as.numeric(year)
      ) %>% 
      filter(namedrugSource == "Atypical antipsychotics")

    #SSRIs
    AllThePatientsShifting_yearly_SSRIs <- AllThePatientsShifting_yearly_ByMeds %>% 
      mutate(
        year = as.numeric(year)
      ) %>% 
      filter(namedrugSource == "Selective serotonin reuptake inhibitors")

    wilcox.test(AllThePatientsShifting_yearly_AA$rate_change, AllThePatientsShifting_yearly_SSRIs$rate_change, alternative = "two.sided")

## Number of ASD patients

### Yearly

    claims_ASD_wNDC_csv_onlyPrescripClass<-fread("Y:/Paula/Files_finish/NewFiles/07-01-24_OnlyPharmacotherapy_0to26_allFilters_2Diag_R419.csv")

    all_ASD <- claims_ASD_wNDC_csv_onlyPrescripClass %>% 
      mutate(year = as.numeric(substr(from_dt_claim, 1, 4))) %>% 
      select(pat_id, year) %>% 
      unique %>% 
      group_by(year) %>% 
      count %>% 
      ungroup() %>%
      mutate(
        all_ASD = n
      ) %>% 
      select(-n)

### Monthly

    all_ASD_month<- claims_ASD_wNDC_csv_onlyPrescripClass %>% 
      mutate(year = as.numeric(substr(from_dt_claim, 1, 4))) %>% 
      filter(year == 2019) %>% 
      mutate(
        month = substr(from_dt_claim, 1, 7) 
      ) %>% 
      select(pat_id, month) %>% 
      unique %>% 
      group_by(month) %>% 
      count %>% 
      ungroup() %>%
      mutate(
        all_ASD = n
      ) %>% 
      select(-n)
      

    all_ASD_month

## Total prescriptions of each drug class

### Yearly

    claims_ASD_wNDC_csv_onlyPrescripClass %>% 
      filter(Drug_class == "Selective serotonin reuptake inhibitors") %>% 
      mutate(year = as.numeric(substr(from_dt_claim, 1, 4))) %>% 
      select(pat_id, year) %>% 
      unique %>% 
      group_by(year) %>% 
      count %>% 
      ungroup() %>% 
      mutate(
        SSRIs_prescrip = n
      ) %>% 
      select(-n) %>% 
      left_join(all_ASD, by = "year") %>% 
      mutate(
        prop_SSRI_perYear = SSRIs_prescrip / all_ASD * 100
      )

    claims_ASD_wNDC_csv_onlyPrescripClass %>% 
      filter(Drug_class == "Atypical antipsychotics") %>% 
      mutate(year = as.numeric(substr(from_dt_claim, 1, 4))) %>% 
      select(pat_id, year) %>% 
      unique %>% 
      group_by(year) %>% 
      count %>% 
      ungroup() %>% 
      mutate(
        AA_prescrip = n
      ) %>% 
      select(-n) %>% 
      left_join(all_ASD, by = "year") %>% 
      mutate(
        prop_AA_perYear = AA_prescrip / all_ASD * 100
      )

    claims_ASD_wNDC_csv_onlyPrescripClass %>% 
      filter(!(Drug_class %in% c("Selective serotonin reuptake inhibitors","Atypical antipsychotics") 
               )) %>% 
      mutate(year = as.numeric(substr(from_dt_claim, 1, 4))) %>% 
      select(pat_id, year) %>% 
      unique %>% 
      group_by(year) %>% 
      count %>% 
      ungroup() %>% 
      mutate(
        Other_prescrip = n
      ) %>% 
      select(-n) %>% 
      left_join(all_ASD, by = "year") %>% 
      mutate(
        prop_Other_perYear = Other_prescrip / all_ASD * 100
      )

    AllThePatientsStaying_yearly

    all_patterns_years_df %>%
      group_by(drugTarget) %>% 
      summarise(total = sum(n)) %>% 
      ungroup()

### Monthly

    claims_ASD_wNDC_csv_onlyPrescripClass %>% 
      filter(Drug_class == "Selective serotonin reuptake inhibitors") %>% 
      mutate(year = as.numeric(substr(from_dt_claim, 1, 4))) %>% 
      filter(year == 2019) %>% 
      mutate(
        month = substr(from_dt_claim, 1, 7) 
      ) %>% 
      select(pat_id, month) %>% 
      unique %>% 
      group_by(month) %>% 
      count %>% 
      ungroup() %>% 
      mutate(
        SSRIs_prescrip = n
      ) %>% 
      select(-n) %>% 
      left_join(all_ASD_month, by = "month") %>% 
      mutate(
        prop_SSRI_perMonth = SSRIs_prescrip / all_ASD * 100
      )

    claims_ASD_wNDC_csv_onlyPrescripClass %>% 
      filter(Drug_class == "Atypical antipsychotics") %>% 
      mutate(year = as.numeric(substr(from_dt_claim, 1, 4))) %>% 
      filter(year == 2019) %>% 
      mutate(
        month = substr(from_dt_claim, 1, 7) 
      ) %>% 
      select(pat_id, month) %>% 
      unique %>% 
      group_by(month) %>% 
      count %>% 
      ungroup() %>% 
      mutate(
        AA_prescrip = n
      ) %>% 
      select(-n) %>% 
      left_join(all_ASD_month, by = "month") %>% 
      mutate(
        prop_AA_perMonth = AA_prescrip / all_ASD * 100
      )

    claims_ASD_wNDC_csv_onlyPrescripClass %>% 
        filter(!(Drug_class %in% c("Selective serotonin reuptake inhibitors","Atypical antipsychotics") 
               )) %>% 
      mutate(year = as.numeric(substr(from_dt_claim, 1, 4))) %>% 
      filter(year == 2019) %>% 
      mutate(
        month = substr(from_dt_claim, 1, 7) 
      ) %>% 
      select(pat_id, month) %>% 
      unique %>% 
      group_by(month) %>% 
      count %>% 
      ungroup() %>% 
      mutate(
        Other_prescrip = n
      ) %>% 
      select(-n) %>% 
      left_join(all_ASD_month, by = "month") %>% 
      mutate(
        prop_Other_perMonth = Other_prescrip / all_ASD * 100
      )

    AllThePatientsStaying_monthly

    all_patterns_monthly_df %>%
        group_by(drugTarget) %>% 
        summarise(total = sum(n)) %>% 
      ungroup()

## Transitions from the two AA to other meds

    # Extract drug name and year
    data <- rates_Change_yearly %>%
      mutate(
        Drug = sub("_.*", "", namedrugSource),  # Extract drug name
        Year = as.numeric(sub(".*_", "", namedrugSource))  # Extract year
      ) %>% 
      filter(
        Drug %in% c("ARIPIPRAZOLE", "RISPERIDONE") | 
          Drug == "Selective serotonin reuptake inhibitors"
      )

    lw <- 0.5
    # Plot trends for each drug
    ggplot(data, aes(x = Year, y = rate_change, color = Drug, group = Drug)) +
      geom_line(linewidth = 1) + 
      geom_point(size = 3) +
      scale_color_manual(values = c("ARIPIPRAZOLE" = "#C44601", "RISPERIDONE" = "#054fb9", "Selective serotonin reuptake inhibitors" = "#029356"), 
                        labels = c("Aripiprazole", "Risperidone", "SSRIs")) +
      scale_x_continuous(breaks = c(2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020)) + 
      labs(title = " ",
           x = "Year",
           y = "Rate of change (%)",
           color = "") +
      theme_bw(base_size = 22) +
      theme(
        panel.border = element_rect(size = lw, colour = 'black'),
        axis.line = element_line(size = lw),
        axis.ticks = element_line(size = lw),
        axis.text = element_text(size = 14),
        panel.grid.major =  element_blank(), 
        panel.grid.minor = element_blank(),
        text = element_text(family = "Arial"), 
        legend.text = element_text(size = 21), 
        axis.text.x = element_text(size = 21), 
        axis.text.y = element_text(size = 21), 
        legend.title = element_text(face = "bold"), 
        legend.position = "bottom"
      ) 

    # Calculate correlation for each drug
    aripiprazole_corr <- cor.test(data$rate_change[data$Drug == "ARIPIPRAZOLE"], data$Year[data$Drug == "ARIPIPRAZOLE"], method = "spearman")
    risperidone_corr <- cor.test(data$rate_change[data$Drug == "RISPERIDONE"], data$Year[data$Drug == "RISPERIDONE"], method = "spearman")
    SSRIs_corr <- cor.test(data$rate_change[data$Drug == "Selective serotonin reuptake inhibitors"], 
                           data$Year[data$Drug == "Selective serotonin reuptake inhibitors"], 
                           method = "spearman")


    # # Print correlations
    # cat("Aripiprazole correlation:", aripiprazole_corr, "\n")
    # cat("Risperidone correlation:", risperidone_corr, "\n")

    aripiprazole_corr
    risperidone_corr
    SSRIs_corr

## Switching rates within atypical antipyschotics

    # Create separate columns for medication name and year
    all_patterns_years_notAggregate_df <- all_patterns_years_notAggregate_df %>%
      mutate(
        drugSource_name = sub("_.*$", "", drugSource),
        drugTarget_name = sub("_.*$", "", drugTarget),
        year = sub(".*_", "", drugSource)  # optional: extract year if needed
      )

    # Transitions from risperidone to aripiprazole
    risp_to_arip <- all_patterns_years_notAggregate_df %>%
      filter(drugSource_name == "RISPERIDONE" & drugTarget_name == "ARIPIPRAZOLE") %>%
      summarise(total_switch = sum(n))

    # Transitions from aripiprazole to risperidone
    arip_to_risp <- all_patterns_years_notAggregate_df %>%
      filter(drugSource_name == "ARIPIPRAZOLE" & drugTarget_name == "RISPERIDONE") %>%
      summarise(total_switch = sum(n))

    # Total patients initially on each SGA
    total_risp <- all_patterns_years_notAggregate_df %>%
      filter(drugSource_name == "RISPERIDONE") %>%
      summarise(total = sum(n))

    total_arip <- all_patterns_years_notAggregate_df %>%
      filter(drugSource_name == "ARIPIPRAZOLE") %>%
      summarise(total = sum(n))

    # Switching rates
    risp_to_arip_rate <- risp_to_arip$total_switch / total_risp$total * 100
    arip_to_risp_rate <- arip_to_risp$total_switch / total_arip$total * 100

## Mean episode duration (using episodes definition)

Medication episodes definition

    #To identify medication events
    medication_events <- function(each_pat_id, claims_df){
      
      onePatient_df <- claims_df %>% 
        filter(pat_id == each_pat_id) %>%
        arrange(pat_id, from_dt_claim)
      
      medications_prescribed <- onePatient_df %>% 
        select(medication) %>% 
        unique %>% 
        unlist 
        
        cont = 1 
        
      for(med in medications_prescribed){
        medication_onePatient_df <- onePatient_df %>% 
          filter(medication == med) %>% 
          mutate(from_dt_claim = as.Date(from_dt_claim, "%Y-%m-%d")) %>% 
          select(pat_id, from_dt_claim, dayssup, medication, daily)
        
        colnames(medication_onePatient_df) <- c("PATIENT_ID", "DATE", "DURATION", "CATEGORY", "PERDAY")
      
      
        medication_onePatient_df <- medication_onePatient_df %>% 
          mutate(DATE  = as.Date(DATE, "%Y-%m-%d"))
      
      
        event_med <- compute.treatment.episodes(
          data = medication_onePatient_df,
          ID.colname = "PATIENT_ID",
          event.date.colname = "DATE",
          event.daily.dose.colname = "PERDAY",
          event.duration.colname = "DURATION", 
          medication.class.colname = "CATEGORY", 
          carry.only.for.same.medication = FALSE,
          carryover.within.obs.window = FALSE,
          maximum.permissible.gap = 30, #becuase this is per med no between meds
          maximum.permissible.gap.unit = "days",
          followup.window.start = 0,
          followup.window.start.unit = "days",
          followup.window.duration = 365*20,
          date.format = "%Y-%m-%d"
      )
      
        event_med <- event_med %>%
          mutate(medication = med)
      
        
        assign(paste0("event_meds",cont),event_med)
        
        cont = cont +1 
      }
      
      df_names <- paste0("event_meds",1:(cont-1))
      df_list <- mget(df_names, inherits =  FALSE)
      
      #For all the medications 
      event_meds_all <- bind_rows(df_list) %>% 
      arrange(episode.start)
      
      
      return(bind_rows(event_meds_all))
    }

Calculate mean episode duration per class and medication

    claims_ASD_wNDC_csv_onlyPrescripClass_RL <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
      filter(dayssup >= 1 & quan >= 1 ) %>% 
      mutate(daily = quan/dayssup)

    PatientID <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
      select(pat_id) %>% 
      unique %>% 
      unlist

    overlapping_period <- 30

    start.time <- Sys.time()

    event_meds_all <- bind_rows(lapply(PatientID, medication_events, claims_df = claims_ASD_wNDC_csv_onlyPrescripClass_RL))

    end.time <- Sys.time()

    event_meds_all_RL <- event_meds_all %>% 
      filter(medication %in% c("ARIPIPRAZOLE", "RISPERIDONE", "FLUOXETINE","CITALOPRAM","SERTRALINE","PAROXETINE","FLUVOXAMINE","ESCITALOPRAM"))

    #Only SGAs
    mean(event_meds_all_RL %>% group_by(PATIENT_ID) %>% filter(all(medication %in% c("RISPERIDONE", "ARIPIPRAZOLE"))) %>% ungroup %>% select(episode.duration) %>% unlist)

    #Both
    event_meds_all_RL %>% group_by(PATIENT_ID) %>% filter(any(medication %in% c("ARIPIPRAZOLE", "RISPERIDONE")) & any(medication %in% c("FLUOXETINE","CITALOPRAM","SERTRALINE","PAROXETINE","FLUVOXAMINE","ESCITALOPRAM")))

# Appendix

## To generate table - descriptive statistics (for those who did not receive any medication

Include those who did not receive any medication

    demographicASD<-fread("Y:/enrll_synth.csv")


    claims_prescrip_RL <- fread("Y:/Paula/Files_finish/NewFiles/07-01-24_AllClaims_2012-2021_2Diag_FirstDiag_0to26_noTherapySelec_R419.csv") %>%
      filter(!pat_id %in% unique(claims_ASD_wNDC_csv_onlyPrescripClass$pat_id)) 

    invisible(gc())
      

    claims_diagnosis <- fread("Y:/Paula/Files_finish/claims_ASD_withDrugNamesAndNDC.csv") %>%
       select(pat_id, from_dt, starts_with("diag")) %>%
      filter(.$pat_id %in% unlist(unique(claims_prescrip_RL$pat_id)) & 
               .$diagprc_ind != -1) %>% 
      select(-diagprc_ind) %>%
      pivot_longer(
        cols = -c(pat_id,from_dt), 
        names_to = "diagn_code",
        values_to = "dx_cd"
      ) %>% 
      select(-diagn_code) %>%
      distinct() %>% 
      filter(.$dx_cd != "") %>% 
      #Filter the ICD related to ASD
      filter(dx_cd %in% ASD_diagnoses_code) %>% 
      arrange(from_dt, pat_id) %>% 
      distinct() %>% 
      left_join(select(demographicASD, pat_id, der_yob), by = "pat_id")

    invisible(gc())

    claims_prescrip_table <- claims_prescrip_RL %>% 
      mutate(year_claim = as.numeric(substr(month_id, 1,4))) %>% 
      select(pat_id, der_sex) %>% 
      unique 


    allPatients <- unique(claims_prescrip_table$pat_id)

    #Diagnosis 
    SecondDiagnosis_age <- claims_diagnosis %>% 
      filter(pat_id %in% allPatients) %>% 
      arrange(from_dt, pat_id) %>%  
      group_by(pat_id) %>% 
      slice(1) %>% 
      ungroup() %>% 
      mutate(year = as.numeric(substr(from_dt, 1, 4)), 
             age_1Diag = year - der_yob) %>% 
      select(pat_id, age_1Diag)

    claims_prescrip_table <- claims_prescrip_table %>% 
      left_join(SecondDiagnosis_age) %>% 
      mutate(FirstDiagn_Age = case_when(
        age_1Diag >= 2 & age_1Diag <= 5 ~ "2 to 5", 
        age_1Diag >= 6 & age_1Diag <= 11 ~ "6 to 11", 
        age_1Diag >= 12 & age_1Diag <= 17 ~ "12 to 17",
        age_1Diag >= 18 & age_1Diag <= 26  ~ "18 to 26", 
        TRUE ~ "Other"
      ))
    library(tableone)

    vars <- c("der_sex", "FirstDiagn_Age")
    table <- CreateTableOne(vars = vars, data = claims_prescrip_table, factorVars = c("der_sex", "FirstDiagn_Age"))

    print(table, showAllLevels = TRUE, quote = TRUE, noSpaces = TRUE)

For the calendar year:

    claims_prescrip_table_year <- claims_prescrip_RL %>% 
      mutate(year_claim = as.numeric(substr(month_id, 1,4))) %>% 
      select(pat_id, der_sex, year_claim) %>% 
      unique 

    vars <- c("year_claim") 
    table_2 <- CreateTableOne(vars = vars, data = claims_prescrip_table_year, factorVars = c("year_claim"))


    print(table_2, showAllLevels = TRUE, quote = TRUE, noSpaces = TRUE)

For all:

    table_3 <- CreateTableOne(vars = vars, data = claims_prescrip_table, factorVars = c("der_sex", "FirstDiagn_Age"))
    print(table_3, showAllLevels = TRUE, quote = FALSE, noSpaces = TRUE)

    table_4 <- CreateTableOne(vars = vars, data = claims_prescrip_table_year, factorVars = c("year_claim"))
    print(table_4, showAllLevels = TRUE, quote = FALSE, noSpaces = TRUE)
