---
title: "Medication patterns"
author: "Paula Jaimes"
date: "2024-04-22"
output: html_document
---

This script contains the step by step of the identification of patterns of the two FDA-approved medication and SSRIs. We used reimbursement claims data from individuals that have a prescription of those medications. The file used here is already cleaned and pre-processed.



To verify that the patients we are going to include later do not have a prescription for the two FDA-approved medications or SSRIs. For that, we used the entire claims data with all the years (2006 - 2022), and extract the patient ID, the medication prescribed and the year of the prescription.


```r
#To verify that patients from 2012 to 2021 have never had a prescription of aripiprazole and/or risperidone before 2012.


patients_beforeObsPeriod<-fread("S:/Paula/Files_finish/claims_ASD_withDrugNamesAndNDC.csv") %>% 
  mutate(year = as.numeric(substr(month_id, 1,4))) %>% 
  select(pat_id, year, generic_name) %>% 
  unique


gc() #Free unused memory
```

```
##            used  (Mb) gc trigger   (Mb)   max used    (Mb)
## Ncells  1282553  68.5   11540392  616.4   10075953   538.2
## Vcells 14443766 110.2 1274631800 9724.7 1588044825 12115.9
```

Then, we identify the patients with at least one prescription of aripiprazole, risperidone or medications part of the SSRIs.


```r
claims_ASD_wNDC_csv_onlyPrescripClass<-fread("S:/Paula/Files_finish/NewFiles/07-01-24_OnlyPharmacotherapy_0to26_allFilters_2Diag_R419.csv")

gc() #Free Unused memory
```


```r
SSRIs_genericNames <- claims_ASD_wNDC_csv_onlyPrescripClass %>%
  select(generic_name, Drug_class) %>% 
  unique %>% 
  filter(Drug_class == "Selective serotonin reuptake inhibitors") %>% 
  select(generic_name) %>% 
  unlist

patients_beforeObsPeriod <- patients_beforeObsPeriod %>%
  filter(year < 2012 & 
           generic_name %in% c("ARIPIPRAZOLE", 
                               "RISPERIDONE", 
                               "RISPERIDONE MICROSPHERES", 
                               SSRIs_genericNames)) 


patients_beforeObsPeriod <- patients_beforeObsPeriod %>% 
  select(pat_id) %>% 
  unique

gc()
```

For calculations.


```r
demographicASD<-read.csv("S:/enrll_synth.csv")

#"R419"

ASD_diagnoses_code <- c("F84","F840","F843","F845","F849","F848", 
                        "2990","29900","29901","2998","29980","29981","2999",
                        "29990","29991","299","2991","29910","29911")

#Load the entire claims to extract the age of the second diagnosis
claims_diagnosis <-  fread("S:/Paula/Files_finish/claims_ASD_withDrugNamesAndNDC.csv") %>% 
   select(pat_id, from_dt, starts_with("diag")) %>%
  filter(.$pat_id %in% unlist(unique(claims_ASD_wNDC_csv_onlyPrescripClass$pat_id)) & 
           .$diagprc_ind != -1) %>% 
  select(-diagprc_ind) %>%
  pivot_longer(
    cols = -c(pat_id,from_dt), 
    names_to = "diagn_code",
    values_to = "dx_cd"
  ) %>% 
  select(-diagn_code) %>%
  distinct() %>% 
  filter(.$dx_cd != "") %>% 
  #Filter the ICD related to ASD
  filter(dx_cd %in% ASD_diagnoses_code) %>% 
  arrange(from_dt, pat_id) %>% 
  distinct() %>% 
  left_join(select(demographicASD, pat_id, der_yob), by = "pat_id")
```

## Verifying usage of just the two drug classes

It is necessary to identify the patients using just the two drug classes selected, to then determine the individual-level shifts.

First, it is necessary to identify which of the patients receiving pharmacotherapy were using just the two drug classes.


```r
#Study period 
years = 2012:2021

#With only the drug classes 
drug_classes <- c("Atypical antipsychotics","Selective serotonin reuptake inhibitors")

DrugClassByYearAndPatient <- claims_ASD_wNDC_csv_onlyPrescripClass %>% 
  mutate(year_claim = as.numeric(substr(month_id, 1,4))) %>% 
  select(year_claim, pat_id, Drug_class) %>% 
  unique %>% 
  group_by(pat_id, year_claim) %>% 
  filter(all(Drug_class %in% drug_classes)) %>% 
  ungroup() %>% 
  arrange(year_claim, pat_id)
```

Then, select the patient IDs and the year were each of the patients just used the two drug classes. After that, extract the claims for those patients from the pharmacotherapy dataset.


```r
pat_id_ThreeDrugClass <- unlist(unique(DrugClassByYearAndPatient$pat_id))
year_threeDrugClasses <- unlist(unique(DrugClassByYearAndPatient$year_claim))

claims_ASD_wNDC_csv_onlyPrescripClass_RL<-claims_ASD_wNDC_csv_onlyPrescripClass %>%
  mutate(year_claim = as.numeric(substr(month_id, 1,4))) %>% 
  group_by(year_claim, pat_id) %>%
          filter(pat_id %in% pat_id_ThreeDrugClass & 
                   year_claim %in% year_threeDrugClasses) %>%
  ungroup() %>% 
  mutate(year = substr(month_id,1,4))

drug_classes <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
  filter(Drug_class %in% drug_classes) %>% 
  select(medication, Drug_class) %>% 
  unique 

gc()
```

Although other drug classes were extracted too, those are going to be useful when identifying individual-level shifts.


## Sankey diagram construction aggregating by drug classes

### Yearly

The following script contains the construction of the sankey diagram and the aggregation by drug classes. This script contains several parts and filters.

First, identify the names of the medications for the first filter, where the patients with a single medication used year by year has to be any of the medications previously selected (SSRIs and two FDA approved medications).,


```r
SSRIs_meds <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
  select(medication, Drug_class) %>% 
  unique %>% 
  filter(Drug_class == "Selective serotonin reuptake inhibitors") %>% 
  select(medication) %>% 
  unlist

meds_to_study <- c("ARIPIPRAZOLE", "RISPERIDONE",SSRIs_meds)
inter_meds <- c("ARIPIPRAZOLE", "RISPERIDONE", SSRIs_meds)

#The meds joined 
meds_to_study_joined <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
  select(medication) %>% 
  unique %>% 
  unlist
```

The following `for statenment` has several filters. First, we identify the patients with one medication usage per year, verify if those patients did not have a prescription of the selected medications before 2012 and that the medications used are part of the SSRIs or the two FDA-approved medications.

Because we are including newly prescribed users per year, we have to verify if the list of patients ID per year identified are indeed new users. We check if the patients did not have a prescription of the selected medications the year before.

The patients including are then follow over time, and, if they pass all the filters, are including each year.

Finally, we aggregate by drug class, changing the name of the medication by its drug class. The patients that shifted to a medication different from the selected medications, are included too, and the medication is changed by a new classification called "Other".


```r
start.time <- Sys.time()
patients_id_allYears<-c()

years<-2012:2021

patients_source<- c()
cont <- 1

for(j in 1:length(years)){
  #Declare initial vectors
  if(years[j] < max(years)){
   
    medication_source_c<- c()
    medication_target_c<-c()
    
    # patients_id <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
    #   filter(year == years[j]) %>% 
    #   select(pat_id, medication) %>% 
    #   unique %>%
    #   filter(!pat_id %in% patients_beforeObsPeriod) %>% 
    #   group_by(pat_id) %>% 
    #   count %>% 
    #   ungroup() %>% 
    #   filter(n == 1) %>% 
    #   select(pat_id) %>% 
    #   left_join(select(claims_ASD_wNDC_csv_onlyPrescripClass_RL, 
    #                pat_id, 
    #                medication)) %>%
    #   filter(medication %in% meds_to_study) %>% 
    #   select(pat_id) %>% 
    #   unlist 
    
  patients_id <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>%
      filter(year == years[j]) %>%
      select(pat_id, medication) %>%
      unique %>%
      filter(!pat_id %in% patients_beforeObsPeriod$pat_id) %>%
      group_by(pat_id) %>%
      filter(all(medication %in% meds_to_study)) %>% 
      summarise(n = n_distinct(medication), .groups = 'drop') %>%
      filter(n == 1) %>%
      select(pat_id) %>%
      unlist
    
    assign(paste0("patientsList",cont),patients_id)

    
    if(years[j] > 2012){
      patAndMed_year <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
        filter(year == years[j-1]) %>% 
        select(pat_id, medication) %>%
        unique %>% 
        group_by(pat_id) %>% 
        filter(any(medication %in% meds_to_study)) %>% 
        ungroup() %>% 
        group_by(pat_id) %>% 
        count %>% 
        ungroup() %>% 
        filter(n > 1)
      
      patients_id <- patients_id[! patients_id %in% patAndMed_year$pat_id]
      
      assign(paste0("patientsList",cont),patients_id)

    }
   
    patients_id_allYears <- unique(c(patients_id_allYears,patients_id))
    
    
      for(i in patients_id_allYears){
        #Go to each patient and see what of those only have one prescription 
        #or multiple prescription for the same drug medication (drug class)
        
        #In the source
        medication_source <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
          filter(year == years[j] & 
                   .$pat_id == i) %>% 
          select(medication) %>% unique
        
        
        #And in the target 
        medication_target <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
          filter(year == years[j+1] &  
                   .$pat_id == i) %>% 
          select(medication) %>% unique
        
        
        #Verify that the prescriptions only are from the same medication
        #And extract the medication
        if(nrow(medication_source) == 1 & nrow(medication_target) == 1 &
           (medication_source %in% meds_to_study_joined &
            medication_target %in% meds_to_study_joined)){
          
          patients_source<-c(patients_source,i)
          medication_source_c <-c(medication_source_c,medication_source)
          medication_target_c <-c(medication_target_c,medication_target)
        
        }
      }
      
    
    # and count it 
    drugs_patterns <- data.frame(drugSource = unlist(medication_source_c),
                                 drugTarget = unlist(medication_target_c)) %>%
      mutate(drugTarget = ifelse(drugTarget %in% inter_meds[1:2], 
                                 "Atypical antipsychotics",
                                 ifelse(drugTarget %in% inter_meds[2:length(inter_meds)],
                                        "Selective serotonin reuptake inhibitors", 
                                        "OTHER")), 
             drugSource = ifelse(drugSource %in% inter_meds[1:2], 
                                 "Atypical antipsychotics",
                                 ifelse(drugSource %in% inter_meds[2:length(inter_meds)],
                                        "Selective serotonin reuptake inhibitors", 
                                        "OTHER"))) %>% 
      mutate(drugTarget = paste(drugTarget,years[j+1],sep="_")) %>%
      mutate(drugSource = paste(drugSource,years[j], sep="_")) %>%
      group_by(drugSource, drugTarget) %>%
      count %>% 
      mutate(medication = substr(drugSource, 1, nchar(drugSource)-5))
  
    
    assign(paste0("df_drugsYear",cont),drugs_patterns)
    cont = cont + 1
     
  }
 
}
#Obtain a list of each of the dataframes 
df_names <- paste0("df_drugsYear",1:(cont-1))
df_list <- mget(df_names, inherits =  FALSE)

#For all the months
all_patterns_years_df <- bind_rows(df_list)


end.time <- Sys.time()
```

The time taken by the sankey diagram generation.


```r
end.time - start.time
```

```
## Time difference of 8.813644 mins
```
Now, the Sankey diagram construction.


```r
#For the others meds 
other_meds.df <- data.frame("OTHER","Other")
names(other_meds.df) <- c("medication","Drug_class")

drug_classes <- rbind(drug_classes, 
                      other_meds.df)

nodes_colors <- data.frame(Drug_class = sort(c("Selective serotonin reuptake inhibitors","Atypical antipsychotics","Other")))

color_nodes <- c("#489b7b","#cb6527", "#DDAB3B")

#The next functions is to add transparency (opacity) to the colors 
add.alpha <- function(col, alpha = 1){
  if(missing(col)){
    stop("Provide a vector of colours.")
  }else{
    apply(sapply(col, col2rgb)/255, 2,
          function(x)
            rgb(x[1], x[2], x[3], alpha = alpha))
  }
}

color_nodes_alpha <- add.alpha(color_nodes, alpha = 0.4)
nodes_colors <- cbind(nodes_colors, color = color_nodes, color_link = color_nodes_alpha)

#Create the nodes
nodes <- all_patterns_years_df %>%
  pivot_longer(1:2, values_to = "name_node") %>%
  distinct(name_node) %>% arrange(name_node) %>% 
  mutate(year = as.numeric(sub(".*_(\\d+)$", "\\1", name_node))) %>% 
  arrange(year) %>%
  mutate(name_node2 = substr(name_node, 1, nchar(name_node)-5)) %>% 
  mutate(medication = name_node2) %>% 
  mutate(name_node2 = gsub("(?<=\\b)([a-z])", 
                           "\\U\\1", 
                           tolower(name_node2), perl = TRUE)) %>% 
  arrange(year, medication) %>% 
  mutate(idx = (1:n()) - 1)

  links<- bind_rows(
    all_patterns_years_df %>% select(source = drugSource, target = drugTarget, value = n)) %>%
    mutate(year = as.numeric(sub(".*_(\\d+)$", "\\1", source))) %>% 
    arrange(year) %>% 
    dplyr::group_by(source, target) %>%
    mutate(source = nodes$idx[match(source, nodes$name_node)]) %>%
    mutate(target = nodes$idx[match(target, nodes$name_node)]) %>%
    ungroup()

  #Obtain the nodes that have a total less than 1 (dummy link)
nodes_smallCount_source <- links %>% 
    group_by(source) %>% 
    summarise(total = sum(value)) %>% 
    filter(.$total < 1) %>%
    ungroup() %>% 
    select(source) %>% 
    unique
  
    nodes_smallCount_target <- links %>% 
    group_by(target) %>% 
    summarise(total = sum(value)) %>% 
    filter(.$total < 1) %>%
    ungroup() %>%
    select(target) %>% 
    unique
    
   nodes_smallCount <- nodes_smallCount_source %>% 
      filter(.$source %in% nodes_smallCount_target$target | 
               .$source %in% c(3))
  

#Create the group of the nodes for coloring 
nodes <- nodes %>%
  mutate(color = "black") %>% 
mutate(color = ifelse(idx %in% 
                        nodes_smallCount$source, 
                      "#00000000", color)) %>%
mutate(medication = ifelse(color == "#00000000", paste0(medication,"_D"), medication), 
       name_node2 = ifelse(color == "#00000000", '', name_node2))


drug_class <- nodes_colors$medication
# linkColors <- sort(unique(links$color))

nodes_drugClasses <- nodes %>% 
  select(idx, medication) %>% 
  unique 

#This is to just leave the name of the nodes at the end
nodes <- nodes %>% 
  mutate(name_node_final = ifelse(year < max(year) , '', name_node2))

colnames(nodes_drugClasses)[1] = "source"

links <- left_join(links, nodes_drugClasses, by = "source") %>% 
    arrange(year, medication) %>% 
    mutate(medication = ifelse(value == 1e-6 & 
                                 substr(medication, nchar(medication)-1, 
                                        nchar(medication)) != "_D", paste0(medication,"_D"), medication))
  
colnames(links)[7] <- "medication"

my_color <- paste("d3.scaleOrdinal().domain([",
                  paste0("'",paste(drug_class, 
                                   collapse = "','"),"'"),",",paste0("'",paste(paste0(drug_class,"_D"), 
                                                                               collapse = "','"),"'"),
                  "]).range([",
                  paste0("'",paste(color_nodes,collapse="','"),"'"),",'#00000000', '#00000000', '#00000000'])")

my_color <- "d3.scaleOrdinal().domain([ 'Atypical antipsychotics','Selective serotonin reuptake inhibitors', 'Other', 'Atypical antipsychotics_D', 'Selective serotonin reuptake inhibitors_D', 'Other_D']).range([ '#489b7b','#cb6527','#DDAB3B', '#00000000', '#00000000', '#00000000'])"


nodes <- nodes %>% 
  mutate(name_node_final = ifelse(name_node_final == "Atypical Antipsychotics", "FDA-approved medications", 
                                  ifelse(name_node_final == "Selective Serotonin Reuptake Inhibitors", 
                                         "SSRIs", 
                                         name_node_final)))

fig_overtime_drugClasses <- sankeyNetwork(Links=links, Nodes=nodes, Source='source',
                                            Target='target', 
                                            Value = 'value', 
                                            NodeID ='name_node_final',
                                            colourScale=my_color,
                                            fontSize= 45, nodeWidth = 25,
                                            nodePadding = 15,
                                            sinksRight = FALSE,
                                            LinkGroup =  "medication",
                                            NodeGroup = "medication", 
                                            iterations = 0, width = 3000, height = 900)
```


### Monthly


```r
year_select <- 2019

claims_dataset <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
   filter(.$year == year_select) #If is just one year
  #filter(.$year %in% year_select) #If is several years at once 


months <- 201901:201912

patients_id_allMonths <- c()

#If two FDA approvd medications 

meds_to_study <- c("ARIPIPRAZOLE", "RISPERIDONE",SSRIs_meds)
inter_meds <- c("ARIPIPRAZOLE", "RISPERIDONE", SSRIs_meds)

#The meds joined 
meds_to_study_joined <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
  select(medication) %>% 
  unique %>% 
  unlist 

start.time <- Sys.time()

years<-2012:2021

patients_source<- c()
cont <- 1

for(j in 1:length(months)){
  #Declare initial vectors
  if(months[j] < max(months)){
   
    medication_source_c<- c()
    medication_target_c<-c()
    
    #Extract only the patients that appears with a claim in the source
    #To reduce time consumption
    
    patients_id <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>%
      filter(month_id == months[j]) %>%
      select(pat_id, medication) %>%
      unique %>%
      filter(!pat_id %in% patients_beforeObsPeriod$pat_id) %>%
      group_by(pat_id) %>%
      filter(all(medication %in% meds_to_study)) %>% 
      summarise(n = n_distinct(medication), .groups = 'drop') %>%
      filter(n == 1) %>%
      select(pat_id) %>%
      unlist
    
    assign(paste0("patientsList",cont),patients_id)

    
    if(months[j] > min(months)){
      patAndMed_year <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
        filter(month_id == months[j-1]) %>% 
        select(pat_id, medication) %>%
        unique %>% 
        group_by(pat_id) %>% 
        filter(any(medication %in% meds_to_study)) %>% 
        ungroup() %>% 
        group_by(pat_id) %>% 
        count %>% 
        ungroup() %>% 
        filter(n > 1)
      
      patients_id <- patients_id[! patients_id %in% patAndMed_year$pat_id]
      
      assign(paste0("patientsList",cont),patients_id)

    }
   
    patients_id_allMonths <- unique(c(patients_id_allMonths,patients_id))
    
    
      for(i in patients_id_allMonths){
        #Go to each patient and see what of those only have one prescription 
        #or multiple prescription for the same drug medication (drug class)
        
        #In the source
        medication_source <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
          filter(month_id == months[j] & 
                   .$pat_id == i) %>% 
          select(medication) %>% unique
        
        
        #And in the target 
        medication_target <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
          filter(month_id == months[j+1] &  
                   .$pat_id == i) %>% 
          select(medication) %>% unique
        
        
        #Verify that the prescriptions only are from the same medication
        #And extract the medication
        if(nrow(medication_source) == 1 & nrow(medication_target) == 1 &
           (medication_source %in% meds_to_study_joined &
            medication_target %in% meds_to_study_joined)){
          
          patients_source<-c(patients_source,i)
          medication_source_c <-c(medication_source_c,medication_source)
          medication_target_c <-c(medication_target_c,medication_target)
        
        }
      }
      
    
    # and count it 
    drugs_patterns <- data.frame(drugSource = unlist(medication_source_c),
                                 drugTarget = unlist(medication_target_c)) %>%
      mutate(drugTarget = ifelse(drugTarget %in% inter_meds[1:2], 
                                 "Atypical antipsychotics",
                                 ifelse(drugTarget %in% inter_meds[2:length(inter_meds)],
                                        "Selective serotonin reuptake inhibitors", 
                                        "OTHER")), 
             drugSource = ifelse(drugSource %in% inter_meds[1:2], 
                                 "Atypical antipsychotics",
                                 ifelse(drugSource %in% inter_meds[2:length(inter_meds)],
                                        "Selective serotonin reuptake inhibitors", 
                                        "OTHER"))) %>% 
      mutate(drugTarget = paste(drugTarget,months[j+1],sep="_")) %>%
      mutate(drugSource = paste(drugSource,months[j], sep="_")) %>%
      group_by(drugSource, drugTarget) %>%
      count %>% 
      mutate(medication = substr(drugSource, 1, nchar(drugSource)-5))
  
    
    assign(paste0("df_drugsYear",cont),drugs_patterns)
    cont = cont + 1
     
  }
 
}
#Obtain a list of each of the dataframes 
df_names <- paste0("df_drugsYear",1:(cont-1))
df_list <- mget(df_names, inherits =  FALSE)

#For all the months
all_patterns_monthly_df <- bind_rows(df_list)


end.time <- Sys.time()
```


Same process is followed but for the individual-level shifts monthly in 2019. 


```r
#For the others meds 
other_meds.df <- data.frame("OTHER","Other")
names(other_meds.df) <- c("medication","Drug_class")

drug_classes <- rbind(drug_classes, 
                      other_meds.df)

nodes_colors <- data.frame(Drug_class = sort(c("Selective serotonin reuptake inhibitors","Atypical antipsychotics","Other")))

color_nodes <- c("#489b7b","#cb6527", "#DDAB3B")


#The next functions is to add transparency (opacity) to the colors 
add.alpha <- function(col, alpha = 1){
  if(missing(col)){
    stop("Provide a vector of colours.")
  }else{
    apply(sapply(col, col2rgb)/255, 2,
          function(x)
            rgb(x[1], x[2], x[3], alpha = alpha))
  }
}

color_nodes_alpha <- add.alpha(color_nodes, alpha = 0.4)
nodes_colors <- cbind(nodes_colors, color = color_nodes, color_link = color_nodes_alpha)

#Create the nodes
nodes <- all_patterns_monthly_df %>%
  pivot_longer(1:2, values_to = "name_node") %>%
  distinct(name_node) %>% arrange(name_node) %>% 
  mutate(year = as.numeric(sub(".*_(\\d+)$", "\\1", name_node))) %>% 
  arrange(year) %>%
  mutate(name_node2 = substr(name_node, 1, nchar(name_node)-7)) %>% 
  mutate(medication = name_node2) %>% 
  mutate(name_node2 = gsub("(?<=\\b)([a-z])", 
                           "\\U\\1", 
                           tolower(name_node2), perl = TRUE)) %>% 
  arrange(year, medication) %>% 
  mutate(idx = (1:n()) - 1)
  
  links<- bind_rows(
    all_patterns_monthly_df %>% select(source = drugSource, target = drugTarget, value = n)) %>%
    mutate(year = as.numeric(sub(".*_(\\d+)$", "\\1", source))) %>% 
    arrange(year) %>% 
    dplyr::group_by(source, target) %>%
    mutate(source = nodes$idx[match(source, nodes$name_node)]) %>%
    mutate(target = nodes$idx[match(target, nodes$name_node)]) %>% 
    ungroup()

  #Obtain the nodes that have a total less than 1 (dummy link)
nodes_smallCount_source <- links %>% 
    group_by(source) %>% 
    summarise(total = sum(value)) %>% 
    filter(.$total < 1) %>%
    ungroup() %>% 
    select(source) %>% 
    unique
  
    nodes_smallCount_target <- links %>% 
    group_by(target) %>% 
    summarise(total = sum(value)) %>% 
    filter(.$total < 1) %>%
    ungroup() %>%
    select(target) %>% 
    unique
    
   nodes_smallCount <- nodes_smallCount_source %>% 
      filter(.$source %in% nodes_smallCount_target$target | 
               .$source %in% c(3))
  

#Create the group of the nodes for coloring 
nodes <- nodes %>%
  mutate(color = "black") %>% 
mutate(color = ifelse(idx %in% 
                        nodes_smallCount$source, 
                      "#00000000", color)) %>%
mutate(medication = ifelse(color == "#00000000", paste0(medication,"_D"), medication), 
       name_node2 = ifelse(color == "#00000000", '', name_node2))


drug_class <- nodes_colors$medication
# linkColors <- sort(unique(links$color))

nodes_drugClasses <- nodes %>% 
  select(idx, medication) %>% 
  unique 

#This is to just leave the name of the nodes at the end
nodes <- nodes %>% 
  mutate(name_node_final = ifelse(year < max(year) , '', name_node2))

colnames(nodes_drugClasses)[1] = "source"

links <- left_join(links, nodes_drugClasses, by = "source") %>% 
    arrange(year, medication) %>% 
    mutate(medication = ifelse(value == 1e-6 & 
                                 substr(medication, nchar(medication)-1, 
                                        nchar(medication)) != "_D", paste0(medication,"_D"), medication))
  
colnames(links)[7] <- "medication"

my_color <- paste("d3.scaleOrdinal().domain([",
                  paste0("'",paste(drug_class, 
                                   collapse = "','"),"'"),",",paste0("'",paste(paste0(drug_class,"_D"), 
                                                                               collapse = "','"),"'"),
                  "]).range([",
                  paste0("'",paste(color_nodes,collapse="','"),"'"),",'#00000000', '#00000000', '#00000000'])")

my_color <- "d3.scaleOrdinal().domain([ 'Atypical antipsychotics','Selective serotonin reuptake inhibitors', 'Other', 'Atypical antipsychotics_D', 'Selective serotonin reuptake inhibitors_D', 'Other_D']).range([ '#489b7b','#cb6527','#DDAB3B', '#00000000', '#00000000', '#00000000'])"




nodes <- nodes %>% 
  mutate(name_node_final = ifelse(name_node_final == "Atypical Antipsychotics", "FDA-approved medications", 
                                  ifelse(name_node_final == "Selective Serotonin Reuptake Inhibitors", 
                                         "SSRIs", 
                                         name_node_final)))



fig_overtime_drugClasses <- sankeyNetwork(Links=links, Nodes=nodes, Source='source',
                                            Target='target', 
                                            Value = 'value', 
                                            NodeID ='name_node_final',
                                            colourScale=my_color,
                                            fontSize= 45, nodeWidth = 25,
                                            nodePadding = 15,
                                            sinksRight = FALSE,
                                            LinkGroup =  "medication",
                                            NodeGroup = "medication", 
                                            iterations = 0, width = 3000, height = 900)
```



## Sankey diagram but not aggregating the two FDA-approved medications

In order to extract the exact count of patients who took the two FDA approved medications separately, we are going to do the same process but without aggregating in that drug class.

### Yearly


```r
SSRIs_meds <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
  select(medication, Drug_class) %>% 
  unique %>% 
  filter(Drug_class == "Selective serotonin reuptake inhibitors") %>% 
  select(medication) %>% 
  unlist

meds_to_study <- c("ARIPIPRAZOLE", "RISPERIDONE",SSRIs_meds)
inter_meds <- c("ARIPIPRAZOLE", "RISPERIDONE", SSRIs_meds)

#The meds joined 
meds_to_study_joined <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
  select(medication) %>% 
  unique %>% 
  unlist

start.time <- Sys.time()
patients_id_allYears<-c()

years<-2012:2021

patients_source<- c()
cont <- 1

for(j in 1:length(years)){
  #Declare initial vectors
  if(years[j] < max(years)){
   
    medication_source_c<- c()
    medication_target_c<-c()
    
  patients_id <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>%
      filter(year == years[j]) %>%
      select(pat_id, medication) %>%
      unique %>%
      filter(!pat_id %in% patients_beforeObsPeriod$pat_id) %>%
      group_by(pat_id) %>%
      filter(all(medication %in% meds_to_study)) %>% 
      summarise(n = n_distinct(medication), .groups = 'drop') %>%
      filter(n == 1) %>%
      select(pat_id) %>%
      unlist
    
    assign(paste0("patientsList",cont),patients_id)

    
    if(years[j] > 2012){
      patAndMed_year <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
        filter(year == years[j-1]) %>% 
        select(pat_id, medication) %>%
        unique %>% 
        group_by(pat_id) %>% 
        filter(any(medication %in% meds_to_study)) %>% 
        ungroup() %>% 
        group_by(pat_id) %>% 
        count %>% 
        ungroup() %>% 
        filter(n > 1)
      
      patients_id <- patients_id[! patients_id %in% patAndMed_year$pat_id]
      
      assign(paste0("patientsList",cont),patients_id)

    }
   
    patients_id_allYears <- unique(c(patients_id_allYears,patients_id))
    
    
      for(i in patients_id_allYears){
        #Go to each patient and see what of those only have one prescription 
        #or multiple prescription for the same drug medication (drug class)
        
        #In the source
        medication_source <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
          filter(year == years[j] & 
                   .$pat_id == i) %>% 
          select(medication) %>% unique
        
        
        #And in the target 
        medication_target <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
          filter(year == years[j+1] &  
                   .$pat_id == i) %>% 
          select(medication) %>% unique
        
        
        #Verify that the prescriptions only are from the same medication
        #And extract the medication
        if(nrow(medication_source) == 1 & nrow(medication_target) == 1 &
           (medication_source %in% meds_to_study_joined &
            medication_target %in% meds_to_study_joined)){
          
          patients_source<-c(patients_source,i)
          medication_source_c <-c(medication_source_c,medication_source)
          medication_target_c <-c(medication_target_c,medication_target)
        
        }
      }
      
    
    # and count it 
      drugs_patterns <- data.frame(drugSource = unlist(medication_source_c),
                                 drugTarget = unlist(medication_target_c)) %>%
      mutate(drugTarget = ifelse(drugTarget %in% inter_meds[1:2], 
                                 drugTarget,
                                 ifelse(drugTarget %in%
                                          inter_meds[2:length(inter_meds)],
                                        "Selective serotonin reuptake inhibitors", 
                                        "OTHER")), 
             drugSource = ifelse(drugSource %in% inter_meds[1:2], 
                                 drugSource,
                                 ifelse(drugSource %in%
                                          inter_meds[2:length(inter_meds)],
                                        "Selective serotonin reuptake inhibitors", 
                                        "OTHER"))) %>% 
      mutate(drugTarget = paste(drugTarget,years[j+1],sep="_")) %>%
      mutate(drugSource = paste(drugSource,years[j], sep="_")) %>%
      group_by(drugSource, drugTarget) %>%
      count %>% 
      mutate(medication = substr(drugSource, 1, nchar(drugSource)-5))
  
    
    assign(paste0("df_drugsYear",cont),drugs_patterns)
    cont = cont + 1
     
  }
 
}
#Obtain a list of each of the dataframes 
df_names <- paste0("df_drugsYear",1:(cont-1))
df_list <- mget(df_names, inherits =  FALSE)

#For all the months
all_patterns_years_notAggregate_df <- bind_rows(df_list)


end.time <- Sys.time()
```

The time taken by the sankey diagram generation.


```r
end.time - start.time
```

```
## Time difference of 9.039404 mins
```

### Monthly


```r
year_select <- 2019

claims_dataset <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
   filter(.$year == year_select) #If is just one year
  #filter(.$year %in% year_select) #If is several years at once 


months <- 201901:201912

patients_id_allMonths <- c()

#If two FDA approvd medications 

meds_to_study <- c("ARIPIPRAZOLE", "RISPERIDONE",SSRIs_meds)
inter_meds <- c("ARIPIPRAZOLE", "RISPERIDONE", SSRIs_meds)

#The meds joined 
meds_to_study_joined <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
  select(medication) %>% 
  unique %>% 
  unlist 

start.time <- Sys.time()

years<-2012:2021

patients_source<- c()
cont <- 1

for(j in 1:length(months)){
  #Declare initial vectors
  if(months[j] < max(months)){
   
    medication_source_c<- c()
    medication_target_c<-c()
    
    #Extract only the patients that appears with a claim in the source
    #To reduce time consumption
    
    patients_id <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>%
      filter(month_id == months[j]) %>%
      select(pat_id, medication) %>%
      unique %>%
      filter(!pat_id %in% patients_beforeObsPeriod$pat_id) %>%
      group_by(pat_id) %>%
      filter(all(medication %in% meds_to_study)) %>% 
      summarise(n = n_distinct(medication), .groups = 'drop') %>%
      filter(n == 1) %>%
      select(pat_id) %>%
      unlist
    
    assign(paste0("patientsList",cont),patients_id)

    
    if(months[j] > min(months)){
      patAndMed_year <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
        filter(month_id == months[j-1]) %>% 
        select(pat_id, medication) %>%
        unique %>% 
        group_by(pat_id) %>% 
        filter(any(medication %in% meds_to_study)) %>% 
        ungroup() %>% 
        group_by(pat_id) %>% 
        count %>% 
        ungroup() %>% 
        filter(n > 1)
      
      patients_id <- patients_id[! patients_id %in% patAndMed_year$pat_id]
      
      assign(paste0("patientsList",cont),patients_id)

    }
   
    patients_id_allMonths <- unique(c(patients_id_allMonths,patients_id))
    
    
      for(i in patients_id_allMonths){
        #Go to each patient and see what of those only have one prescription 
        #or multiple prescription for the same drug medication (drug class)
        
        #In the source
        medication_source <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
          filter(month_id == months[j] & 
                   .$pat_id == i) %>% 
          select(medication) %>% unique
        
        
        #And in the target 
        medication_target <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
          filter(month_id == months[j+1] &  
                   .$pat_id == i) %>% 
          select(medication) %>% unique
        
        
        #Verify that the prescriptions only are from the same medication
        #And extract the medication
        if(nrow(medication_source) == 1 & nrow(medication_target) == 1 &
           (medication_source %in% meds_to_study_joined &
            medication_target %in% meds_to_study_joined)){
          
          patients_source<-c(patients_source,i)
          medication_source_c <-c(medication_source_c,medication_source)
          medication_target_c <-c(medication_target_c,medication_target)
        
        }
      }
      
    
    # and count it 
    drugs_patterns <- data.frame(drugSource = unlist(medication_source_c),
                                 drugTarget = unlist(medication_target_c)) %>%
      mutate(drugTarget = ifelse(drugTarget %in% inter_meds[1:2], 
                                 drugTarget,
                                 ifelse(drugTarget %in%
                                          inter_meds[2:length(inter_meds)],
                                        "Selective serotonin reuptake inhibitors", 
                                        "OTHER")), 
             drugSource = ifelse(drugSource %in% inter_meds[1:2], 
                                 drugSource,
                                 ifelse(drugSource %in%
                                          inter_meds[2:length(inter_meds)],
                                        "Selective serotonin reuptake inhibitors", 
                                        "OTHER"))) %>% 
      mutate(drugTarget = paste(drugTarget,months[j+1],sep="_")) %>%
      mutate(drugSource = paste(drugSource,months[j], sep="_")) %>%
      group_by(drugSource, drugTarget) %>%
      count %>% 
      mutate(medication = substr(drugSource, 1, nchar(drugSource)-5))
  
    
    assign(paste0("df_drugsYear",cont),drugs_patterns)
    cont = cont + 1
     
  }
 
}
#Obtain a list of each of the dataframes 
df_names <- paste0("df_drugsYear",1:(cont-1))
df_list <- mget(df_names, inherits =  FALSE)

#For all the months
all_patterns_monthly_notAggregate_df <- bind_rows(df_list)


end.time <- Sys.time()
```

## To calculate rate of change

Aggregated by drug class, we calculate the average proportion of patients who shifted to other medications.

Monthly.


```r
AllThePatientsShifting_monthly <- all_patterns_monthly_df %>%
  mutate(namedrugSource = substr(drugSource, 
                                 1, 
                                 nchar(drugSource) - 7), 
         namedrugTarget = substr(drugTarget, 
                                 1, 
                                 nchar(drugTarget) - 7)) %>%
  filter(namedrugSource != namedrugTarget) %>% 
    group_by(drugSource) %>% 
    summarise(total_change = sum(n)) %>% 
  ungroup()

#Sum all the patients per medication 
AllThePatientsStaying_monthly <- all_patterns_monthly_df %>%
    group_by(drugSource) %>% 
    summarise(total = sum(n)) %>% 
  ungroup()

#Left join to calculate the change 
rates_Change_monthly <- AllThePatientsStaying_monthly %>% 
  left_join(AllThePatientsShifting_monthly, by = "drugSource") %>% 
  group_by(drugSource) %>% 
  mutate(rate_change = total_change/total) %>% 
  ungroup() %>% 
  mutate(namedrugSource = substr(drugSource, 
                                 1, 
                                 nchar(drugSource) - 7)) %>% 
  group_by(namedrugSource) %>% 
  summarise(rate_change_prop = sum(rate_change)/11) %>% 
  ungroup()
```

Yearly.


```r
AllThePatientsShifting_yearly <- all_patterns_years_df %>%
  mutate(namedrugSource = substr(drugSource, 
                                 1, 
                                 nchar(drugSource) - 5), 
         namedrugTarget = substr(drugTarget, 
                                 1, 
                                 nchar(drugTarget) - 5)) %>%
  filter(namedrugSource != namedrugTarget) %>% 
    group_by(drugSource) %>% 
    summarise(total_change = sum(n)) %>% 
  ungroup()

#Sum all the patients per medication 
AllThePatientsStaying_yearly <- all_patterns_years_df %>%
    group_by(drugSource) %>% 
    summarise(total = sum(n)) %>% 
  ungroup()

#Left join to calculate the change 
rates_Change_yearly <- AllThePatientsStaying_yearly %>% 
  left_join(AllThePatientsShifting_yearly, by = "drugSource") %>% 
  mutate(total_change = ifelse(is.na(total_change), 0, total_change)) %>% 
  group_by(drugSource) %>% 
  mutate(rate_change = total_change/total) %>% 
  ungroup() %>% 
  mutate(namedrugSource = substr(drugSource, 
                                 1, 
                                 nchar(drugSource) - 5)) %>% 
  group_by(namedrugSource) %>% 
  summarise(rate_change_prop = sum(rate_change)/11) %>% 
  ungroup()
```

To calculate the average proportion by medications (aripiprazole and risperidone) - yearly.


```r
AllThePatientsShifting_yearly <- all_patterns_years_notAggregate_df %>%
  mutate(namedrugSource = substr(drugSource, 
                                 1, 
                                 nchar(drugSource) - 5), 
         namedrugTarget = substr(drugTarget, 
                                 1, 
                                 nchar(drugTarget) - 5))  %>% 
  filter(!(namedrugSource == "ARIPIPRAZOLE" & 
            namedrugTarget == "RISPERIDONE") &  
           !(namedrugSource == "RISPERIDONE" & 
            namedrugTarget == "ARIPIPRAZOLE")) %>% 
  filter(namedrugSource != namedrugTarget) %>% 
    group_by(drugSource) %>% 
    summarise(total_change = sum(n)) %>% 
  ungroup() %>% 
  mutate(namedrugSource_med = substr(drugSource, 
                                 1, 
                                 nchar(drugSource) - 5),
         namedrugSource = drugSource,
         year_med = substr(drugSource,
                           nchar(drugSource) - 4, 
                           nchar(drugSource)),
         drugSource = ifelse(namedrugSource_med %in% c("ARIPIPRAZOLE",
                                                       "RISPERIDONE"), 
                             paste0("Atypical antipsychotics", 
                                    year_med), 
                             ifelse(namedrugSource_med  == "Selective serotonin reuptake inhibitors", 
                                    paste0("Selective serotonin reuptake inhibitors",
                                           year_med), paste0("OTHER",year_med))
                              )) %>% 
  select(-year_med)

#Sum all the patients per medication 
AllThePatientsStaying_yearly <- all_patterns_years_df %>%
    group_by(drugSource) %>% 
    summarise(total = sum(n)) %>% 
  ungroup()

#Left join to calculate the change 
rates_Change_yearly <- AllThePatientsStaying_yearly %>% 
  left_join(AllThePatientsShifting_yearly, by = "drugSource") %>% 
  mutate(total_change = ifelse(is.na(total_change), 0, total_change)) %>% 
  group_by(namedrugSource) %>% 
  mutate(rate_change = total_change/total) %>% 
  ungroup() %>% 
  group_by(namedrugSource_med) %>% 
  summarise(rate_change_prop = sum(rate_change)/11) %>% 
  ungroup()
```

To calculate the average proportion by medications (aripiprazole and risperidone) - monthly


```r
AllThePatientsShifting_monthly <- all_patterns_monthly_notAggregate_df %>%
  mutate(namedrugSource = substr(drugSource, 
                                 1, 
                                 nchar(drugSource) - 7), 
         namedrugTarget = substr(drugTarget, 
                                 1, 
                                 nchar(drugTarget) - 7)) %>%
  filter(!(namedrugSource == "ARIPIPRAZOLE" & 
            namedrugTarget == "RISPERIDONE") &  
           !(namedrugSource == "RISPERIDONE" & 
            namedrugTarget == "ARIPIPRAZOLE")) %>%
  filter(namedrugSource != namedrugTarget) %>% 
    group_by(drugSource) %>% 
    summarise(total_change = sum(n)) %>% 
  ungroup() %>% 
  mutate(namedrugSource_med = substr(drugSource, 
                                 1, 
                                 nchar(drugSource) - 7),
         namedrugSource = drugSource,
         year_med = substr(drugSource,
                           nchar(drugSource) - 6, 
                           nchar(drugSource)),
         drugSource = ifelse(namedrugSource_med %in% c("ARIPIPRAZOLE",
                                                       "RISPERIDONE"), 
                             paste0("Atypical antipsychotics", 
                                    year_med), 
                             ifelse(namedrugSource_med  == "Selective serotonin reuptake inhibitors", 
                                    paste0("Selective serotonin reuptake inhibitors",
                                           year_med), paste0("OTHER",year_med))
                              )) %>% 
  select(-year_med)

#Sum all the patients per medication 
AllThePatientsStaying_monthly <- all_patterns_monthly_df %>%
    group_by(drugSource) %>% 
    summarise(total = sum(n)) %>% 
  ungroup()

#Left join to calculate the change 
rates_Change_monthly <- AllThePatientsStaying_monthly %>% 
  left_join(AllThePatientsShifting_monthly, by = "drugSource") %>%
  mutate(total_change = ifelse(is.na(total_change), 0, total_change)) %>%
  group_by(namedrugSource) %>% 
  mutate(rate_change = total_change/total) %>% 
  ungroup() %>% 
  group_by(namedrugSource_med) %>% 
  summarise(rate_change_prop = sum(rate_change)/11) %>% 
  ungroup()
```





## To generate table - descriptive statistics 


Separating the patients with at least one prescription of any of the selected medications


```r
claims_prescrip_RL <- claims_ASD_wNDC_csv_onlyPrescripClass %>%
  filter(!pat_id %in% patients_beforeObsPeriod) %>%
  mutate(year_claim = as.numeric(substr(month_id, 1,4)))  %>% 
  group_by(year_claim, pat_id) %>% 
  filter(Drug_class == "Selective serotonin reuptake inhibitors" |
           
           medication %in% c("ARIPIPRAZOLE", "RISPERIDONE")) %>% 
  ungroup()
```



```r
claims_prescrip_table <- claims_prescrip_RL %>% 
  mutate(year_claim = as.numeric(substr(month_id, 1,4))) %>% 
  select(pat_id, medication, der_sex) %>% 
  unique %>% 
  group_by(pat_id) %>% 
  mutate(name_med = ifelse(all(medication %in% c("ARIPIPRAZOLE", "RISPERIDONE")),"FDA-approved only",ifelse(all(medication %in% SSRIs_meds), "SSRIs only", ifelse(any(medication %in% SSRIs_meds) &
                                    any(medication %in%
                                          c("ARIPIPRAZOLE",
                                            "RISPERIDONE")),
                                  "Both", "NA")))) %>% 
  ungroup() %>% 
  select(-medication) %>% 
  unique 


allPatients <- unique(claims_prescrip_table$pat_id)

#Diagnosis 
SecondDiagnosis_age <- claims_diagnosis %>% 
  filter(pat_id %in% allPatients) %>% 
  arrange(from_dt, pat_id) %>%  
  group_by(pat_id) %>% 
  slice(1) %>% 
  ungroup() %>% 
  mutate(year = as.numeric(substr(from_dt, 1, 4)), 
         age_1Diag = year - der_yob) %>% 
  select(pat_id, age_1Diag)

claims_prescrip_table <- claims_prescrip_table %>% 
  left_join(SecondDiagnosis_age) %>% 
  mutate(FirstDiagn_Age = case_when(
    age_1Diag >= 2 & age_1Diag <= 5 ~ "2 to 5", 
    age_1Diag >= 6 & age_1Diag <= 11 ~ "6 to 11", 
    age_1Diag >= 12 & age_1Diag <= 17 ~ "12 to 17",
    age_1Diag >= 18 & age_1Diag <= 26  ~ "18 to 26", 
    TRUE ~ "Other"
  ))
```

```
## Joining with `by = join_by(pat_id)`
```

```r
library(tableone)
```

```
## Warning: package 'tableone' was built under R version 4.3.3
```

```r
vars <- c("der_sex", "FirstDiagn_Age")
table <- CreateTableOne(vars = vars, strata = "name_med", data = claims_prescrip_table, factorVars = c("der_sex", "FirstDiagn_Age"))

print(table, showAllLevels = TRUE, quote = FALSE, noSpaces = TRUE)
```

```
##                     Stratified by name_med
##                      level    Both        FDA-approved only SSRIs only  p      test
##   n                           3927        2662              9387                   
##   der_sex (%)        F        940 (23.9)  506 (19.0)        2725 (29.0) <0.001     
##                      M        2987 (76.1) 2156 (81.0)       6662 (71.0)            
##   FirstDiagn_Age (%) 12 to 17 1476 (37.6) 847 (31.8)        3705 (39.5) <0.001     
##                      18 to 26 790 (20.1)  627 (23.6)        2362 (25.2)            
##                      2 to 5   306 (7.8)   280 (10.5)        550 (5.9)              
##                      6 to 11  1355 (34.5) 908 (34.1)        2770 (29.5)
```

For the calendar year: 


```r
claims_prescrip_table_year <- claims_prescrip_RL %>% 
  mutate(year_claim = as.numeric(substr(month_id, 1,4))) %>% 
  select(pat_id, medication, der_sex, year_claim) %>% 
  unique %>% 
  group_by(pat_id, year_claim) %>% 
  mutate(name_med = ifelse(all(medication %in% c("ARIPIPRAZOLE", "RISPERIDONE")),"FDA-approved only",ifelse(all(medication %in% SSRIs_meds), "SSRIs only", ifelse(any(medication %in% SSRIs_meds) &
                                    any(medication %in%
                                          c("ARIPIPRAZOLE",
                                            "RISPERIDONE")),
                                  "Both", "NA")))) %>% 
  ungroup() %>%
  select(-medication) %>%
  unique 

vars <- c("year_claim") 
table_2 <- CreateTableOne(vars = vars, strata = "name_med", data = claims_prescrip_table_year, factorVars = c("year_claim"))


print(table_2, showAllLevels = TRUE, quote = FALSE, noSpaces = TRUE)
```

```
##                 Stratified by name_med
##                  level Both        FDA-approved only SSRIs only  p      test
##   n                    7123        9468              28434                  
##   year_claim (%) 2012  276 (3.9)   507 (5.4)         924 (3.2)   <0.001     
##                  2013  369 (5.2)   610 (6.4)         1313 (4.6)             
##                  2014  421 (5.9)   599 (6.3)         1577 (5.5)             
##                  2015  475 (6.7)   699 (7.4)         1797 (6.3)             
##                  2016  511 (7.2)   795 (8.4)         2313 (8.1)             
##                  2017  668 (9.4)   953 (10.1)        2998 (10.5)            
##                  2018  1019 (14.3) 1286 (13.6)       3638 (12.8)            
##                  2019  1250 (17.5) 1541 (16.3)       4678 (16.5)            
##                  2020  1059 (14.9) 1261 (13.3)       4518 (15.9)            
##                  2021  1075 (15.1) 1217 (12.9)       4678 (16.5)
```

For all: 

```r
table_3 <- CreateTableOne(vars = vars, data = claims_prescrip_table, factorVars = c("der_sex", "FirstDiagn_Age"))
```

```
## Warning in ModuleReturnVarsExist(vars, data): The data frame does not have: year_claim Dropped
```

```
## Error in ModuleStopIfNoVarsLeft(vars): No valid variables.
```

```r
print(table_3, showAllLevels = TRUE, quote = FALSE, noSpaces = TRUE)
```

```
## Error in eval(expr, envir, enclos): object 'table_3' not found
```

```r
table_4 <- CreateTableOne(vars = vars, data = claims_prescrip_table_year, factorVars = c("year_claim"))
print(table_4, showAllLevels = TRUE, quote = FALSE, noSpaces = TRUE)
```

```
##                 
##                  level Overall    
##   n                    45025      
##   year_claim (%) 2012  1707 (3.8) 
##                  2013  2292 (5.1) 
##                  2014  2597 (5.8) 
##                  2015  2971 (6.6) 
##                  2016  3619 (8.0) 
##                  2017  4619 (10.3)
##                  2018  5943 (13.2)
##                  2019  7469 (16.6)
##                  2020  6838 (15.2)
##                  2021  6970 (15.5)
```


