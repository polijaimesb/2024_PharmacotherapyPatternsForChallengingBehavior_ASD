---
title: "Medication patterns"
author: "Paula Jaimes"
date: "2024-04-22"
output: html_document
---

This script contains the step by step of the identification of patterns of the two FDA-approved medication and SSRIs. We used reimbursement claims data from individuals that have a prescription of those medications. The file used here is already cleaned and pre-processed.



To verify that the patients we are going to include later do not have a prescription for the two FDA-approved medications or SSRIs. For that, we used the entire claims data with all the years (2006 - 2022), and extract the patient ID, the medication prescribed and the year of the prescription.



Then, we identify the patients with at least one prescription of aripiprazole, risperidone or medications part of the SSRIs.



For calculations.



## Verifying usage of just the two drug classes

It is necessary to identify the patients using just the two drug classes selected, to then determine the individual-level shifts.

First, it is necessary to identify which of the patients receiving pharmacotherapy were using just the two drug classes.


```r
#Study period 
years = 2012:2021

#With only the drug classes 
drug_classes <- c("Atypical antipsychotics","Selective serotonin reuptake inhibitors")

DrugClassByYearAndPatient <- claims_ASD_wNDC_csv_onlyPrescripClass %>% 
  mutate(year_claim = as.numeric(substr(month_id, 1,4))) %>% 
  select(year_claim, pat_id, Drug_class) %>% 
  unique %>% 
  group_by(pat_id, year_claim) %>% 
  filter(all(Drug_class %in% drug_classes)) %>% 
  ungroup() %>% 
  arrange(year_claim, pat_id)

print(head(DrugClassByYearAndPatient,10))
```

```
## # A tibble: 10 x 3
##    year_claim pat_id           Drug_class                             
##         <dbl> <chr>            <chr>                                  
##  1       2012 01mv9uizam4ankr8 Atypical antipsychotics                
##  2       2012 01mv9uizam4ankr8 Selective serotonin reuptake inhibitors
##  3       2012 01o30i9q7sx9gjrr Atypical antipsychotics                
##  4       2012 02wo7l3qg9g3nsvi Selective serotonin reuptake inhibitors
##  5       2012 03y3d4892mbmwdz1 Selective serotonin reuptake inhibitors
##  6       2012 05rsatm2ysd12g0f Selective serotonin reuptake inhibitors
##  7       2012 09aiclabt9erw6ha Selective serotonin reuptake inhibitors
##  8       2012 09uhrlk471a4v315 Selective serotonin reuptake inhibitors
##  9       2012 0ccjkr5p06tvh3i8 Selective serotonin reuptake inhibitors
## 10       2012 0ccjkr5p06tvh3i8 Atypical antipsychotics
```

We excluded the other patients because they were using other drug classes.


```r
print(head(claims_ASD_wNDC_csv_onlyPrescripClass %>% 
  mutate(year_claim = as.numeric(substr(month_id, 1,4))) %>% 
  select(year_claim, pat_id, Drug_class) %>% 
  unique %>% 
  group_by(pat_id, year_claim) %>% 
  filter(!all(Drug_class %in% drug_classes)) %>% 
  ungroup() %>% 
  arrange(year_claim, pat_id), 20))
```

```
## # A tibble: 20 x 3
##    year_claim pat_id           Drug_class                             
##         <dbl> <chr>            <chr>                                  
##  1       2012 01txbn80hd3o5b8e CNS stimulants                         
##  2       2012 01txbn80hd3o5b8e Selective serotonin reuptake inhibitors
##  3       2012 04q4zkoyzz2xxkqw Selective serotonin reuptake inhibitors
##  4       2012 04q4zkoyzz2xxkqw Atypical antipsychotics                
##  5       2012 04q4zkoyzz2xxkqw CNS stimulants                         
##  6       2012 05fnv2gj5kpb1kco CNS stimulants                         
##  7       2012 05llch8sxb5t6cig Antiadrenergic agents centrally acting 
##  8       2012 05llch8sxb5t6cig Selective serotonin reuptake inhibitors
##  9       2012 05llch8sxb5t6cig Atypical antipsychotics                
## 10       2012 06m00aano22tq4cy CNS stimulants                         
## 11       2012 06ytpim5qpu0cqxg CNS stimulants                         
## 12       2012 06ytpim5qpu0cqxg Antiadrenergic agents centrally acting 
## 13       2012 0920dmqlbvo2xtz3 CNS stimulants                         
## 14       2012 093jegl9xqccgltx Benzodiazepines                        
## 15       2012 09h4t9t1h2d4vi28 Antiadrenergic agents centrally acting 
## 16       2012 09pq1ur7rbarfbj6 Selective serotonin reuptake inhibitors
## 17       2012 09pq1ur7rbarfbj6 Antiadrenergic agents centrally acting 
## 18       2012 09u9fcxk7xw4jfx8 Selective serotonin reuptake inhibitors
## 19       2012 09u9fcxk7xw4jfx8 CNS stimulants                         
## 20       2012 09xwpzv3seopy6i1 Antiadrenergic agents centrally acting
```

Then, select the patient IDs and the year were each of the patients just used the two drug classes. After that, extract the claims for those patients from the pharmacotherapy dataset.


```r
pat_id_ThreeDrugClass <- unlist(unique(DrugClassByYearAndPatient$pat_id))
year_threeDrugClasses <- unlist(unique(DrugClassByYearAndPatient$year_claim))

claims_ASD_wNDC_csv_onlyPrescripClass_RL<-claims_ASD_wNDC_csv_onlyPrescripClass %>%
  mutate(year_claim = as.numeric(substr(month_id, 1,4))) %>% 
  group_by(year_claim, pat_id) %>%
          filter(pat_id %in% pat_id_ThreeDrugClass & 
                   year_claim %in% year_threeDrugClasses) %>%
  ungroup() %>% 
  mutate(year = substr(month_id,1,4))

drug_classes <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
  filter(Drug_class %in% drug_classes) %>% 
  select(medication, Drug_class) %>% 
  unique 

gc()
```

```
##            used  (Mb) gc trigger   (Mb)   max used    (Mb)
## Ncells  4233328 226.1   13359349  713.5   16699186   891.9
## Vcells 98912052 754.7 1067100296 8141.4 1638838542 12503.4
```

```r
print(head(claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
             select(pat_id, year, Drug_class) %>% 
             unique, 10))
```

```
## # A tibble: 10 x 3
##    pat_id           year  Drug_class                             
##    <chr>            <chr> <chr>                                  
##  1 zoyrm1tsn3aa0brt 2015  Selective serotonin reuptake inhibitors
##  2 zoyrm1tsn3aa0brt 2018  Antiadrenergic agents centrally acting 
##  3 zoyrm1tsn3aa0brt 2017  Antiadrenergic agents centrally acting 
##  4 zoyrm1tsn3aa0brt 2012  Atypical antipsychotics                
##  5 zoyrm1tsn3aa0brt 2016  Selective serotonin reuptake inhibitors
##  6 zoyrm1tsn3aa0brt 2015  Antiadrenergic agents centrally acting 
##  7 zoyrm1tsn3aa0brt 2014  Selective serotonin reuptake inhibitors
##  8 zoyrm1tsn3aa0brt 2014  Atypical antipsychotics                
##  9 zoyrm1tsn3aa0brt 2012  Triazine anticonvulsants               
## 10 zoyrm1tsn3aa0brt 2017  Selective serotonin reuptake inhibitors
```

Although other drug classes were extracted too, those are going to be useful when identifying individual-level shifts.

And finally, to check that the patients selected are just taking the two drug classes. 


```r
checking_DrugClasses <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
  select(pat_id, medication, Drug_class, year) %>%
  unique 
```

Observing the patients, we verifying that all of them at some point just used the selected medication for one year, however, the other years they are using other medications. This is then verify when the sankey diagram is created, to just include the patients who used one of the selected medications and exclude the other. Because the analysis is made year by year, or month by month, if the patient then did not pass the filters, they will be excluded, maintaining the correct process of filtering. 

Taking as an example of this patient. `08bmzh1uy4ow5ad7`


```r
checking_DrugClasses %>% 
  filter(pat_id %in% "08bmzh1uy4ow5ad7") %>% 
  arrange(year) %>% 
  select(medication, Drug_class, year)
```

```
## # A tibble: 16 x 3
##    medication      Drug_class                              year 
##    <chr>           <chr>                                   <chr>
##  1 SERTRALINE      Selective serotonin reuptake inhibitors 2015 
##  2 SERTRALINE      Selective serotonin reuptake inhibitors 2016 
##  3 SERTRALINE      Selective serotonin reuptake inhibitors 2017 
##  4 FLUOXETINE      Selective serotonin reuptake inhibitors 2018 
##  5 SERTRALINE      Selective serotonin reuptake inhibitors 2018 
##  6 FLUOXETINE      Selective serotonin reuptake inhibitors 2019 
##  7 FLUVOXAMINE     Selective serotonin reuptake inhibitors 2019 
##  8 METHYLPHENIDATE CNS stimulants                          2019 
##  9 ARIPIPRAZOLE    Atypical antipsychotics                 2020 
## 10 CLOMIPRAMINE    Tricyclic antidepressants               2020 
## 11 METHYLPHENIDATE CNS stimulants                          2020 
## 12 SERTRALINE      Selective serotonin reuptake inhibitors 2020 
## 13 FLUOXETINE      Selective serotonin reuptake inhibitors 2020 
## 14 FLUVOXAMINE     Selective serotonin reuptake inhibitors 2020 
## 15 METHYLPHENIDATE CNS stimulants                          2021 
## 16 SERTRALINE      Selective serotonin reuptake inhibitors 2021
```
Although the patient received other medication in 2020, from 2015 to 2018 just received SSRIs, part of the research letter. 

Veryfying the same information in the entire claims: 


```r
claims_ASD_wNDC_csv_onlyPrescripClass %>% 
  mutate(year = as.numeric(substr(month_id, 1, 4))) %>% 
  filter(pat_id %in% "08bmzh1uy4ow5ad7") %>% 
  arrange(year) %>% 
  select(medication, Drug_class, year)
```

```
##          medication                              Drug_class year
##  1:      SERTRALINE Selective serotonin reuptake inhibitors 2015
##  2:      SERTRALINE Selective serotonin reuptake inhibitors 2015
##  3:      SERTRALINE Selective serotonin reuptake inhibitors 2016
##  4:      SERTRALINE Selective serotonin reuptake inhibitors 2016
##  5:      SERTRALINE Selective serotonin reuptake inhibitors 2016
##  6:      SERTRALINE Selective serotonin reuptake inhibitors 2016
##  7:      SERTRALINE Selective serotonin reuptake inhibitors 2016
##  8:      SERTRALINE Selective serotonin reuptake inhibitors 2017
##  9:      SERTRALINE Selective serotonin reuptake inhibitors 2017
## 10:      SERTRALINE Selective serotonin reuptake inhibitors 2017
## 11:      SERTRALINE Selective serotonin reuptake inhibitors 2017
## 12:      FLUOXETINE Selective serotonin reuptake inhibitors 2018
## 13:      SERTRALINE Selective serotonin reuptake inhibitors 2018
## 14:      SERTRALINE Selective serotonin reuptake inhibitors 2018
## 15:      SERTRALINE Selective serotonin reuptake inhibitors 2018
## 16:      FLUOXETINE Selective serotonin reuptake inhibitors 2018
## 17:      SERTRALINE Selective serotonin reuptake inhibitors 2018
## 18:      FLUOXETINE Selective serotonin reuptake inhibitors 2018
## 19:      FLUOXETINE Selective serotonin reuptake inhibitors 2018
## 20:      FLUOXETINE Selective serotonin reuptake inhibitors 2018
## 21:      SERTRALINE Selective serotonin reuptake inhibitors 2018
## 22:      FLUOXETINE Selective serotonin reuptake inhibitors 2019
## 23:     FLUVOXAMINE Selective serotonin reuptake inhibitors 2019
## 24:      FLUOXETINE Selective serotonin reuptake inhibitors 2019
## 25: METHYLPHENIDATE                          CNS stimulants 2019
## 26: METHYLPHENIDATE                          CNS stimulants 2019
## 27: METHYLPHENIDATE                          CNS stimulants 2019
## 28:      FLUOXETINE Selective serotonin reuptake inhibitors 2019
## 29: METHYLPHENIDATE                          CNS stimulants 2019
## 30: METHYLPHENIDATE                          CNS stimulants 2019
## 31:     FLUVOXAMINE Selective serotonin reuptake inhibitors 2019
## 32:     FLUVOXAMINE Selective serotonin reuptake inhibitors 2019
## 33:      FLUOXETINE Selective serotonin reuptake inhibitors 2019
## 34:    ARIPIPRAZOLE                 Atypical antipsychotics 2020
## 35:    CLOMIPRAMINE               Tricyclic antidepressants 2020
## 36: METHYLPHENIDATE                          CNS stimulants 2020
## 37: METHYLPHENIDATE                          CNS stimulants 2020
## 38:    ARIPIPRAZOLE                 Atypical antipsychotics 2020
## 39: METHYLPHENIDATE                          CNS stimulants 2020
## 40:      SERTRALINE Selective serotonin reuptake inhibitors 2020
## 41:    ARIPIPRAZOLE                 Atypical antipsychotics 2020
## 42:    CLOMIPRAMINE               Tricyclic antidepressants 2020
## 43: METHYLPHENIDATE                          CNS stimulants 2020
## 44: METHYLPHENIDATE                          CNS stimulants 2020
## 45: METHYLPHENIDATE                          CNS stimulants 2020
## 46: METHYLPHENIDATE                          CNS stimulants 2020
## 47:      SERTRALINE Selective serotonin reuptake inhibitors 2020
## 48: METHYLPHENIDATE                          CNS stimulants 2020
## 49: METHYLPHENIDATE                          CNS stimulants 2020
## 50:    ARIPIPRAZOLE                 Atypical antipsychotics 2020
## 51:    CLOMIPRAMINE               Tricyclic antidepressants 2020
## 52:      SERTRALINE Selective serotonin reuptake inhibitors 2020
## 53:      FLUOXETINE Selective serotonin reuptake inhibitors 2020
## 54:    ARIPIPRAZOLE                 Atypical antipsychotics 2020
## 55: METHYLPHENIDATE                          CNS stimulants 2020
## 56:    ARIPIPRAZOLE                 Atypical antipsychotics 2020
## 57:    ARIPIPRAZOLE                 Atypical antipsychotics 2020
## 58: METHYLPHENIDATE                          CNS stimulants 2020
## 59:      SERTRALINE Selective serotonin reuptake inhibitors 2020
## 60:    ARIPIPRAZOLE                 Atypical antipsychotics 2020
## 61: METHYLPHENIDATE                          CNS stimulants 2020
## 62:     FLUVOXAMINE Selective serotonin reuptake inhibitors 2020
## 63: METHYLPHENIDATE                          CNS stimulants 2020
## 64:    CLOMIPRAMINE               Tricyclic antidepressants 2020
## 65:    ARIPIPRAZOLE                 Atypical antipsychotics 2020
## 66: METHYLPHENIDATE                          CNS stimulants 2021
## 67: METHYLPHENIDATE                          CNS stimulants 2021
## 68: METHYLPHENIDATE                          CNS stimulants 2021
## 69: METHYLPHENIDATE                          CNS stimulants 2021
## 70: METHYLPHENIDATE                          CNS stimulants 2021
## 71:      SERTRALINE Selective serotonin reuptake inhibitors 2021
## 72: METHYLPHENIDATE                          CNS stimulants 2021
## 73: METHYLPHENIDATE                          CNS stimulants 2021
## 74: METHYLPHENIDATE                          CNS stimulants 2021
##          medication                              Drug_class year
```

The patient is correctly identified. 

## Sankey diagram construction aggregating by drug classes

### Yearly

The following script contains the construction of the sankey diagram and the aggregation by drug classes. This script contains several parts and filters.

First, identify the names of the medications for the first filter, where the patients with a single medication used year by year has to be any of the medications previously selected (SSRIs and two FDA approved medications).,


```r
SSRIs_meds <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
  select(medication, Drug_class) %>% 
  unique %>% 
  filter(Drug_class == "Selective serotonin reuptake inhibitors") %>% 
  select(medication) %>% 
  unlist

meds_to_study <- c("ARIPIPRAZOLE", "RISPERIDONE",SSRIs_meds)
inter_meds <- c("ARIPIPRAZOLE", "RISPERIDONE", SSRIs_meds)

#The meds joined 
meds_to_study_joined <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
  select(medication) %>% 
  unique %>% 
  unlist
```

The following `for statenment` has several filters. First, we identify the patients with one medication usage per year, verify if those patients did not have a prescription of the selected medications before 2012 and that the medications used are part of the SSRIs or the two FDA-approved medications.

Because we are including newly prescribed users per year, we have to verify if the list of patients ID per year identified are indeed new users. We check if the patients did not have a prescription of the selected medications the year before.

The patients including are then follow over time, and, if they pass all the filters, are including each year.

Finally, we aggregate by drug class, changing the name of the medication by its drug class. The patients that shifted to a medication different from the selected medications, are included too, and the medication is changed by a new classification called "Other".


```r
start.time <- Sys.time()
patients_id_allYears<-c()

years<-2012:2021

patients_source<- c()
cont <- 1

for(j in 1:length(years)){
  #Declare initial vectors
  if(years[j] < max(years)){
   
    medication_source_c<- c()
    medication_target_c<-c()
    
    # patients_id <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
    #   filter(year == years[j]) %>% 
    #   select(pat_id, medication) %>% 
    #   unique %>%
    #   filter(!pat_id %in% patients_beforeObsPeriod) %>% 
    #   group_by(pat_id) %>% 
    #   count %>% 
    #   ungroup() %>% 
    #   filter(n == 1) %>% 
    #   select(pat_id) %>% 
    #   left_join(select(claims_ASD_wNDC_csv_onlyPrescripClass_RL, 
    #                pat_id, 
    #                medication)) %>%
    #   filter(medication %in% meds_to_study) %>% 
    #   select(pat_id) %>% 
    #   unlist 
    
  patients_id <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>%
      filter(year == years[j]) %>%
      select(pat_id, medication) %>%
      unique %>%
      filter(!pat_id %in% patients_beforeObsPeriod$pat_id) %>%
      group_by(pat_id) %>%
      filter(all(medication %in% meds_to_study)) %>% 
      summarise(n = n_distinct(medication), .groups = 'drop') %>%
      filter(n == 1) %>%
      select(pat_id) %>%
      unlist
    
    assign(paste0("patientsList",cont),patients_id)

    
    if(years[j] > 2012){
      patAndMed_year <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
        filter(year == years[j-1]) %>% 
        select(pat_id, medication) %>%
        unique %>% 
        group_by(pat_id) %>% 
        filter(any(medication %in% meds_to_study)) %>% 
        ungroup() %>% 
        group_by(pat_id) %>% 
        count %>% 
        ungroup() %>% 
        filter(n > 1)
      
      patients_id <- patients_id[! patients_id %in% patAndMed_year$pat_id]
      
      assign(paste0("patientsList",cont),patients_id)

    }
   
    patients_id_allYears <- unique(c(patients_id_allYears,patients_id))
    
    
      for(i in patients_id_allYears){
        #Go to each patient and see what of those only have one prescription 
        #or multiple prescription for the same drug medication (drug class)
        
        #In the source
        medication_source <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
          filter(year == years[j] & 
                   .$pat_id == i) %>% 
          select(medication) %>% unique
        
        
        #And in the target 
        medication_target <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
          filter(year == years[j+1] &  
                   .$pat_id == i) %>% 
          select(medication) %>% unique
        
        
        #Verify that the prescriptions only are from the same medication
        #And extract the medication
        if(nrow(medication_source) == 1 & nrow(medication_target) == 1 &
           (medication_source %in% meds_to_study_joined &
            medication_target %in% meds_to_study_joined)){
          
          patients_source<-c(patients_source,i)
          medication_source_c <-c(medication_source_c,medication_source)
          medication_target_c <-c(medication_target_c,medication_target)
        
        }
      }
      
    
    # and count it 
    drugs_patterns <- data.frame(drugSource = unlist(medication_source_c),
                                 drugTarget = unlist(medication_target_c)) %>%
      mutate(drugTarget = ifelse(drugTarget %in% inter_meds[1:2], 
                                 "Atypical antipsychotics",
                                 ifelse(drugTarget %in% inter_meds[2:length(inter_meds)],
                                        "Selective serotonin reuptake inhibitors", 
                                        "OTHER")), 
             drugSource = ifelse(drugSource %in% inter_meds[1:2], 
                                 "Atypical antipsychotics",
                                 ifelse(drugSource %in% inter_meds[2:length(inter_meds)],
                                        "Selective serotonin reuptake inhibitors", 
                                        "OTHER"))) %>% 
      mutate(drugTarget = paste(drugTarget,years[j+1],sep="_")) %>%
      mutate(drugSource = paste(drugSource,years[j], sep="_")) %>%
      group_by(drugSource, drugTarget) %>%
      count %>% 
      mutate(medication = substr(drugSource, 1, nchar(drugSource)-5))
  
    
    assign(paste0("df_drugsYear",cont),drugs_patterns)
    cont = cont + 1
     
  }
 
}
#Obtain a list of each of the dataframes 
df_names <- paste0("df_drugsYear",1:(cont-1))
df_list <- mget(df_names, inherits =  FALSE)

#For all the months
all_patterns_years_df <- bind_rows(df_list)


end.time <- Sys.time()
```

The time taken by the sankey diagram generation.


```r
end.time - start.time
```

```
## Time difference of 8.867408 mins
```

Now, for each year, we are going to check a patient randomly to see if the inclusion and exclusion criteria is working accordingly.


```r
CheckPatientID_SD <- function(ListIDs, year_select){
  random_patient <-ListIDs[round(runif(1, 
                                           min = 1, 
                                           max = length(ListIDs)))]
  
  print(random_patient)

  print(year_select)
  print(claims_ASD_wNDC_csv_onlyPrescripClass %>%
          filter(pat_id == random_patient) %>%
          mutate(year = as.numeric(substr(month_id, 1, 4))) %>%
          filter(year == year_select) %>%
          select(pat_id,
                 year,
                 medication,
                 Drug_class,
                 dayssup) %>%
          arrange(year))
}

#2012
CheckPatientID_SD(patientsList1, 2012)
```

```
##           pat_id20 
## "2u28hbp1h2d4vi28" 
## [1] 2012
##              pat_id year  medication              Drug_class dayssup
## 1: 2u28hbp1h2d4vi28 2012 RISPERIDONE Atypical antipsychotics      30
```

```r
#2013
CheckPatientID_SD(patientsList2, 2013)
```

```
##          pat_id493 
## "v9cxavc38kkj0yyo" 
## [1] 2013
##              pat_id year   medication              Drug_class dayssup
## 1: v9cxavc38kkj0yyo 2013 ARIPIPRAZOLE Atypical antipsychotics      30
## 2: v9cxavc38kkj0yyo 2013 ARIPIPRAZOLE Atypical antipsychotics      30
## 3: v9cxavc38kkj0yyo 2013 ARIPIPRAZOLE Atypical antipsychotics      30
## 4: v9cxavc38kkj0yyo 2013 ARIPIPRAZOLE Atypical antipsychotics      30
## 5: v9cxavc38kkj0yyo 2013 ARIPIPRAZOLE Atypical antipsychotics      30
## 6: v9cxavc38kkj0yyo 2013 ARIPIPRAZOLE Atypical antipsychotics      30
```

```r
#2014
CheckPatientID_SD(patientsList3, 2014)
```

```
##          pat_id495 
## "ozsqbl6q56wxkbjc" 
## [1] 2014
##              pat_id year   medication                              Drug_class dayssup
## 1: ozsqbl6q56wxkbjc 2014 ESCITALOPRAM Selective serotonin reuptake inhibitors      30
```

```r
#2015
CheckPatientID_SD(patientsList4, 2015)
```

```
##           pat_id83 
## "3k0yeeh5s97msond" 
## [1] 2015
##              pat_id year  medication              Drug_class dayssup
## 1: 3k0yeeh5s97msond 2015 RISPERIDONE Atypical antipsychotics      30
```

```r
#2016
CheckPatientID_SD(patientsList5, 2016)
```

```
##          pat_id945 
## "s64gq4wcbvj61xu3" 
## [1] 2016
##              pat_id year medication                              Drug_class dayssup
## 1: s64gq4wcbvj61xu3 2016 FLUOXETINE Selective serotonin reuptake inhibitors      30
```

```r
#2017
CheckPatientID_SD(patientsList6, 2017)
```

```
##          pat_id634 
## "gc3t086sm8dw70qv" 
## [1] 2017
##              pat_id year  medication                              Drug_class dayssup
## 1: gc3t086sm8dw70qv 2017 FLUVOXAMINE Selective serotonin reuptake inhibitors      30
```

```r
#2018
CheckPatientID_SD(patientsList7, 2018)
```

```
##           pat_id37 
## "0qb8k4cur1ybeh9p" 
## [1] 2018
##              pat_id year medication                              Drug_class dayssup
## 1: 0qb8k4cur1ybeh9p 2018 FLUOXETINE Selective serotonin reuptake inhibitors      30
```

```r
#2019
CheckPatientID_SD(patientsList8, 2019)
```

```
##          pat_id757 
## "dm83590skgmpyuyi" 
## [1] 2019
##              pat_id year medication                              Drug_class dayssup
## 1: dm83590skgmpyuyi 2019 SERTRALINE Selective serotonin reuptake inhibitors      90
## 2: dm83590skgmpyuyi 2019 SERTRALINE Selective serotonin reuptake inhibitors      90
```

```r
#2020
CheckPatientID_SD(patientsList9, 2020)
```

```
##          pat_id408 
## "7kidht58k5w2mm0u" 
## [1] 2020
##              pat_id year  medication              Drug_class dayssup
## 1: 7kidht58k5w2mm0u 2020 RISPERIDONE Atypical antipsychotics      30
## 2: 7kidht58k5w2mm0u 2020 RISPERIDONE Atypical antipsychotics      30
## 3: 7kidht58k5w2mm0u 2020 RISPERIDONE Atypical antipsychotics      30
```

As you can see, an error was found in the first table. The patient randomly selected had multiple medications instead of just one. The following code was changed.


```r
patients_id <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>%
  filter(year == years[j]) %>%
  select(pat_id, medication) %>%
  unique %>%
  filter((medication %in% meds_to_study) &
           !pat_id %in% patients_beforeObsPeriod) %>%
  group_by(pat_id) %>%
  count %>%
  ungroup() %>%
  filter(.$n == 1) %>%
  select(pat_id) %>%
  unlist
```

Checking again. The patient is not part of 2012 anymore.


```r
patientsList1[patientsList1 == "avhfka25q8polfce"]
```

```
## named character(0)
```

Checkin all the years randomly.


```r
#2012
CheckPatientID_SD(patientsList1, 2012)
```

```
##           pat_id20 
## "2u28hbp1h2d4vi28" 
## [1] 2012
##              pat_id year  medication              Drug_class dayssup
## 1: 2u28hbp1h2d4vi28 2012 RISPERIDONE Atypical antipsychotics      30
```

```r
#2013
CheckPatientID_SD(patientsList2, 2013)
```

```
##          pat_id423 
## "qu10sc9i3wldmjuk" 
## [1] 2013
##              pat_id year medication                              Drug_class dayssup
## 1: qu10sc9i3wldmjuk 2013 FLUOXETINE Selective serotonin reuptake inhibitors      60
## 2: qu10sc9i3wldmjuk 2013 FLUOXETINE Selective serotonin reuptake inhibitors      60
## 3: qu10sc9i3wldmjuk 2013 FLUOXETINE Selective serotonin reuptake inhibitors      60
```

```r
#2014
CheckPatientID_SD(patientsList3, 2014)
```

```
##          pat_id263 
## "bb0fjq4flud59lqc" 
## [1] 2014
##              pat_id year medication                              Drug_class dayssup
## 1: bb0fjq4flud59lqc 2014 FLUOXETINE Selective serotonin reuptake inhibitors      90
## 2: bb0fjq4flud59lqc 2014 FLUOXETINE Selective serotonin reuptake inhibitors      30
## 3: bb0fjq4flud59lqc 2014 FLUOXETINE Selective serotonin reuptake inhibitors      30
```

```r
#2015
CheckPatientID_SD(patientsList4, 2015)
```

```
##          pat_id124 
## "59wkx2j9niit4gc8" 
## [1] 2015
##              pat_id year  medication              Drug_class dayssup
## 1: 59wkx2j9niit4gc8 2015 RISPERIDONE Atypical antipsychotics      30
## 2: 59wkx2j9niit4gc8 2015 RISPERIDONE Atypical antipsychotics      30
```

```r
#2016
CheckPatientID_SD(patientsList5, 2016)
```

```
##            pat_id4 
## "01w9meaz4radls0r" 
## [1] 2016
##               pat_id year   medication                              Drug_class dayssup
##  1: 01w9meaz4radls0r 2016 ESCITALOPRAM Selective serotonin reuptake inhibitors      30
##  2: 01w9meaz4radls0r 2016 ESCITALOPRAM Selective serotonin reuptake inhibitors      30
##  3: 01w9meaz4radls0r 2016 ESCITALOPRAM Selective serotonin reuptake inhibitors      30
##  4: 01w9meaz4radls0r 2016 ESCITALOPRAM Selective serotonin reuptake inhibitors      30
##  5: 01w9meaz4radls0r 2016 ESCITALOPRAM Selective serotonin reuptake inhibitors      30
##  6: 01w9meaz4radls0r 2016 ESCITALOPRAM Selective serotonin reuptake inhibitors      30
##  7: 01w9meaz4radls0r 2016 ESCITALOPRAM Selective serotonin reuptake inhibitors      30
##  8: 01w9meaz4radls0r 2016 ESCITALOPRAM Selective serotonin reuptake inhibitors      30
##  9: 01w9meaz4radls0r 2016 ESCITALOPRAM Selective serotonin reuptake inhibitors      30
## 10: 01w9meaz4radls0r 2016 ESCITALOPRAM Selective serotonin reuptake inhibitors      30
## 11: 01w9meaz4radls0r 2016 ESCITALOPRAM Selective serotonin reuptake inhibitors      30
## 12: 01w9meaz4radls0r 2016 ESCITALOPRAM Selective serotonin reuptake inhibitors      30
```

```r
#2017
CheckPatientID_SD(patientsList6, 2017)
```

```
##         pat_id1109 
## "stk3d77zaux5s8ol" 
## [1] 2017
##              pat_id year medication                              Drug_class dayssup
## 1: stk3d77zaux5s8ol 2017 FLUOXETINE Selective serotonin reuptake inhibitors      30
## 2: stk3d77zaux5s8ol 2017 FLUOXETINE Selective serotonin reuptake inhibitors      20
## 3: stk3d77zaux5s8ol 2017 FLUOXETINE Selective serotonin reuptake inhibitors      30
```

```r
#2018
CheckPatientID_SD(patientsList7, 2018)
```

```
##         pat_id1260 
## "qeof6cn1h2d4vi28" 
## [1] 2018
##              pat_id year   medication              Drug_class dayssup
## 1: qeof6cn1h2d4vi28 2018 ARIPIPRAZOLE Atypical antipsychotics      30
## 2: qeof6cn1h2d4vi28 2018 ARIPIPRAZOLE Atypical antipsychotics      30
## 3: qeof6cn1h2d4vi28 2018 ARIPIPRAZOLE Atypical antipsychotics      30
```

```r
#2019
CheckPatientID_SD(patientsList8, 2019)
```

```
##          pat_id839 
## "ew4yc2reglk91uon" 
## [1] 2019
##              pat_id year  medication              Drug_class dayssup
## 1: ew4yc2reglk91uon 2019 RISPERIDONE Atypical antipsychotics      90
```

```r
#2020
CheckPatientID_SD(patientsList9, 2020)
```

```
##         pat_id1427 
## "qvnae5y6hvzmrktj" 
## [1] 2020
##              pat_id year   medication              Drug_class dayssup
## 1: qvnae5y6hvzmrktj 2020 ARIPIPRAZOLE Atypical antipsychotics      30
## 2: qvnae5y6hvzmrktj 2020 ARIPIPRAZOLE Atypical antipsychotics      30
## 3: qvnae5y6hvzmrktj 2020 ARIPIPRAZOLE Atypical antipsychotics      30
```

Patients are filtered correctly. Now, the Sankey diagram construction.


```r
#For the others meds 
other_meds.df <- data.frame("OTHER","Other")
names(other_meds.df) <- c("medication","Drug_class")

drug_classes <- rbind(drug_classes, 
                      other_meds.df)

nodes_colors <- data.frame(Drug_class = sort(c("Selective serotonin reuptake inhibitors","Atypical antipsychotics","Other")))

color_nodes <- c("#489b7b","#cb6527", "#DDAB3B")

#The next functions is to add transparency (opacity) to the colors 
add.alpha <- function(col, alpha = 1){
  if(missing(col)){
    stop("Provide a vector of colours.")
  }else{
    apply(sapply(col, col2rgb)/255, 2,
          function(x)
            rgb(x[1], x[2], x[3], alpha = alpha))
  }
}

color_nodes_alpha <- add.alpha(color_nodes, alpha = 0.4)
nodes_colors <- cbind(nodes_colors, color = color_nodes, color_link = color_nodes_alpha)

#Create the nodes
nodes <- all_patterns_years_df %>%
  pivot_longer(1:2, values_to = "name_node") %>%
  distinct(name_node) %>% arrange(name_node) %>% 
  mutate(year = as.numeric(sub(".*_(\\d+)$", "\\1", name_node))) %>% 
  arrange(year) %>%
  mutate(name_node2 = substr(name_node, 1, nchar(name_node)-5)) %>% 
  mutate(medication = name_node2) %>% 
  mutate(name_node2 = gsub("(?<=\\b)([a-z])", 
                           "\\U\\1", 
                           tolower(name_node2), perl = TRUE)) %>% 
  arrange(year, medication) %>% 
  mutate(idx = (1:n()) - 1)

  links<- bind_rows(
    all_patterns_years_df %>% select(source = drugSource, target = drugTarget, value = n)) %>%
    mutate(year = as.numeric(sub(".*_(\\d+)$", "\\1", source))) %>% 
    arrange(year) %>% 
    dplyr::group_by(source, target) %>%
    mutate(source = nodes$idx[match(source, nodes$name_node)]) %>%
    mutate(target = nodes$idx[match(target, nodes$name_node)]) %>%
    ungroup()

  #Obtain the nodes that have a total less than 1 (dummy link)
nodes_smallCount_source <- links %>% 
    group_by(source) %>% 
    summarise(total = sum(value)) %>% 
    filter(.$total < 1) %>%
    ungroup() %>% 
    select(source) %>% 
    unique
  
    nodes_smallCount_target <- links %>% 
    group_by(target) %>% 
    summarise(total = sum(value)) %>% 
    filter(.$total < 1) %>%
    ungroup() %>%
    select(target) %>% 
    unique
    
   nodes_smallCount <- nodes_smallCount_source %>% 
      filter(.$source %in% nodes_smallCount_target$target | 
               .$source %in% c(3))
  

#Create the group of the nodes for coloring 
nodes <- nodes %>%
  mutate(color = "black") %>% 
mutate(color = ifelse(idx %in% 
                        nodes_smallCount$source, 
                      "#00000000", color)) %>%
mutate(medication = ifelse(color == "#00000000", paste0(medication,"_D"), medication), 
       name_node2 = ifelse(color == "#00000000", '', name_node2))


drug_class <- nodes_colors$medication
# linkColors <- sort(unique(links$color))

nodes_drugClasses <- nodes %>% 
  select(idx, medication) %>% 
  unique 

#This is to just leave the name of the nodes at the end
nodes <- nodes %>% 
  mutate(name_node_final = ifelse(year < max(year) , '', name_node2))

colnames(nodes_drugClasses)[1] = "source"

links <- left_join(links, nodes_drugClasses, by = "source") %>% 
    arrange(year, medication) %>% 
    mutate(medication = ifelse(value == 1e-6 & 
                                 substr(medication, nchar(medication)-1, 
                                        nchar(medication)) != "_D", paste0(medication,"_D"), medication))
  
colnames(links)[7] <- "medication"

my_color <- paste("d3.scaleOrdinal().domain([",
                  paste0("'",paste(drug_class, 
                                   collapse = "','"),"'"),",",paste0("'",paste(paste0(drug_class,"_D"), 
                                                                               collapse = "','"),"'"),
                  "]).range([",
                  paste0("'",paste(color_nodes,collapse="','"),"'"),",'#00000000', '#00000000', '#00000000'])")

my_color <- "d3.scaleOrdinal().domain([ 'Atypical antipsychotics','Selective serotonin reuptake inhibitors', 'Other', 'Atypical antipsychotics_D', 'Selective serotonin reuptake inhibitors_D', 'Other_D']).range([ '#489b7b','#cb6527','#DDAB3B', '#00000000', '#00000000', '#00000000'])"


nodes <- nodes %>% 
  mutate(name_node_final = ifelse(name_node_final == "Atypical Antipsychotics", "FDA-approved medications", 
                                  ifelse(name_node_final == "Selective Serotonin Reuptake Inhibitors", 
                                         "SSRIs", 
                                         name_node_final)))

fig_overtime_drugClasses <- sankeyNetwork(Links=links, Nodes=nodes, Source='source',
                                            Target='target', 
                                            Value = 'value', 
                                            NodeID ='name_node_final',
                                            colourScale=my_color,
                                            fontSize= 45, nodeWidth = 25,
                                            nodePadding = 15,
                                            sinksRight = FALSE,
                                            LinkGroup =  "medication",
                                            NodeGroup = "medication", 
                                            iterations = 0, width = 3000, height = 900)
```

```
## Links is a tbl_df. Converting to a plain data frame.
```

```
## Nodes is a tbl_df. Converting to a plain data frame.
```

```r
fig_overtime_drugClasses
```

```
## PhantomJS not found. You can install it with webshot::install_phantomjs(). If it is installed, please make sure the phantomjs executable can be found via the PATH variable.
```

```
## PhantomJS not found. You can install it with webshot::install_phantomjs(). If it is installed, please make sure the phantomjs executable can be found via the PATH variable.
```

```
## Error in path.expand(path): invalid 'path' argument
```

```r
end.time <- Sys.time()


htmlwidgets::saveWidget(fig_overtime_drugClasses, "S:/Paula/Figures/ResearchLetter/6-5_NewChanges/DrugClasses_Yearly_v2_withoutR419.html")
```

### Monthly


```r
year_select <- 2019

claims_dataset <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
   filter(.$year == year_select) #If is just one year
  #filter(.$year %in% year_select) #If is several years at once 


months <- 201901:201912

patients_id_allMonths <- c()

#If two FDA approvd medications 

meds_to_study <- c("ARIPIPRAZOLE", "RISPERIDONE",SSRIs_meds)
inter_meds <- c("ARIPIPRAZOLE", "RISPERIDONE", SSRIs_meds)

#The meds joined 
meds_to_study_joined <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
  select(medication) %>% 
  unique %>% 
  unlist 

start.time <- Sys.time()

years<-2012:2021

patients_source<- c()
cont <- 1

for(j in 1:length(months)){
  #Declare initial vectors
  if(months[j] < max(months)){
   
    medication_source_c<- c()
    medication_target_c<-c()
    
    #Extract only the patients that appears with a claim in the source
    #To reduce time consumption
    
    patients_id <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>%
      filter(month_id == months[j]) %>%
      select(pat_id, medication) %>%
      unique %>%
      filter(!pat_id %in% patients_beforeObsPeriod$pat_id) %>%
      group_by(pat_id) %>%
      filter(all(medication %in% meds_to_study)) %>% 
      summarise(n = n_distinct(medication), .groups = 'drop') %>%
      filter(n == 1) %>%
      select(pat_id) %>%
      unlist
    
    assign(paste0("patientsList",cont),patients_id)

    
    if(months[j] > min(months)){
      patAndMed_year <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
        filter(month_id == months[j-1]) %>% 
        select(pat_id, medication) %>%
        unique %>% 
        group_by(pat_id) %>% 
        filter(any(medication %in% meds_to_study)) %>% 
        ungroup() %>% 
        group_by(pat_id) %>% 
        count %>% 
        ungroup() %>% 
        filter(n > 1)
      
      patients_id <- patients_id[! patients_id %in% patAndMed_year$pat_id]
      
      assign(paste0("patientsList",cont),patients_id)

    }
   
    patients_id_allMonths <- unique(c(patients_id_allMonths,patients_id))
    
    
      for(i in patients_id_allMonths){
        #Go to each patient and see what of those only have one prescription 
        #or multiple prescription for the same drug medication (drug class)
        
        #In the source
        medication_source <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
          filter(month_id == months[j] & 
                   .$pat_id == i) %>% 
          select(medication) %>% unique
        
        
        #And in the target 
        medication_target <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
          filter(month_id == months[j+1] &  
                   .$pat_id == i) %>% 
          select(medication) %>% unique
        
        
        #Verify that the prescriptions only are from the same medication
        #And extract the medication
        if(nrow(medication_source) == 1 & nrow(medication_target) == 1 &
           (medication_source %in% meds_to_study_joined &
            medication_target %in% meds_to_study_joined)){
          
          patients_source<-c(patients_source,i)
          medication_source_c <-c(medication_source_c,medication_source)
          medication_target_c <-c(medication_target_c,medication_target)
        
        }
      }
      
    
    # and count it 
    drugs_patterns <- data.frame(drugSource = unlist(medication_source_c),
                                 drugTarget = unlist(medication_target_c)) %>%
      mutate(drugTarget = ifelse(drugTarget %in% inter_meds[1:2], 
                                 "Atypical antipsychotics",
                                 ifelse(drugTarget %in% inter_meds[2:length(inter_meds)],
                                        "Selective serotonin reuptake inhibitors", 
                                        "OTHER")), 
             drugSource = ifelse(drugSource %in% inter_meds[1:2], 
                                 "Atypical antipsychotics",
                                 ifelse(drugSource %in% inter_meds[2:length(inter_meds)],
                                        "Selective serotonin reuptake inhibitors", 
                                        "OTHER"))) %>% 
      mutate(drugTarget = paste(drugTarget,months[j+1],sep="_")) %>%
      mutate(drugSource = paste(drugSource,months[j], sep="_")) %>%
      group_by(drugSource, drugTarget) %>%
      count %>% 
      mutate(medication = substr(drugSource, 1, nchar(drugSource)-5))
  
    
    assign(paste0("df_drugsYear",cont),drugs_patterns)
    cont = cont + 1
     
  }
 
}
#Obtain a list of each of the dataframes 
df_names <- paste0("df_drugsYear",1:(cont-1))
df_list <- mget(df_names, inherits =  FALSE)

#For all the months
all_patterns_monthly_df <- bind_rows(df_list)


end.time <- Sys.time()
```

The same checking process is made for the monthly individual shifts.


```r
CheckPatientID_SD_month <- function(ListIDs, month_select){
  random_patient <-ListIDs[round(runif(1, 
                                           min = 1, 
                                           max = length(ListIDs)))]


  print(month_select)
  print(claims_ASD_wNDC_csv_onlyPrescripClass %>%
          filter(pat_id == random_patient) %>%
          filter(month_id == month_select) %>%
          select(pat_id,
                 month_id,
                 medication,
                 Drug_class,
                 dayssup) %>%
          arrange(month_id))
}

#Jan
CheckPatientID_SD_month(patientsList1, 201901)
```

```
## [1] 201901
##              pat_id month_id medication                              Drug_class dayssup
## 1: j40ruz3axwa7vwzs   201901 FLUOXETINE Selective serotonin reuptake inhibitors      90
## 2: j40ruz3axwa7vwzs   201901 FLUOXETINE Selective serotonin reuptake inhibitors      90
```

```r
#Feb
CheckPatientID_SD_month(patientsList2, 201902)
```

```
## [1] 201902
##              pat_id month_id  medication              Drug_class dayssup
## 1: 7z3dkzegssmh77m9   201902 RISPERIDONE Atypical antipsychotics      90
```

```r
#Mar
CheckPatientID_SD_month(patientsList3, 201903)
```

```
## [1] 201903
##              pat_id month_id medication                              Drug_class dayssup
## 1: k7cap8t1h2d4vi28   201903 FLUOXETINE Selective serotonin reuptake inhibitors      30
## 2: k7cap8t1h2d4vi28   201903 FLUOXETINE Selective serotonin reuptake inhibitors      30
## 3: k7cap8t1h2d4vi28   201903 FLUOXETINE Selective serotonin reuptake inhibitors      30
```

```r
#Apr
CheckPatientID_SD_month(patientsList4, 201904)
```

```
## [1] 201904
##              pat_id month_id medication                              Drug_class dayssup
## 1: d5xen5kzbs6q4zop   201904 FLUOXETINE Selective serotonin reuptake inhibitors      90
```

```r
#May
CheckPatientID_SD_month(patientsList5, 201905)
```

```
## [1] 201905
##              pat_id month_id medication                              Drug_class dayssup
## 1: 5vxznqwq04thbu6y   201905 FLUOXETINE Selective serotonin reuptake inhibitors      30
```

```r
#Jun
CheckPatientID_SD_month(patientsList6, 201906)
```

```
## [1] 201906
##              pat_id month_id medication                              Drug_class dayssup
## 1: 6n9q00qg3qhmv0ml   201906 SERTRALINE Selective serotonin reuptake inhibitors      90
```

```r
#Jul
CheckPatientID_SD_month(patientsList7, 201907)
```

```
## [1] 201907
##              pat_id month_id medication                              Drug_class dayssup
## 1: c578jqswz9f07gvz   201907 SERTRALINE Selective serotonin reuptake inhibitors      30
```

```r
#Aug
CheckPatientID_SD_month(patientsList8, 201908)
```

```
## [1] 201908
##              pat_id month_id medication                              Drug_class dayssup
## 1: m4k6p8r4zyp8h3z2   201908 CITALOPRAM Selective serotonin reuptake inhibitors      30
```

```r
#Sep
CheckPatientID_SD_month(patientsList9, 201909)
```

```
## [1] 201909
##              pat_id month_id   medication              Drug_class dayssup
## 1: kkaj6lxdsotz64e6   201909 ARIPIPRAZOLE Atypical antipsychotics      90
```

```r
#Oct
CheckPatientID_SD_month(patientsList10, 201910)
```

```
## [1] 201910
##              pat_id month_id medication                              Drug_class dayssup
## 1: 5wr00r21otu6799l   201910 SERTRALINE Selective serotonin reuptake inhibitors      90
```

```r
#Nov
CheckPatientID_SD_month(patientsList11, 201911)
```

```
## [1] 201911
##              pat_id month_id medication                              Drug_class dayssup
## 1: ams26klu7d25vsvw   201911 FLUOXETINE Selective serotonin reuptake inhibitors      30
## 2: ams26klu7d25vsvw   201911 FLUOXETINE Selective serotonin reuptake inhibitors      30
## 3: ams26klu7d25vsvw   201911 FLUOXETINE Selective serotonin reuptake inhibitors      30
## 4: ams26klu7d25vsvw   201911 FLUOXETINE Selective serotonin reuptake inhibitors      30
```

The patients weere identified correctly.


```r
#For the others meds 
other_meds.df <- data.frame("OTHER","Other")
names(other_meds.df) <- c("medication","Drug_class")

drug_classes <- rbind(drug_classes, 
                      other_meds.df)

nodes_colors <- data.frame(Drug_class = sort(c("Selective serotonin reuptake inhibitors","Atypical antipsychotics","Other")))

color_nodes <- c("#489b7b","#cb6527", "#DDAB3B")


#The next functions is to add transparency (opacity) to the colors 
add.alpha <- function(col, alpha = 1){
  if(missing(col)){
    stop("Provide a vector of colours.")
  }else{
    apply(sapply(col, col2rgb)/255, 2,
          function(x)
            rgb(x[1], x[2], x[3], alpha = alpha))
  }
}

color_nodes_alpha <- add.alpha(color_nodes, alpha = 0.4)
nodes_colors <- cbind(nodes_colors, color = color_nodes, color_link = color_nodes_alpha)

#Create the nodes
nodes <- all_patterns_monthly_df %>%
  pivot_longer(1:2, values_to = "name_node") %>%
  distinct(name_node) %>% arrange(name_node) %>% 
  mutate(year = as.numeric(sub(".*_(\\d+)$", "\\1", name_node))) %>% 
  arrange(year) %>%
  mutate(name_node2 = substr(name_node, 1, nchar(name_node)-7)) %>% 
  mutate(medication = name_node2) %>% 
  mutate(name_node2 = gsub("(?<=\\b)([a-z])", 
                           "\\U\\1", 
                           tolower(name_node2), perl = TRUE)) %>% 
  arrange(year, medication) %>% 
  mutate(idx = (1:n()) - 1)
  
  links<- bind_rows(
    all_patterns_monthly_df %>% select(source = drugSource, target = drugTarget, value = n)) %>%
    mutate(year = as.numeric(sub(".*_(\\d+)$", "\\1", source))) %>% 
    arrange(year) %>% 
    dplyr::group_by(source, target) %>%
    mutate(source = nodes$idx[match(source, nodes$name_node)]) %>%
    mutate(target = nodes$idx[match(target, nodes$name_node)]) %>% 
    ungroup()

  #Obtain the nodes that have a total less than 1 (dummy link)
nodes_smallCount_source <- links %>% 
    group_by(source) %>% 
    summarise(total = sum(value)) %>% 
    filter(.$total < 1) %>%
    ungroup() %>% 
    select(source) %>% 
    unique
  
    nodes_smallCount_target <- links %>% 
    group_by(target) %>% 
    summarise(total = sum(value)) %>% 
    filter(.$total < 1) %>%
    ungroup() %>%
    select(target) %>% 
    unique
    
   nodes_smallCount <- nodes_smallCount_source %>% 
      filter(.$source %in% nodes_smallCount_target$target | 
               .$source %in% c(3))
  

#Create the group of the nodes for coloring 
nodes <- nodes %>%
  mutate(color = "black") %>% 
mutate(color = ifelse(idx %in% 
                        nodes_smallCount$source, 
                      "#00000000", color)) %>%
mutate(medication = ifelse(color == "#00000000", paste0(medication,"_D"), medication), 
       name_node2 = ifelse(color == "#00000000", '', name_node2))


drug_class <- nodes_colors$medication
# linkColors <- sort(unique(links$color))

nodes_drugClasses <- nodes %>% 
  select(idx, medication) %>% 
  unique 

#This is to just leave the name of the nodes at the end
nodes <- nodes %>% 
  mutate(name_node_final = ifelse(year < max(year) , '', name_node2))

colnames(nodes_drugClasses)[1] = "source"

links <- left_join(links, nodes_drugClasses, by = "source") %>% 
    arrange(year, medication) %>% 
    mutate(medication = ifelse(value == 1e-6 & 
                                 substr(medication, nchar(medication)-1, 
                                        nchar(medication)) != "_D", paste0(medication,"_D"), medication))
  
colnames(links)[7] <- "medication"

my_color <- paste("d3.scaleOrdinal().domain([",
                  paste0("'",paste(drug_class, 
                                   collapse = "','"),"'"),",",paste0("'",paste(paste0(drug_class,"_D"), 
                                                                               collapse = "','"),"'"),
                  "]).range([",
                  paste0("'",paste(color_nodes,collapse="','"),"'"),",'#00000000', '#00000000', '#00000000'])")

my_color <- "d3.scaleOrdinal().domain([ 'Atypical antipsychotics','Selective serotonin reuptake inhibitors', 'Other', 'Atypical antipsychotics_D', 'Selective serotonin reuptake inhibitors_D', 'Other_D']).range([ '#489b7b','#cb6527','#DDAB3B', '#00000000', '#00000000', '#00000000'])"




nodes <- nodes %>% 
  mutate(name_node_final = ifelse(name_node_final == "Atypical Antipsychotics", "FDA-approved medications", 
                                  ifelse(name_node_final == "Selective Serotonin Reuptake Inhibitors", 
                                         "SSRIs", 
                                         name_node_final)))



fig_overtime_drugClasses <- sankeyNetwork(Links=links, Nodes=nodes, Source='source',
                                            Target='target', 
                                            Value = 'value', 
                                            NodeID ='name_node_final',
                                            colourScale=my_color,
                                            fontSize= 45, nodeWidth = 25,
                                            nodePadding = 15,
                                            sinksRight = FALSE,
                                            LinkGroup =  "medication",
                                            NodeGroup = "medication", 
                                            iterations = 0, width = 3000, height = 900)
```

```
## Links is a tbl_df. Converting to a plain data frame.
```

```
## Nodes is a tbl_df. Converting to a plain data frame.
```

```r
fig_overtime_drugClasses
```

```
## PhantomJS not found. You can install it with webshot::install_phantomjs(). If it is installed, please make sure the phantomjs executable can be found via the PATH variable.
```

```
## Error in path.expand(path): invalid 'path' argument
```

```r
end.time <- Sys.time()

htmlwidgets::saveWidget(fig_overtime_drugClasses, "S:/Paula/Figures/ResearchLetter/6-5_NewChanges/DrugClasses_Monthly_v2_withouR419.html")
```

## Sankey diagram but not aggregating the two FDA-approved medications

In order to extract the exact count of patients who took the two FDA approved medications separately, we are going to do the same process but without aggregating in that drug class.

### Yearly


```r
SSRIs_meds <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
  select(medication, Drug_class) %>% 
  unique %>% 
  filter(Drug_class == "Selective serotonin reuptake inhibitors") %>% 
  select(medication) %>% 
  unlist

meds_to_study <- c("ARIPIPRAZOLE", "RISPERIDONE",SSRIs_meds)
inter_meds <- c("ARIPIPRAZOLE", "RISPERIDONE", SSRIs_meds)

#The meds joined 
meds_to_study_joined <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
  select(medication) %>% 
  unique %>% 
  unlist

start.time <- Sys.time()
patients_id_allYears<-c()

years<-2012:2021

patients_source<- c()
cont <- 1

for(j in 1:length(years)){
  #Declare initial vectors
  if(years[j] < max(years)){
   
    medication_source_c<- c()
    medication_target_c<-c()
    
  patients_id <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>%
      filter(year == years[j]) %>%
      select(pat_id, medication) %>%
      unique %>%
      filter(!pat_id %in% patients_beforeObsPeriod$pat_id) %>%
      group_by(pat_id) %>%
      filter(all(medication %in% meds_to_study)) %>% 
      summarise(n = n_distinct(medication), .groups = 'drop') %>%
      filter(n == 1) %>%
      select(pat_id) %>%
      unlist
    
    assign(paste0("patientsList",cont),patients_id)

    
    if(years[j] > 2012){
      patAndMed_year <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
        filter(year == years[j-1]) %>% 
        select(pat_id, medication) %>%
        unique %>% 
        group_by(pat_id) %>% 
        filter(any(medication %in% meds_to_study)) %>% 
        ungroup() %>% 
        group_by(pat_id) %>% 
        count %>% 
        ungroup() %>% 
        filter(n > 1)
      
      patients_id <- patients_id[! patients_id %in% patAndMed_year$pat_id]
      
      assign(paste0("patientsList",cont),patients_id)

    }
   
    patients_id_allYears <- unique(c(patients_id_allYears,patients_id))
    
    
      for(i in patients_id_allYears){
        #Go to each patient and see what of those only have one prescription 
        #or multiple prescription for the same drug medication (drug class)
        
        #In the source
        medication_source <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
          filter(year == years[j] & 
                   .$pat_id == i) %>% 
          select(medication) %>% unique
        
        
        #And in the target 
        medication_target <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
          filter(year == years[j+1] &  
                   .$pat_id == i) %>% 
          select(medication) %>% unique
        
        
        #Verify that the prescriptions only are from the same medication
        #And extract the medication
        if(nrow(medication_source) == 1 & nrow(medication_target) == 1 &
           (medication_source %in% meds_to_study_joined &
            medication_target %in% meds_to_study_joined)){
          
          patients_source<-c(patients_source,i)
          medication_source_c <-c(medication_source_c,medication_source)
          medication_target_c <-c(medication_target_c,medication_target)
        
        }
      }
      
    
    # and count it 
      drugs_patterns <- data.frame(drugSource = unlist(medication_source_c),
                                 drugTarget = unlist(medication_target_c)) %>%
      mutate(drugTarget = ifelse(drugTarget %in% inter_meds[1:2], 
                                 drugTarget,
                                 ifelse(drugTarget %in%
                                          inter_meds[2:length(inter_meds)],
                                        "Selective serotonin reuptake inhibitors", 
                                        "OTHER")), 
             drugSource = ifelse(drugSource %in% inter_meds[1:2], 
                                 drugSource,
                                 ifelse(drugSource %in%
                                          inter_meds[2:length(inter_meds)],
                                        "Selective serotonin reuptake inhibitors", 
                                        "OTHER"))) %>% 
      mutate(drugTarget = paste(drugTarget,years[j+1],sep="_")) %>%
      mutate(drugSource = paste(drugSource,years[j], sep="_")) %>%
      group_by(drugSource, drugTarget) %>%
      count %>% 
      mutate(medication = substr(drugSource, 1, nchar(drugSource)-5))
  
    
    assign(paste0("df_drugsYear",cont),drugs_patterns)
    cont = cont + 1
     
  }
 
}
#Obtain a list of each of the dataframes 
df_names <- paste0("df_drugsYear",1:(cont-1))
df_list <- mget(df_names, inherits =  FALSE)

#For all the months
all_patterns_years_notAggregate_df <- bind_rows(df_list)


end.time <- Sys.time()
```

The time taken by the sankey diagram generation.


```r
end.time - start.time
```

```
## Time difference of 8.80902 mins
```

### Monthly


```r
year_select <- 2019

claims_dataset <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
   filter(.$year == year_select) #If is just one year
  #filter(.$year %in% year_select) #If is several years at once 


months <- 201901:201912

patients_id_allMonths <- c()

#If two FDA approvd medications 

meds_to_study <- c("ARIPIPRAZOLE", "RISPERIDONE",SSRIs_meds)
inter_meds <- c("ARIPIPRAZOLE", "RISPERIDONE", SSRIs_meds)

#The meds joined 
meds_to_study_joined <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
  select(medication) %>% 
  unique %>% 
  unlist 

start.time <- Sys.time()

years<-2012:2021

patients_source<- c()
cont <- 1

for(j in 1:length(months)){
  #Declare initial vectors
  if(months[j] < max(months)){
   
    medication_source_c<- c()
    medication_target_c<-c()
    
    #Extract only the patients that appears with a claim in the source
    #To reduce time consumption
    
    patients_id <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>%
      filter(month_id == months[j]) %>%
      select(pat_id, medication) %>%
      unique %>%
      filter(!pat_id %in% patients_beforeObsPeriod$pat_id) %>%
      group_by(pat_id) %>%
      filter(all(medication %in% meds_to_study)) %>% 
      summarise(n = n_distinct(medication), .groups = 'drop') %>%
      filter(n == 1) %>%
      select(pat_id) %>%
      unlist
    
    assign(paste0("patientsList",cont),patients_id)

    
    if(months[j] > min(months)){
      patAndMed_year <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
        filter(month_id == months[j-1]) %>% 
        select(pat_id, medication) %>%
        unique %>% 
        group_by(pat_id) %>% 
        filter(any(medication %in% meds_to_study)) %>% 
        ungroup() %>% 
        group_by(pat_id) %>% 
        count %>% 
        ungroup() %>% 
        filter(n > 1)
      
      patients_id <- patients_id[! patients_id %in% patAndMed_year$pat_id]
      
      assign(paste0("patientsList",cont),patients_id)

    }
   
    patients_id_allMonths <- unique(c(patients_id_allMonths,patients_id))
    
    
      for(i in patients_id_allMonths){
        #Go to each patient and see what of those only have one prescription 
        #or multiple prescription for the same drug medication (drug class)
        
        #In the source
        medication_source <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
          filter(month_id == months[j] & 
                   .$pat_id == i) %>% 
          select(medication) %>% unique
        
        
        #And in the target 
        medication_target <- claims_ASD_wNDC_csv_onlyPrescripClass_RL %>% 
          filter(month_id == months[j+1] &  
                   .$pat_id == i) %>% 
          select(medication) %>% unique
        
        
        #Verify that the prescriptions only are from the same medication
        #And extract the medication
        if(nrow(medication_source) == 1 & nrow(medication_target) == 1 &
           (medication_source %in% meds_to_study_joined &
            medication_target %in% meds_to_study_joined)){
          
          patients_source<-c(patients_source,i)
          medication_source_c <-c(medication_source_c,medication_source)
          medication_target_c <-c(medication_target_c,medication_target)
        
        }
      }
      
    
    # and count it 
    drugs_patterns <- data.frame(drugSource = unlist(medication_source_c),
                                 drugTarget = unlist(medication_target_c)) %>%
      mutate(drugTarget = ifelse(drugTarget %in% inter_meds[1:2], 
                                 drugTarget,
                                 ifelse(drugTarget %in%
                                          inter_meds[2:length(inter_meds)],
                                        "Selective serotonin reuptake inhibitors", 
                                        "OTHER")), 
             drugSource = ifelse(drugSource %in% inter_meds[1:2], 
                                 drugSource,
                                 ifelse(drugSource %in%
                                          inter_meds[2:length(inter_meds)],
                                        "Selective serotonin reuptake inhibitors", 
                                        "OTHER"))) %>% 
      mutate(drugTarget = paste(drugTarget,months[j+1],sep="_")) %>%
      mutate(drugSource = paste(drugSource,months[j], sep="_")) %>%
      group_by(drugSource, drugTarget) %>%
      count %>% 
      mutate(medication = substr(drugSource, 1, nchar(drugSource)-5))
  
    
    assign(paste0("df_drugsYear",cont),drugs_patterns)
    cont = cont + 1
     
  }
 
}
#Obtain a list of each of the dataframes 
df_names <- paste0("df_drugsYear",1:(cont-1))
df_list <- mget(df_names, inherits =  FALSE)

#For all the months
all_patterns_monthly_notAggregate_df <- bind_rows(df_list)


end.time <- Sys.time()
```

## To calculate rate of change

Aggregated by drug class, we calculate the average proportion of patients who shifted to other medications.

Monthly.


```r
AllThePatientsShifting_monthly <- all_patterns_monthly_df %>%
  mutate(namedrugSource = substr(drugSource, 
                                 1, 
                                 nchar(drugSource) - 7), 
         namedrugTarget = substr(drugTarget, 
                                 1, 
                                 nchar(drugTarget) - 7)) %>%
  filter(namedrugSource != namedrugTarget) %>% 
    group_by(drugSource) %>% 
    summarise(total_change = sum(n)) %>% 
  ungroup()

#Sum all the patients per medication 
AllThePatientsStaying_monthly <- all_patterns_monthly_df %>%
    group_by(drugSource) %>% 
    summarise(total = sum(n)) %>% 
  ungroup()

#Left join to calculate the change 
rates_Change_monthly <- AllThePatientsStaying_monthly %>% 
  left_join(AllThePatientsShifting_monthly, by = "drugSource") %>% 
  group_by(drugSource) %>% 
  mutate(rate_change = total_change/total) %>% 
  ungroup() %>% 
  mutate(namedrugSource = substr(drugSource, 
                                 1, 
                                 nchar(drugSource) - 7)) %>% 
  group_by(namedrugSource) %>% 
  summarise(rate_change_prop = sum(rate_change)/11) %>% 
  ungroup()
```

Yearly.


```r
AllThePatientsShifting_yearly <- all_patterns_years_df %>%
  mutate(namedrugSource = substr(drugSource, 
                                 1, 
                                 nchar(drugSource) - 5), 
         namedrugTarget = substr(drugTarget, 
                                 1, 
                                 nchar(drugTarget) - 5)) %>%
  filter(namedrugSource != namedrugTarget) %>% 
    group_by(drugSource) %>% 
    summarise(total_change = sum(n)) %>% 
  ungroup()

#Sum all the patients per medication 
AllThePatientsStaying_yearly <- all_patterns_years_df %>%
    group_by(drugSource) %>% 
    summarise(total = sum(n)) %>% 
  ungroup()

#Left join to calculate the change 
rates_Change_yearly <- AllThePatientsStaying_yearly %>% 
  left_join(AllThePatientsShifting_yearly, by = "drugSource") %>% 
  mutate(total_change = ifelse(is.na(total_change), 0, total_change)) %>% 
  group_by(drugSource) %>% 
  mutate(rate_change = total_change/total) %>% 
  ungroup() %>% 
  mutate(namedrugSource = substr(drugSource, 
                                 1, 
                                 nchar(drugSource) - 5)) %>% 
  group_by(namedrugSource) %>% 
  summarise(rate_change_prop = sum(rate_change)/11) %>% 
  ungroup()
```

To calculate the average proportion by medications (aripiprazole and risperidone) - yearly.


```r
AllThePatientsShifting_yearly <- all_patterns_years_notAggregate_df %>%
  mutate(namedrugSource = substr(drugSource, 
                                 1, 
                                 nchar(drugSource) - 5), 
         namedrugTarget = substr(drugTarget, 
                                 1, 
                                 nchar(drugTarget) - 5))  %>% 
  filter(!(namedrugSource == "ARIPIPRAZOLE" & 
            namedrugTarget == "RISPERIDONE") &  
           !(namedrugSource == "RISPERIDONE" & 
            namedrugTarget == "ARIPIPRAZOLE")) %>% 
  filter(namedrugSource != namedrugTarget) %>% 
    group_by(drugSource) %>% 
    summarise(total_change = sum(n)) %>% 
  ungroup() %>% 
  mutate(namedrugSource_med = substr(drugSource, 
                                 1, 
                                 nchar(drugSource) - 5),
         namedrugSource = drugSource,
         year_med = substr(drugSource,
                           nchar(drugSource) - 4, 
                           nchar(drugSource)),
         drugSource = ifelse(namedrugSource_med %in% c("ARIPIPRAZOLE",
                                                       "RISPERIDONE"), 
                             paste0("Atypical antipsychotics", 
                                    year_med), 
                             ifelse(namedrugSource_med  == "Selective serotonin reuptake inhibitors", 
                                    paste0("Selective serotonin reuptake inhibitors",
                                           year_med), paste0("OTHER",year_med))
                              )) %>% 
  select(-year_med)

#Sum all the patients per medication 
AllThePatientsStaying_yearly <- all_patterns_years_df %>%
    group_by(drugSource) %>% 
    summarise(total = sum(n)) %>% 
  ungroup()

#Left join to calculate the change 
rates_Change_yearly <- AllThePatientsStaying_yearly %>% 
  left_join(AllThePatientsShifting_yearly, by = "drugSource") %>% 
  mutate(total_change = ifelse(is.na(total_change), 0, total_change)) %>% 
  group_by(namedrugSource) %>% 
  mutate(rate_change = total_change/total) %>% 
  ungroup() %>% 
  group_by(namedrugSource_med) %>% 
  summarise(rate_change_prop = sum(rate_change)/11) %>% 
  ungroup()
```

To calculate the average proportion by medications (aripiprazole and risperidone) - monthly


```r
AllThePatientsShifting_monthly <- all_patterns_monthly_notAggregate_df %>%
  mutate(namedrugSource = substr(drugSource, 
                                 1, 
                                 nchar(drugSource) - 7), 
         namedrugTarget = substr(drugTarget, 
                                 1, 
                                 nchar(drugTarget) - 7)) %>%
  filter(!(namedrugSource == "ARIPIPRAZOLE" & 
            namedrugTarget == "RISPERIDONE") &  
           !(namedrugSource == "RISPERIDONE" & 
            namedrugTarget == "ARIPIPRAZOLE")) %>%
  filter(namedrugSource != namedrugTarget) %>% 
    group_by(drugSource) %>% 
    summarise(total_change = sum(n)) %>% 
  ungroup() %>% 
  mutate(namedrugSource_med = substr(drugSource, 
                                 1, 
                                 nchar(drugSource) - 7),
         namedrugSource = drugSource,
         year_med = substr(drugSource,
                           nchar(drugSource) - 6, 
                           nchar(drugSource)),
         drugSource = ifelse(namedrugSource_med %in% c("ARIPIPRAZOLE",
                                                       "RISPERIDONE"), 
                             paste0("Atypical antipsychotics", 
                                    year_med), 
                             ifelse(namedrugSource_med  == "Selective serotonin reuptake inhibitors", 
                                    paste0("Selective serotonin reuptake inhibitors",
                                           year_med), paste0("OTHER",year_med))
                              )) %>% 
  select(-year_med)

#Sum all the patients per medication 
AllThePatientsStaying_monthly <- all_patterns_monthly_df %>%
    group_by(drugSource) %>% 
    summarise(total = sum(n)) %>% 
  ungroup()

#Left join to calculate the change 
rates_Change_monthly <- AllThePatientsStaying_monthly %>% 
  left_join(AllThePatientsShifting_monthly, by = "drugSource") %>%
  mutate(total_change = ifelse(is.na(total_change), 0, total_change)) %>%
  group_by(namedrugSource) %>% 
  mutate(rate_change = total_change/total) %>% 
  ungroup() %>% 
  group_by(namedrugSource_med) %>% 
  summarise(rate_change_prop = sum(rate_change)/11) %>% 
  ungroup()
```

Save the patterns!


```r
fwrite(all_patterns_monthly_df, "S:/Paula/Files_finish/WithoutR491/SSRIs_RispArip_monthly_NewChanges.csv")

fwrite(all_patterns_years_df, "S:/Paula/Files_finish/WithoutR491/SSRIs_RispArip_yearly_NewChanges.csv")
```

## Calculate proportions

Separating the patients with at least one prescription of any of the selected medications


```r
claims_prescrip_RL <- claims_ASD_wNDC_csv_onlyPrescripClass %>%
  filter(!pat_id %in% patients_beforeObsPeriod) %>%
  mutate(year_claim = as.numeric(substr(month_id, 1,4)))  %>% 
  group_by(year_claim, pat_id) %>% 
  filter(Drug_class == "Selective serotonin reuptake inhibitors" |
           
           medication %in% c("ARIPIPRAZOLE", "RISPERIDONE")) %>% 
  ungroup()
```

Grouping without the year


```r
claims_prescrip_RL_FDA <- claims_prescrip_RL %>% 
  mutate(year_claim = as.numeric(substr(month_id, 1,4))) %>% 
  select(pat_id, medication, der_sex) %>% 
  unique %>% 
  group_by(pat_id) %>% 
  filter(all(medication %in% c("ARIPIPRAZOLE", "RISPERIDONE"))) %>% 
  ungroup() 


claims_prescrip_RL_SSRIs <- claims_prescrip_RL %>% 
  mutate(year_claim = as.numeric(substr(month_id, 1,4))) %>% 
  select(pat_id, medication, der_sex) %>% 
  unique %>% 
  group_by(pat_id) %>% 
  filter(all(medication %in% SSRIs_meds)) %>% 
  ungroup() 

both_claims <- claims_prescrip_RL %>% 
  mutate(year_claim = as.numeric(substr(month_id, 1,4))) %>% 
  group_by(pat_id) %>% 
  filter(any(medication %in% SSRIs_meds) &
           any(medication %in% c("ARIPIPRAZOLE", "RISPERIDONE"))) %>% 
  ungroup()
```

Gender.


```r
#Both
gender_patients <- both_claims %>% 
  select(pat_id, der_sex) %>% 
  unique 

female_estimate <- sum(gender_patients$der_sex == "F")
male_estimate <- sum(gender_patients$der_sex == "M")

female_proportion <- female_estimate / (female_estimate+male_estimate) 
male_proportion <- male_estimate / (female_estimate+male_estimate)

#Only SSRIs
gender_patients_SSRIs <- claims_prescrip_RL_SSRIs %>% 
  select(pat_id, der_sex) %>% 
  unique 

female_estimate_SSRIs <- sum(gender_patients_SSRIs$der_sex == "F")
male_estimate_SSRIs <- sum(gender_patients_SSRIs$der_sex == "M")

female_proportion_SSRIs <- female_estimate_SSRIs / (female_estimate_SSRIs+male_estimate_SSRIs) 
male_proportion_SSRIs <- male_estimate_SSRIs / (female_estimate_SSRIs+male_estimate_SSRIs)

# FDA-approved meds
gender_patients_FDA <- claims_prescrip_RL_FDA %>% 
  select(pat_id, der_sex) %>% 
  unique 

female_estimate_FDA<- sum(gender_patients_FDA$der_sex == "F")
male_estimate_FDA <- sum(gender_patients_FDA$der_sex == "M")

female_proportion_FDA <- female_estimate_FDA / (female_estimate_FDA+male_estimate_FDA) 
male_proportion_FDA <- male_estimate_FDA / (female_estimate_FDA+male_estimate_FDA)

#All patients
gender_patients_all <- claims_prescrip_RL %>% 
  select(pat_id, der_sex) %>% 
  unique 

female_estimate_all <- sum(gender_patients_all$der_sex == "F")
male_estimate_all <- sum(gender_patients_all$der_sex == "M")

female_proportion_all <- female_estimate_all / (female_estimate_all+male_estimate_all) 
male_proportion_all <- male_estimate_all / (female_estimate_all+male_estimate_all)
```

Age at first diagnosis.


```r
#General
FirstDiagnosis_age <- claims_diagnosis %>% 
  filter(pat_id %in% unique(both_claims$pat_id)) %>% 
  arrange(from_dt, pat_id) %>%  
  group_by(pat_id) %>% 
  slice(1) %>% 
  ungroup() %>% 
  mutate(year = as.numeric(substr(from_dt, 1, 4)), 
         age_1Diag = year - der_yob)

#SSRIs
FirstDiagnosis_age <- claims_diagnosis %>% 
  filter(pat_id %in% unique(claims_prescrip_RL_SSRIs$pat_id)) %>% 
  arrange(from_dt, pat_id) %>%  
  group_by(pat_id) %>% 
  slice(1) %>% 
  ungroup() %>% 
  mutate(year = as.numeric(substr(from_dt, 1, 4)), 
         age_1Diag = year - der_yob)

#FDA
FirstDiagnosis_age <- claims_diagnosis %>% 
  filter(pat_id %in% unique(claims_prescrip_RL_FDA$pat_id)) %>% 
  arrange(from_dt, pat_id) %>%  
  group_by(pat_id) %>% 
  slice(1) %>% 
  ungroup() %>% 
  mutate(year = as.numeric(substr(from_dt, 1, 4)), 
         age_1Diag = year - der_yob)

#All 
FirstDiagnosis_age <- claims_diagnosis %>% 
  filter(pat_id %in% unique(claims_prescrip_RL$pat_id)) %>% 
  arrange(from_dt, pat_id) %>%  
  group_by(pat_id) %>% 
  slice(1) %>% 
  ungroup() %>% 
  mutate(year = as.numeric(substr(from_dt, 1, 4)), 
         age_1Diag = year - der_yob)


two25_estimate <- sum(FirstDiagnosis_age$age_1Diag >= 2 & 
                        FirstDiagnosis_age$age_1Diag <= 5)

six2elev_estimate <- sum(FirstDiagnosis_age$age_1Diag >= 6 & 
                        FirstDiagnosis_age$age_1Diag <= 11)

twelve2seventn_estimate <- sum(FirstDiagnosis_age$age_1Diag >= 12 & 
                        FirstDiagnosis_age$age_1Diag <= 17)

eighteen2twntsix_estimate <- sum(FirstDiagnosis_age$age_1Diag >= 18 & 
                        FirstDiagnosis_age$age_1Diag <= 26)

allAges <- two25_estimate+six2elev_estimate+twelve2seventn_estimate+eighteen2twntsix_estimate

two2five_prop <- two25_estimate/allAges
six2elev_prop <- six2elev_estimate/allAges
twelve2seventn_prop <- twelve2seventn_estimate/allAges
eighteen2twntsix_prop <- eighteen2twntsix_estimate/allAges

two25_estimate
```

```
## [1] 1136
```

```r
two2five_prop
```

```
## [1] 0.07110666
```

```r
six2elev_estimate
```

```
## [1] 5033
```

```r
six2elev_prop
```

```
## [1] 0.3150351
```

```r
twelve2seventn_estimate
```

```
## [1] 6028
```

```r
twelve2seventn_prop
```

```
## [1] 0.377316
```

```r
eighteen2twntsix_estimate
```

```
## [1] 3779
```

```r
eighteen2twntsix_prop
```

```
## [1] 0.2365423
```

Patients per year.

To do all the calculations grouping by year.


```r
#Combined patients taking both 
both_claims <- claims_prescrip_RL %>% 
  mutate(year_claim = as.numeric(substr(month_id, 1,4))) %>% 
  group_by(year_claim, pat_id) %>% 
  filter(any(medication %in% SSRIs_meds) & 
           any(medication %in% c("ARIPIPRAZOLE", "RISPERIDONE"))) %>% 
  arrange(year_claim, pat_id) %>% 
  ungroup()

#only SSRIs
claims_prescrip_RL_SSRIs <- claims_prescrip_RL %>% 
  mutate(year_claim = as.numeric(substr(month_id, 1,4))) %>% 
  select(year_claim, pat_id, medication, der_sex) %>% 
  unique %>% 
  group_by(pat_id, year_claim) %>% 
  filter(all(medication %in% SSRIs_meds)) %>% 
  ungroup() %>% 
  arrange(year_claim, pat_id)

## FDA-approved meds
claims_prescrip_RL_FDA <- claims_prescrip_RL %>% 
  mutate(year_claim = as.numeric(substr(month_id, 1,4))) %>% 
  select(year_claim, pat_id, medication, der_sex) %>% 
  unique %>% 
  group_by(pat_id, year_claim) %>% 
  filter(all(medication %in% c("ARIPIPRAZOLE", "RISPERIDONE"))) %>% 
  ungroup() %>% 
  arrange(year_claim, pat_id)
```


```r
#General
PatientsPerYear <- unlist(lapply(2012:2021, function(x) both_claims %>% mutate(year = as.numeric(substr(month_id, 1, 4))) %>% filter(year == x) %>% select(pat_id) %>% unique %>% nrow))

TotalPat <- 3420
Prop_PatientsPerYear <- PatientsPerYear / TotalPat

#FDA
PatientsPerYear <- unlist(lapply(2012:2021, function(x) claims_prescrip_RL %>% filter(pat_id %in% unique(claims_prescrip_RL_FDA$pat_id)) %>% mutate(year = as.numeric(substr(month_id, 1, 4))) %>% filter(year == x) %>% select(pat_id) %>% unique %>% nrow))

TotalPat <- 2423
Prop_PatientsPerYear <- PatientsPerYear / TotalPat

#SSRIs
PatientsPerYear <- unlist(lapply(2012:2021, function(x) claims_prescrip_RL %>% filter(pat_id %in% unique(claims_prescrip_RL_SSRIs$pat_id)) %>% mutate(year = as.numeric(substr(month_id, 1, 4))) %>% filter(year == x) %>% select(pat_id) %>% unique %>% nrow))

TotalPat <- 10122
Prop_PatientsPerYear <- PatientsPerYear / TotalPat

#All
PatientsPerYear <- unlist(lapply(2012:2021, function(x) claims_prescrip_RL %>% mutate(year = as.numeric(substr(month_id, 1, 4))) %>% filter(year == x) %>% select(pat_id) %>% unique %>% nrow))

TotalPat <- 15965
Prop_PatientsPerYear <- PatientsPerYear / TotalPat
```


```r
allPatients <- c(unique(claims_prescrip_RL_SSRIs$pat_id), unique(both_claims$pat_id),unique(claims_prescrip_RL_FDA$pat_id))

allPatients[duplicated(allPatients)][31]
```

```
## [1] "9awfhxp22guiw0da"
```

```r
claims_prescrip_RL_SSRIs %>% 
  filter(pat_id == allPatients[duplicated(allPatients)][31])
```

```
## # A tibble: 5 x 4
##   year_claim pat_id           medication der_sex
##        <dbl> <chr>            <chr>      <chr>  
## 1       2015 9awfhxp22guiw0da FLUOXETINE M      
## 2       2016 9awfhxp22guiw0da FLUOXETINE M      
## 3       2017 9awfhxp22guiw0da FLUOXETINE M      
## 4       2018 9awfhxp22guiw0da FLUOXETINE M      
## 5       2019 9awfhxp22guiw0da FLUOXETINE M
```

```r
both_claims %>% 
  filter(pat_id == allPatients[duplicated(allPatients)][31])
```

```
## # A tibble: 40 x 63
##         V1 rectype proc_cde dayssup diagprc_ind diag1 diag2 diag3 diag4 diag5 diag6 diag7 diag8 diag9 diag10
##      <int> <chr>   <chr>      <int>       <int> <chr> <chr> <chr> <chr> <chr> <chr> <chr> <chr> <lgl> <lgl> 
##  1 4682787 P       ""            30          -1 ""    ""    ""    ""    ""    ""    ""    ""    NA    NA    
##  2 4682789 P       ""            30          -1 ""    ""    ""    ""    ""    ""    ""    ""    NA    NA    
##  3 4726447 P       ""            30          -1 ""    ""    ""    ""    ""    ""    ""    ""    NA    NA    
##  4 4729976 P       ""            30          -1 ""    ""    ""    ""    ""    ""    ""    ""    NA    NA    
##  5 4740743 P       ""            30          -1 ""    ""    ""    ""    ""    ""    ""    ""    NA    NA    
##  6 4741608 P       ""            30          -1 ""    ""    ""    ""    ""    ""    ""    ""    NA    NA    
##  7 4743165 P       ""            30          -1 ""    ""    ""    ""    ""    ""    ""    ""    NA    NA    
##  8 4747097 P       ""            30          -1 ""    ""    ""    ""    ""    ""    ""    ""    NA    NA    
##  9 4747219 P       ""            30          -1 ""    ""    ""    ""    ""    ""    ""    ""    NA    NA    
## 10 4747221 P       ""            30          -1 ""    ""    ""    ""    ""    ""    ""    ""    NA    NA    
## # i 30 more rows
## # i 48 more variables: diag11 <lgl>, diag12 <lgl>, icdprc1 <chr>, icdprc2 <lgl>, icdprc3 <lgl>,
## #   icdprc4 <lgl>, icdprc5 <lgl>, icdprc6 <lgl>, icdprc7 <lgl>, icdprc8 <lgl>, icdprc9 <lgl>,
## #   icdprc10 <lgl>, icdprc11 <lgl>, icdprc12 <lgl>, quan <dbl>, srv_unit <int>, from_dt_claim <IDate>,
## #   to_dt <IDate>, month_id <int>, pat_id <chr>, claimno <chr>, ndc <int64>, bill_id <chr>, prscbr_id <chr>,
## #   product_name <chr>, generic_name <chr>, gpi14 <chr>, gpi_desc <chr>, gpi2 <int>, gpi2_desc <chr>,
## #   thptc_clas_id <int>, thptc_clas_desc <chr>, dosage_form_nm <chr>, route <chr>, strength <chr>, ...
```

```r
claims_prescrip_RL_FDA %>% 
  filter(pat_id == allPatients[duplicated(allPatients)][31])
```

```
## # A tibble: 0 x 4
## # i 4 variables: year_claim <dbl>, pat_id <chr>, medication <chr>, der_sex <chr>
```

All patients.


```r
allPatients <- unique(c(unique(claims_prescrip_RL_FDA$pat_id), unique(claims_prescrip_RL_SSRIs$pat_id), unique(both_claims$pat_id)))

gender_patients <- claims_ASD_wNDC_csv_onlyPrescripClass %>% 
  filter(pat_id %in% allPatients) %>% 
  select(pat_id, der_sex) %>% 
  unique 

female_estimate <- sum(gender_patients$der_sex == "F")
male_estimate <- sum(gender_patients$der_sex == "M")

female_proportion <- female_estimate / (female_estimate+male_estimate) 
male_proportion <- male_estimate / (female_estimate+male_estimate)

#Diagnosis 
FirstDiagnosis_age <- claims_diagnosis %>% 
  filter(pat_id %in% allPatients) %>% 
  arrange(from_dt, pat_id) %>%  
  group_by(pat_id) %>% 
  slice(1) %>% 
  ungroup() %>% 
  mutate(year = as.numeric(substr(from_dt, 1, 4)), 
         age_1Diag = year - der_yob)



two25_estimate <- sum(FirstDiagnosis_age$age_1Diag >= 2 & 
                        FirstDiagnosis_age$age_1Diag <= 5)

six2elev_estimate <- sum(FirstDiagnosis_age$age_1Diag >= 6 & 
                        FirstDiagnosis_age$age_1Diag <= 11)

twelve2seventn_estimate <- sum(FirstDiagnosis_age$age_1Diag >= 12 & 
                        FirstDiagnosis_age$age_1Diag <= 17)

eighteen2twntsix_estimate <- sum(FirstDiagnosis_age$age_1Diag >= 18 & 
                        FirstDiagnosis_age$age_1Diag <= 26)

allAges <- two25_estimate+six2elev_estimate+twelve2seventn_estimate+eighteen2twntsix_estimate

two2five_prop <- two25_estimate/allAges
six2elev_prop <- six2elev_estimate/allAges
twelve2seventn_prop <- twelve2seventn_estimate/allAges
eighteen2twntsix_prop <- eighteen2twntsix_estimate/allAges
```

## To generate table automatically 


```r
claims_prescrip_table <- claims_prescrip_RL %>% 
  mutate(year_claim = as.numeric(substr(month_id, 1,4))) %>% 
  select(pat_id, medication, der_sex) %>% 
  unique %>% 
  group_by(pat_id) %>% 
  mutate(name_med = ifelse(all(medication %in% c("ARIPIPRAZOLE", "RISPERIDONE")),"FDA-approved only",ifelse(all(medication %in% SSRIs_meds), "SSRIs only", ifelse(any(medication %in% SSRIs_meds) &
                                    any(medication %in%
                                          c("ARIPIPRAZOLE",
                                            "RISPERIDONE")),
                                  "Both", "NA")))) %>% 
  ungroup() %>% 
  select(-medication) %>% 
  unique 


allPatients <- unique(claims_prescrip_table$pat_id)

#Diagnosis 
SecondDiagnosis_age <- claims_diagnosis %>% 
  filter(pat_id %in% allPatients) %>% 
  arrange(from_dt, pat_id) %>%  
  group_by(pat_id) %>% 
  slice(1) %>% 
  ungroup() %>% 
  mutate(year = as.numeric(substr(from_dt, 1, 4)), 
         age_1Diag = year - der_yob) %>% 
  select(pat_id, age_1Diag)

claims_prescrip_table <- claims_prescrip_table %>% 
  left_join(SecondDiagnosis_age) %>% 
  mutate(FirstDiagn_Age = case_when(
    age_1Diag >= 2 & age_1Diag <= 5 ~ "2 to 5", 
    age_1Diag >= 6 & age_1Diag <= 11 ~ "6 to 11", 
    age_1Diag >= 12 & age_1Diag <= 17 ~ "12 to 17",
    age_1Diag >= 18 & age_1Diag <= 26  ~ "18 to 26", 
    TRUE ~ "Other"
  ))
```

```
## Joining with `by = join_by(pat_id)`
```

```r
library(tableone)

vars <- c("der_sex", "FirstDiagn_Age")
table <- CreateTableOne(vars = vars, strata = "name_med", data = claims_prescrip_table, factorVars = c("der_sex", "FirstDiagn_Age"))


print(table,exact  = "stage", quote = TRUE, noSpaces = TRUE, printToggle = FALSE)

print(table, showAllLevels = TRUE, quote = FALSE, noSpaces = TRUE)
```

```
##                     Stratified by name_med
##                      level    Both        FDA-approved only SSRIs only  p      test
##   n                           3927        2662              9387                   
##   der_sex (%)        F        940 (23.9)  506 (19.0)        2725 (29.0) <0.001     
##                      M        2987 (76.1) 2156 (81.0)       6662 (71.0)            
##   FirstDiagn_Age (%) 12 to 17 1476 (37.6) 847 (31.8)        3705 (39.5) <0.001     
##                      18 to 26 790 (20.1)  627 (23.6)        2362 (25.2)            
##                      2 to 5   306 (7.8)   280 (10.5)        550 (5.9)              
##                      6 to 11  1355 (34.5) 908 (34.1)        2770 (29.5)
```

For the calendar year: 


```r
claims_prescrip_table_year <- claims_prescrip_RL %>% 
  mutate(year_claim = as.numeric(substr(month_id, 1,4))) %>% 
  select(pat_id, medication, der_sex, year_claim) %>% 
  unique %>% 
  group_by(pat_id, year_claim) %>% 
  mutate(name_med = ifelse(all(medication %in% c("ARIPIPRAZOLE", "RISPERIDONE")),"FDA-approved only",ifelse(all(medication %in% SSRIs_meds), "SSRIs only", ifelse(any(medication %in% SSRIs_meds) &
                                    any(medication %in%
                                          c("ARIPIPRAZOLE",
                                            "RISPERIDONE")),
                                  "Both", "NA")))) %>% 
  ungroup() %>%
  select(-medication) %>%
  unique 

vars <- c("year_claim") 
table_2 <- CreateTableOne(vars = vars, strata = "name_med", data = claims_prescrip_table_year, factorVars = c("year_claim"))


print(table_2, showAllLevels = TRUE, quote = FALSE, noSpaces = TRUE)
```

```
##                 Stratified by name_med
##                  level Both        FDA-approved only SSRIs only  p      test
##   n                    7123        9468              28434                  
##   year_claim (%) 2012  276 (3.9)   507 (5.4)         924 (3.2)   <0.001     
##                  2013  369 (5.2)   610 (6.4)         1313 (4.6)             
##                  2014  421 (5.9)   599 (6.3)         1577 (5.5)             
##                  2015  475 (6.7)   699 (7.4)         1797 (6.3)             
##                  2016  511 (7.2)   795 (8.4)         2313 (8.1)             
##                  2017  668 (9.4)   953 (10.1)        2998 (10.5)            
##                  2018  1019 (14.3) 1286 (13.6)       3638 (12.8)            
##                  2019  1250 (17.5) 1541 (16.3)       4678 (16.5)            
##                  2020  1059 (14.9) 1261 (13.3)       4518 (15.9)            
##                  2021  1075 (15.1) 1217 (12.9)       4678 (16.5)
```

```r
print(table_2,exact  = "stage", quote = TRUE, noSpaces = TRUE, printToggle = FALSE)
```

For all: 

```r
table_3 <- CreateTableOne(vars = vars, data = claims_prescrip_table, factorVars = c("der_sex", "FirstDiagn_Age"))
```

```
## Warning in ModuleReturnVarsExist(vars, data): The data frame does not have: year_claim Dropped
```

```
## Error in ModuleStopIfNoVarsLeft(vars): No valid variables.
```

```r
print(table_3, showAllLevels = TRUE, quote = TRUE, noSpaces = TRUE)
```

```
##                       ""
##  ""                    "level"    "Overall"     
##   "n"                  ""         "15976"       
##   "der_sex (%)"        "F"        "4171 (26.1)" 
##   ""                   "M"        "11805 (73.9)"
##   "FirstDiagn_Age (%)" "12 to 17" "6028 (37.7)" 
##   ""                   "18 to 26" "3779 (23.7)" 
##   ""                   "2 to 5"   "1136 (7.1)"  
##   ""                   "6 to 11"  "5033 (31.5)"
```

```r
table_4 <- CreateTableOne(vars = vars, data = claims_prescrip_table_year, factorVars = c("year_claim"))
print(table_4, showAllLevels = TRUE, quote = TRUE, noSpaces = TRUE)
```

```
##                   ""
##  ""                "level" "Overall"    
##   "n"              ""      "45025"      
##   "year_claim (%)" "2012"  "1707 (3.8)" 
##   ""               "2013"  "2292 (5.1)" 
##   ""               "2014"  "2597 (5.8)" 
##   ""               "2015"  "2971 (6.6)" 
##   ""               "2016"  "3619 (8.0)" 
##   ""               "2017"  "4619 (10.3)"
##   ""               "2018"  "5943 (13.2)"
##   ""               "2019"  "7469 (16.6)"
##   ""               "2020"  "6838 (15.2)"
##   ""               "2021"  "6970 (15.5)"
```

